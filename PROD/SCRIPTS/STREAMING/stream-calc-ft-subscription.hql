SELECT TO_DATE(TRANSACTION_DATE) TRANSACTION_DATE, CONCAT_WS(';', TRANSACTION_DATE, TRANSACTION_TIME, SERVED_PARTY_MSISDN, CONTRACT_TYPE, COMMERCIAL_OFFER, OPERATOR_CODE, SUBSCRIPTION_CHANNEL, SERVICE_LIST, SUBSCRIPTION_SERVICE,  SUBSCRIPTION_SERVICE_DETAILS, SUBSCRIPTION_RELATED_SERVICE, RATED_AMOUNT, ACTIVE_DATE, ACTIVE_TIME, EXPIRE_DATE, EXPIRE_TIME, SUBSCRIPTION_STATUS, PREVIOUS_COMMERCIAL_OFFER, PREVIOUS_STATUS, PREVIOUS_SUBS_SERVICE_DETAILS, PREVIOUS_SUBS_RELATED_SERVICE, BENEFIT_BALANCE_LIST, BENEFIT_UNIT_LIST, BENEFIT_ADDED_VALUE_LIST, BENEFIT_RESULT_VALUE_LIST, BENEFIT_ACTIVE_DATE_LIST, BENEFIT_EXPIRE_DATE_LIST, TOTAL_OCCURENCE, SERVICE_CODE, VOIX_ONNET, VOIX_OFFNET, VOIX_INTER, VOIX_ROAMING, SMS_ONNET, SMS_OFFNET, SMS_INTER, SMS_ROAMING, DATA_BUNDLE, SVA, ORIGINAL_FILE_NAME) VALUE
FROM
(
SELECT
NVL(TRANSACTION_TIME,"") TRANSACTION_TIME,
NVL(TRANSACTION_DATE,"NULL") TRANSACTION_DATE,
NVL(SERVED_PARTY_MSISDN,"") SERVED_PARTY_MSISDN,
NVL(CONTRACT_TYPE,"") CONTRACT_TYPE,
NVL(COMMERCIAL_OFFER,"") COMMERCIAL_OFFER,
NVL(OPERATOR_CODE,"") OPERATOR_CODE,
NVL(SUBSCRIPTION_CHANNEL,"") SUBSCRIPTION_CHANNEL,
NVL(SERVICE_LIST,"") SERVICE_LIST,
NVL(SUBSCRIPTION_SERVICE,"") SUBSCRIPTION_SERVICE,
NVL(SUBSCRIPTION_SERVICE_DETAILS,"") SUBSCRIPTION_SERVICE_DETAILS,
NVL(SUBSCRIPTION_RELATED_SERVICE,"") SUBSCRIPTION_RELATED_SERVICE,
NVL(RATED_AMOUNT,0.0) RATED_AMOUNT,
NVL(ACTIVE_DATE,"NULL") ACTIVE_DATE,
NVL(ACTIVE_TIME,"") ACTIVE_TIME,
NVL(EXPIRE_DATE,"NULL") EXPIRE_DATE,
NVL(EXPIRE_TIME,"") EXPIRE_TIME,
NVL(SUBSCRIPTION_STATUS,"") SUBSCRIPTION_STATUS,
NVL(PREVIOUS_COMMERCIAL_OFFER,"") PREVIOUS_COMMERCIAL_OFFER,
NVL(PREVIOUS_STATUS,"") PREVIOUS_STATUS,
NVL(PREVIOUS_SUBS_SERVICE_DETAILS,"") PREVIOUS_SUBS_SERVICE_DETAILS,
NVL(PREVIOUS_SUBS_RELATED_SERVICE,"") PREVIOUS_SUBS_RELATED_SERVICE,
NVL(BENEFIT_BALANCE_LIST,"") BENEFIT_BALANCE_LIST,
NVL(BENEFIT_UNIT_LIST,"") BENEFIT_UNIT_LIST,
NVL(BENEFIT_ADDED_VALUE_LIST,"") BENEFIT_ADDED_VALUE_LIST,
NVL(BENEFIT_RESULT_VALUE_LIST,"") BENEFIT_RESULT_VALUE_LIST,
NVL(BENEFIT_ACTIVE_DATE_LIST,"") BENEFIT_ACTIVE_DATE_LIST,
NVL(BENEFIT_EXPIRE_DATE_LIST,"") BENEFIT_EXPIRE_DATE_LIST,
NVL(TOTAL_OCCURENCE,-1) TOTAL_OCCURENCE,
NVL(SERVICE_CODE,"") SERVICE_CODE,
NVL(VOIX_ONNET,0.0) VOIX_ONNET,
NVL(VOIX_OFFNET,0.0) VOIX_OFFNET,
NVL(VOIX_INTER,0.0) VOIX_INTER,
NVL(VOIX_ROAMING,0.0) VOIX_ROAMING,
NVL(SMS_ONNET,0.0) SMS_ONNET,
NVL(SMS_OFFNET,0.0) SMS_OFFNET,
NVL(SMS_INTER,0.0) SMS_INTER,
NVL(SMS_ROAMING,0.0) SMS_ROAMING,
NVL(DATA_BUNDLE,0.0) DATA_BUNDLE,
NVL(SVA,0.0) SVA,
NVL(ORIGINAL_FILE_NAME,"") ORIGINAL_FILE_NAME
FROM(
SELECT
DATE_FORMAT(IF(CREATEDDATE="NULL",NULL,CREATEDDATE), 'HHmmss') TRANSACTION_TIME
, SUBSTRING(IF(ACC_NBR="", NULL, ACC_NBR), -9) SERVED_PARTY_MSISDN
, (CASE IF(PREPAY_FLAG=-1, NULL,PREPAY_FLAG)
WHEN 1 THEN 'PREPAID'
WHEN 2 THEN 'POSTPAID'
WHEN 3 THEN 'HYBRID'
ELSE CAST(IF(PREPAY_FLAG=-1, NULL,PREPAY_FLAG) AS STRING)
END ) CONTRACT_TYPE
, NVL(PROD_SPEC.PROD_SPEC_NAME,  CAST(IF(ITSUBSC.PROD_SPEC_CODE="",NULL,ITSUBSC.PROD_SPEC_CODE) AS STRING)) COMMERCIAL_OFFER
, (CASE IF(PROVIDER_ID=-1, NULL, PROVIDER_ID)
WHEN 0 THEN 'OCM'
WHEN 1 THEN 'SET'
ELSE CAST(IF(PROVIDER_ID=-1, NULL, PROVIDER_ID) AS STRING)
END) OPERATOR_CODE
, NVL(CHANSUBSC.CHANNEL_NAME, CAST(IF(ITSUBSC.CHANNEL_ID=-1, NULL, ITSUBSC.CHANNEL_ID) AS STRING))  SUBSCRIPTION_CHANNEL
, IF(SERVICE_LIST="",NULL,SERVICE_LIST) SERVICE_LIST
, SERVSUBSC.SUBSCRIPTION_SERVICE_NAME  SUBSCRIPTION_SERVICE
, NVL(PRICE_PLAN.PRICE_PLAN_NAME,CAST(IF(ITSUBSC.PRICE_PLAN_CODE="",NULL,ITSUBSC.PRICE_PLAN_CODE) AS STRING))  SUBSCRIPTION_SERVICE_DETAILS
, NVL(REL_PROD.PROD_SPEC_NAME, IF(ITSUBSC.RELATED_PROD_CODE="",NULL,ITSUBSC.RELATED_PROD_CODE))  SUBSCRIPTION_RELATED_SERVICE
, MAX(EVENT_COST / 100)    RATED_AMOUNT
, MAX (TO_DATE(IF(ACTIVE_DATE="NULL",NULL,ACTIVE_DATE)))   ACTIVE_DATE
, MAX (DATE_FORMAT(IF(ACTIVE_DATE="NULL",NULL,ACTIVE_DATE), 'HHmmss')) ACTIVE_TIME
, MAX (TO_DATE(IF(EXPIRED_DATE="NULL",NULL,EXPIRED_DATE))) EXPIRE_DATE
, MAX (DATE_FORMAT(IF(EXPIRED_DATE="NULL",NULL,EXPIRED_DATE), 'HHmmss')) EXPIRE_TIME
, MAX (IF(NEW_SUBS_STATE="",NULL,NEW_SUBS_STATE))  SUBSCRIPTION_STATUS
, MIN (NVL (OLD_PROD_SPEC.PROD_SPEC_NAME,  CAST(IF(ITSUBSC.OLD_PROD_SPEC_CODE="",NULL,ITSUBSC.OLD_PROD_SPEC_CODE)  AS STRING)))  PREVIOUS_COMMERCIAL_OFFER
, MAX (IF(OLD_SUBS_STATE="",NULL,OLD_SUBS_STATE))  PREVIOUS_STATUS
, MAX (NVL(OLD_PRICE_PLAN.PRICE_PLAN_NAME,  CAST(ITSUBSC.OLD_PRICE_PLAN_CODE AS STRING)))   PREVIOUS_SUBS_SERVICE_DETAILS
, MAX (IF(ITSUBSC.OLD_RELATED_PROD_CODE="",NULL,ITSUBSC.OLD_RELATED_PROD_CODE))  PREVIOUS_SUBS_RELATED_SERVICE
, MAX (IF(BENEFIT_BALANCE_LIST = '', NULL,BENEFIT_BALANCE_LIST)) BENEFIT_BALANCE_LIST
, MAX (IF(BENEFIT_UNIT_LIST = '', NULL,BENEFIT_UNIT_LIST)) BENEFIT_UNIT_LIST
, MAX (IF(BENEFIT_ADDED_VALUE_LIST = '', NULL,BENEFIT_ADDED_VALUE_LIST)) BENEFIT_ADDED_VALUE_LIST
, MAX (IF(BENEFIT_RESULT_VALUE_LIST = '', NULL,BENEFIT_RESULT_VALUE_LIST)) BENEFIT_RESULT_VALUE_LIST
, MAX (IF(BENEFIT_ACTIVE_DATE_LIST = '', NULL,BENEFIT_ACTIVE_DATE_LIST)) BENEFIT_ACTIVE_DATE_LIST
, MAX (IF(BENEFIT_EXPIRE_DATE_LIST = '', NULL,BENEFIT_EXPIRE_DATE_LIST)) BENEFIT_EXPIRE_DATE_LIST
, SUM(1) TOTAL_OCCURENCE
, MIN (NVL(DTSVS.SERVICE_CODE, 'NVX_OTHERS')) SERVICE_CODE
, MAX(EVENT_COST / 100 * NVL(VOIX_ONNET, 0))  VOIX_ONNET
, MAX(EVENT_COST / 100 * NVL(VOIX_OFFNET, 0)) VOIX_OFFNET
, MAX(EVENT_COST / 100 * NVL(VOIX_INTER, 0))  VOIX_INTER
, MAX(EVENT_COST / 100 * NVL(VOIX_ROAMING, 0))  VOIX_ROAMING
, MAX(EVENT_COST / 100 * NVL(SMS_ONNET, 0)) SMS_ONNET
, MAX(EVENT_COST / 100 * NVL(SMS_OFFNET, 0)) SMS_OFFNET
, MAX(EVENT_COST / 100 * NVL(SMS_INTER, 0))   SMS_INTER
, MAX(EVENT_COST / 100 * NVL(SMS_ROAMING, 0)) SMS_ROAMING
, MAX(EVENT_COST / 100 * NVL(DATA_BUNDLE, 0)) DATA_BUNDLE
, MAX(EVENT_COST / 100 * NVL(SVA, 0))  SVA
, IF(CREATEDDATE="NULL",NULL,CREATEDDATE) TRANSACTION_DATE
, IF(ORIGINAL_FILE_NAME="",NULL,ORIGINAL_FILE_NAME) ORIGINAL_FILE_NAME
FROM IN_FT_01_SUBSCRIPTION ITSUBSC
LEFT JOIN DIM.DT_SUBSCRIPTION_SERVICE SERVSUBSC ON NVL(ITSUBSC.SUBS_EVENT_ID, 1000000) = SERVSUBSC.SUBSCRIPTION_SERVICE_ID
LEFT JOIN DIM.DT_SUBSCRIPTION_CHANNEL CHANSUBSC ON NVL(IF(ITSUBSC.CHANNEL_ID=-1, NULL, ITSUBSC.CHANNEL_ID), 1000000) = CHANSUBSC.CHANNEL_ID
LEFT JOIN (SELECT NVL(PRICE_PLAN_CODE, 'UNKNOWN')PRICE_PLAN_CODE , MIN( PRICE_PLAN_NAME) PRICE_PLAN_NAME FROM CDR.STREAM_IT_ZTE_PRICE_PLAN_EXTRACT GROUP BY NVL(PRICE_PLAN_CODE, 'UNKNOWN')) PRICE_PLAN ON NVL(IF(ITSUBSC.PRICE_PLAN_CODE="",NULL,ITSUBSC.PRICE_PLAN_CODE), '1000000') = PRICE_PLAN.PRICE_PLAN_CODE
LEFT JOIN (SELECT NVL(PRICE_PLAN_CODE, 'UNKNOWN')PRICE_PLAN_CODE, MIN(PRICE_PLAN_NAME) PRICE_PLAN_NAME FROM CDR.STREAM_IT_ZTE_PRICE_PLAN_EXTRACT GROUP BY NVL(PRICE_PLAN_CODE, 'UNKNOWN')) OLD_PRICE_PLAN ON NVL(ITSUBSC.OLD_PRICE_PLAN_CODE, '1000000') = OLD_PRICE_PLAN.PRICE_PLAN_CODE
LEFT JOIN (SELECT STD_CODE, MIN(PROD_SPEC_NAME) PROD_SPEC_NAME FROM CDR.STREAM_IT_ZTE_PROD_SPEC_EXTRACT GROUP BY STD_CODE) PROD_SPEC ON NVL(IF(ITSUBSC.PROD_SPEC_CODE="", NULL,ITSUBSC.PROD_SPEC_CODE), '1000000') =  PROD_SPEC.STD_CODE
LEFT JOIN (SELECT STD_CODE, MIN(PROD_SPEC_NAME) PROD_SPEC_NAME FROM CDR.STREAM_IT_ZTE_PROD_SPEC_EXTRACT GROUP BY STD_CODE) REL_PROD ON NVL(IF(ITSUBSC.RELATED_PROD_CODE="",NULL,ITSUBSC.RELATED_PROD_CODE), '1000000') = REL_PROD.STD_CODE
LEFT JOIN (SELECT STD_CODE, MIN(PROD_SPEC_NAME) PROD_SPEC_NAME FROM CDR.STREAM_IT_ZTE_PROD_SPEC_EXTRACT GROUP BY STD_CODE) OLD_PROD_SPEC ON NVL(IF(ITSUBSC.OLD_PROD_SPEC_CODE="",NULL,ITSUBSC.OLD_PROD_SPEC_CODE), '1000000') =  OLD_PROD_SPEC.STD_CODE
LEFT JOIN (SELECT EVENT, MAX(SERVICE_CODE) SERVICE_CODE, MIN(VOIX_ONNET) VOIX_ONNET, MIN(VOIX_OFFNET) VOIX_OFFNET, MIN(VOIX_INTER)VOIX_INTER, MIN(VOIX_ROAMING)VOIX_ROAMING, MIN(SMS_ONNET) SMS_ONNET, MIN(SMS_OFFNET) SMS_OFFNET, MIN(SMS_INTER) SMS_INTER, MIN(SMS_ROAMING)SMS_ROAMING, MIN(DATA_BUNDLE) DATA_BUNDLE, MIN(SVA) SVA FROM DIM.DT_SERVICES DTSVS GROUP BY EVENT) DTSVS ON NVL(PRICE_PLAN.PRICE_PLAN_NAME, SERVSUBSC.SUBSCRIPTION_SERVICE_NAME) = DTSVS.EVENT
GROUP BY IF(CREATEDDATE="NULL",NULL,CREATEDDATE)
, SUBSTRING(IF(ACC_NBR="",NULL,ACC_NBR), -9)
, (CASE IF(PREPAY_FLAG=-1, NULL,PREPAY_FLAG) WHEN 1 THEN 'PREPAID' WHEN 2 THEN 'POSTPAID' WHEN 3 THEN 'HYBRID' ELSE CAST(IF(PREPAY_FLAG=-1, NULL,PREPAY_FLAG) AS STRING) END )
, NVL(PROD_SPEC.PROD_SPEC_NAME,  CAST(IF(ITSUBSC.PROD_SPEC_CODE="", NULL,ITSUBSC.PROD_SPEC_CODE) AS STRING))
, (CASE IF(PROVIDER_ID=-1, NULL,PROVIDER_ID) WHEN 0 THEN 'OCM' WHEN 1 THEN 'SET' ELSE CAST(IF(PROVIDER_ID=-1, NULL,PROVIDER_ID) AS STRING) END)
, NVL(CHANSUBSC.CHANNEL_NAME, CAST(IF(ITSUBSC.CHANNEL_ID=-1, NULL, ITSUBSC.CHANNEL_ID) AS STRING))
, IF(ITSUBSC.SERVICE_LIST="",NULL,ITSUBSC.SERVICE_LIST)
, SERVSUBSC.SUBSCRIPTION_SERVICE_NAME
, NVL(PRICE_PLAN.PRICE_PLAN_NAME,CAST(IF(ITSUBSC.PRICE_PLAN_CODE="",NULL,ITSUBSC.PRICE_PLAN_CODE) AS STRING))
, NVL(REL_PROD.PROD_SPEC_NAME, IF(ITSUBSC.RELATED_PROD_CODE="",NULL,ITSUBSC.RELATED_PROD_CODE))
, CURRENT_TIMESTAMP()
, ITSUBSC.BENEFIT_BAL_LIST
, IF(ORIGINAL_FILE_NAME="",NULL,ORIGINAL_FILE_NAME)
)t_results
)f_results

