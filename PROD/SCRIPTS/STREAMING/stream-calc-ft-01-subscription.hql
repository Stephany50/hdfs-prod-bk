SELECT
	TO_DATE(CREATEDDATE) TRANSACTION_DATE
	, CONCAT_WS('\\|', ACC_NBR, CHANNEL_ID, SUBS_EVENT_ID, CREATEDDATE, OLD_SUBS_STATE, NEW_SUBS_STATE, EVENT_COST, BENEFIT_NAME, OLD_PROD_SPEC_CODE, PROD_SPEC_CODE, OLD_PRICE_PLAN_CODE, PRICE_PLAN_CODE, OLD_RELATED_PROD_CODE, RELATED_PROD_CODE, ACTIVE_DATE, EXPIRED_DATE, PROVIDER_ID, PREPAY_FLAG, BENEFIT_BAL_LIST, BENEFIT_ADDED_VALUE_LIST, BENEFIT_RESULT_VALUE_LIST, BENEFIT_ACTIVE_DATE_LIST, BENEFIT_EXPIRE_DATE_LIST, BENEFIT_BALANCE_LIST, BENEFIT_UNIT_LIST, SERVICE_LIST) VALUE
FROM
(
	SELECT
	  ACC_NBR,
	  CHANNEL_ID,
	  SUBS_EVENT_ID,
	  CREATEDDATE,
	  OLD_SUBS_STATE,
	  NEW_SUBS_STATE,
	  EVENT_COST,
	  BENEFIT_NAME,
	  OLD_PROD_SPEC_CODE,
	  PROD_SPEC_CODE,
	  OLD_PRICE_PLAN_CODE,
	  PRICE_PLAN_CODE,
	  OLD_RELATED_PROD_CODE,
	  RELATED_PROD_CODE,
	  ACTIVE_DATE,
	  EXPIRED_DATE,
	  PROVIDER_ID,
	  PREPAY_FLAG,
	  BENEFIT_BAL_LIST,
	  CONCAT_WS('|', COLLECT_LIST((CASE ACCT_RES_RATING_UNIT WHEN 'QM' THEN BEN_ACCT_ADD_VAL/100 ELSE BEN_ACCT_ADD_VAL END))) BENEFIT_ADDED_VALUE_LIST,
	  CONCAT_WS('|', COLLECT_LIST((CASE ACCT_RES_RATING_UNIT WHEN 'QM' THEN BEN_ACCT_ADD_RESULT/100 ELSE BEN_ACCT_ADD_RESULT END))) BENEFIT_RESULT_VALUE_LIST,
	  CONCAT_WS('|', COLLECT_LIST(BEN_ACCT_ADD_ACT_DATE)) BENEFIT_ACTIVE_DATE_LIST,
	  CONCAT_WS('|', COLLECT_LIST(BEN_ACCT_ADD_EXP_DATE)) BENEFIT_EXPIRE_DATE_LIST,
	  CONCAT_WS('|', COLLECT_LIST(NVL(ACCT_RES_NAME, BEN_ACCT_ID))) BENEFIT_BALANCE_LIST,
	  CONCAT_WS('|', COLLECT_LIST(NVL(ACCT_RES_RATING_UNIT, BEN_ACCT_ID))) BENEFIT_UNIT_LIST,
	  CONCAT_WS('|', COLLECT_SET(NVL(ACCT_RES_RATING_SERVICE_CODE, BEN_ACCT_ID))) SERVICE_LIST
  FROM
  (
	SELECT
	  ACC_NBR,
	  CHANNEL_ID,
	  SUBS_EVENT_ID,
	  CREATEDDATE,
	  OLD_SUBS_STATE,
	  NEW_SUBS_STATE,
	  EVENT_COST,
	  BENEFIT_NAME,
	  OLD_PROD_SPEC_CODE,
	  PROD_SPEC_CODE,
	  OLD_PRICE_PLAN_CODE,
	  PRICE_PLAN_CODE,
	  OLD_RELATED_PROD_CODE,
	  RELATED_PROD_CODE,
	  ACTIVE_DATE,
	  EXPIRED_DATE,
	  PROVIDER_ID,
	  PREPAY_FLAG,
	  BENEFIT_BAL_LIST,
	  SPLIT(BEN_BAL, '&')[0] BEN_ACCT_ID,
	  CAST(ABS(CAST(SPLIT(BEN_BAL, '&')[1] AS INT)) AS STRING) BEN_ACCT_ADD_VAL,
	  CAST(ABS(CAST(SPLIT(BEN_BAL, '&')[2] AS INT)) AS STRING) BEN_ACCT_ADD_RESULT,
	  SPLIT(BEN_BAL, '&')[3] BEN_ACCT_ADD_ACT_DATE,
	  SPLIT(BEN_BAL, '&')[4] BEN_ACCT_ADD_EXP_DATE
	FROM IN_ZTE_SUBSCRIPTION_STREAM
	LATERAL VIEW EXPLODE(SPLIT(NVL(BENEFIT_BAL_LIST, ''), '#')) TMP AS BEN_BAL
  ) ITSUBSC
  LEFT JOIN (SELECT ACCT_RES_STD_CODE, MAX(ACCT_RES_NAME) ACCT_RES_NAME, MAX(ACCT_RES_RATING_SERVICE_CODE) ACCT_RES_RATING_SERVICE_CODE, MAX(ACCT_RES_RATING_UNIT) ACCT_RES_RATING_UNIT FROM DIM.DT_BALANCE_TYPE_ITEM GROUP BY ACCT_RES_STD_CODE) BALANCE_TYPE_ITEM ON ITSUBSC.BEN_ACCT_ID = BALANCE_TYPE_ITEM.ACCT_RES_STD_CODE
  GROUP BY
	  ACC_NBR,
	  CHANNEL_ID,
	  SUBS_EVENT_ID,
	  CREATEDDATE,
	  OLD_SUBS_STATE,
	  NEW_SUBS_STATE,
	  EVENT_COST,
	  BENEFIT_NAME,
	  OLD_PROD_SPEC_CODE,
	  PROD_SPEC_CODE,
	  OLD_PRICE_PLAN_CODE,
	  PRICE_PLAN_CODE,
	  OLD_RELATED_PROD_CODE,
	  RELATED_PROD_CODE,
	  ACTIVE_DATE,
	  EXPIRED_DATE,
	  PROVIDER_ID,
	  PREPAY_FLAG,
	  BENEFIT_BAL_LIST
)