CREATE TABLE CTI.IT_STAT_AGENT_CTI(
INTERACTION_ID VARCHAR(15),
START_TIME DATE,
END_TIME_TS DATE,
INTERACTION_TYPE VARCHAR(25),
MSIDSN VARCHAR(15),
DATE_TIME_AGG DATE,
ThirtyMinAgg DATE,
RESOURCES VARCHAR(10),
RESOURCE_TYPE VARCHAR(15),
RESOURCE_SUBTYPE VARCHAR(15), 
AGENT_FIRST_NAME VARCHAR(255), 
AGENT_LAST_NAME VARCHAR(255),
MEDIA VARCHAR(15), 
TECHNICAL_RESULT VARCHAR(15),
RESULT_REASON VARCHAR(15),
RESOURCE_ROLE VARCHAR(15),
ROLE_REASON VARCHAR(15),  
PLACE INT,
UD_langue INT,
UD_vipgsm INT,
UD_vipomy INT,
UD_isomy INT,
UD_ListSegment VARCHAR(20),
UD_segment VARCHAR(30),
UD_site_cible VARCHAR(15), 
UD_site_choisi VARCHAR(15),
UD_comp  VARCHAR(20),
UD_comp_deb  VARCHAR(15),
UD_comp_choisi  VARCHAR(20),
UD_TYPE_CC  VARCHAR(20),
UD_crise_site INT,
UD_crise_ferm INT,
UD_crise_flux INT,
UD_crise_dissu INT,
UD_distributed VARCHAR(10),
UD_nRONA INT,
UD_HNO INT,
UD_Xfer_Presta VARCHAR(15),
UD_Fermeture VARCHAR(15),
UD_Dissuasion VARCHAR(15),
UD_DNIS INT,
UD_DureeAttente INT,
UD_PrioriteFlux INT,
UD_ANI VARCHAR(15),
TARGET INT,
SHORT_ABD_FLAG INT,
TPS_RP INT,
TPS_ACW INT,
TPS_SONNERIE INT,
TPS_CONVERSATION_AGENT INT,
TPS_CONVERSATION_CLIENT INT,
HOLD_DURATION INT,
ORIGINAL_FILE_NAME VARCHAR(50),
ORIGINAL_FILE_SIZE INT,
ORIGINAL_FILE_LINE_COUNT INT,
INSERT_DATE TIMESTAMP
)PARTITIONED BY (FILE_DATE DATE)
STORED AS PARQUET TBLPROPERTIES ('PARQUET.COMPRESS'='SNAPPY')
;


CREATE EXTERNAL TABLE CTI.TT_STAT_AGENT_CTI(
ORIGINAL_FILE_NAME VARCHAR(50),
ORIGINAL_FILE_SIZE INT,
ORIGINAL_FILE_LINE_COUNT INT,
INTERACTION_ID VARCHAR(15),
START_TIME VARCHAR(20),
END_TIME_TS VARCHAR(20),
INTERACTION_TYPE VARCHAR(25),
MSIDSN VARCHAR(15),
DATE_TIME_AGG VARCHAR(20),
ThirtyMinAgg VARCHAR(20),
RESOURCES VARCHAR(10),
RESOURCE_TYPE VARCHAR(15),
RESOURCE_SUBTYPE VARCHAR(15),
AGENT_FIRST_NAME VARCHAR(255),
AGENT_LAST_NAME VARCHAR(255),
MEDIA VARCHAR(15),	
TECHNICAL_RESULT VARCHAR(15),
RESULT_REASON VARCHAR(15),
RESOURCE_ROLE VARCHAR(15),
ROLE_REASON VARCHAR(15),	
PLACE INT,
UD_langue INT,
UD_vipgsm INT,
UD_vipomy INT,
UD_isomy INT,
UD_ListSegment VARCHAR(20),
UD_segment VARCHAR(30),
UD_site_cible VARCHAR(15),
UD_site_choisi	VARCHAR(15),
UD_comp	 VARCHAR(20),
UD_comp_deb	 VARCHAR(15),
UD_comp_choisi VARCHAR(20),
UD_TYPE_CC	 VARCHAR(20),
UD_crise_site INT,
UD_crise_ferm INT,
UD_crise_flux INT,
UD_crise_dissu INT,
UD_distributed	VARCHAR(10),
UD_nRONA INT,
UD_HNO INT,
UD_Xfer_Presta VARCHAR(15),
UD_Fermeture VARCHAR(15),
UD_Dissuasion VARCHAR(15),
UD_DNIS INT,
UD_DureeAttente INT,
UD_PrioriteFlux INT,
UD_ANI VARCHAR(15),
TARGET INT,
SHORT_ABD_FLAG INT,
TPS_RP INT,
TPS_ACW INT,
TPS_SONNERIE INT,
TPS_CONVERSATION_AGENT INT,
TPS_CONVERSATION_CLIENT INT,
HOLD_DURATION INT
)COMMENT 'CTI TT_STAT_AGENT_CTI external table'
ROW FORMAT DELIMITED FIELDS TERMINATED BY ';'
LOCATION '/PROD/TT/CTI/STAT_AGENT_CTI'
TBLPROPERTIES ('serialization.null.format'='');






---TMP STAGGING DATA LAKE
CREATE TABLE TMP.SQ_IT_STAT_AGENT_CTI(
INTERACTION_ID VARCHAR(15),
START_TIME DATE,
END_TIME_TS DATE,
INTERACTION_TYPE VARCHAR(25),
MSIDSN VARCHAR(15),
DATE_TIME_AGG DATE,
ThirtyMinAgg DATE,
RESOURCES VARCHAR(10),
RESOURCE_TYPE VARCHAR(15),
RESOURCE_SUBTYPE VARCHAR(15), 
AGENT_FIRST_NAME VARCHAR(255), 
AGENT_LAST_NAME VARCHAR(255),
MEDIA VARCHAR(15), 
TECHNICAL_RESULT VARCHAR(15),
RESULT_REASON VARCHAR(15),
RESOURCE_ROLE VARCHAR(15),
ROLE_REASON VARCHAR(15),  
PLACE INT,
UD_langue INT,
UD_vipgsm INT,
UD_vipomy INT,
UD_isomy INT,
UD_ListSegment VARCHAR(20),
UD_segment VARCHAR(30),
UD_site_cible VARCHAR(15), 
UD_site_choisi VARCHAR(15),
UD_comp  VARCHAR(20),
UD_comp_deb  VARCHAR(15),
UD_comp_choisi  VARCHAR(20),
UD_TYPE_CC  VARCHAR(20),
UD_crise_site INT,
UD_crise_ferm INT,
UD_crise_flux INT,
UD_crise_dissu INT,
UD_distributed VARCHAR(10),
UD_nRONA INT,
UD_HNO INT,
UD_Xfer_Presta VARCHAR(15),
UD_Fermeture VARCHAR(15),
UD_Dissuasion VARCHAR(15),
UD_DNIS INT,
UD_DureeAttente INT,
UD_PrioriteFlux INT,
UD_ANI VARCHAR(15),
TARGET INT,
SHORT_ABD_FLAG INT,
TPS_RP INT,
TPS_ACW INT,
TPS_SONNERIE INT,
TPS_CONVERSATION_AGENT INT,
TPS_CONVERSATION_CLIENT INT,
HOLD_DURATION INT,
ORIGINAL_FILE_NAME VARCHAR(50),
ORIGINAL_FILE_SIZE INT,
ORIGINAL_FILE_LINE_COUNT INT,
INSERT_DATE TIMESTAMP,
FILE_DATE DATE
);

CREATE TABLE CTI.SQ_IT_STAT_AGENT_CTI(
INTERACTION_ID VARCHAR(15 BYTE),
START_TIME DATE,
END_TIME_TS DATE,
INTERACTION_TYPE VARCHAR(25 BYTE),
MSIDSN VARCHAR(15 BYTE),
DATE_TIME_AGG DATE,
ThirtyMinAgg DATE,
RESOURCES VARCHAR(10 BYTE),
RESOURCE_TYPE VARCHAR(15 BYTE),
RESOURCE_SUBTYPE VARCHAR(15 BYTE), 
AGENT_FIRST_NAME VARCHAR(255 BYTE), 
AGENT_LAST_NAME VARCHAR(255 BYTE),
MEDIA VARCHAR(15 BYTE), 
TECHNICAL_RESULT VARCHAR(15 BYTE),
RESULT_REASON VARCHAR(15 BYTE),
RESOURCE_ROLE VARCHAR(15 BYTE),
ROLE_REASON VARCHAR(15 BYTE),  
PLACE NUMBER,
UD_langue NUMBER,
UD_vipgsm NUMBER,
UD_vipomy NUMBER,
UD_isomy NUMBER,
UD_ListSegment VARCHAR(20 BYTE),
UD_segment VARCHAR(30 BYTE),
UD_site_cible VARCHAR(15 BYTE), 
UD_site_choisi VARCHAR(15 BYTE),
UD_comp  VARCHAR(20 BYTE),
UD_comp_deb  VARCHAR(15 BYTE),
UD_comp_choisi  VARCHAR(20 BYTE),
UD_TYPE_CC  VARCHAR(20 BYTE),
UD_crise_site NUMBER,
UD_crise_ferm NUMBER,
UD_crise_flux NUMBER,
UD_crise_dissu NUMBER,
UD_distributed VARCHAR(10 BYTE),
UD_nRONA NUMBER,
UD_HNO NUMBER,
UD_Xfer_Presta VARCHAR(15 BYTE),
UD_Fermeture VARCHAR(15 BYTE),
UD_Dissuasion VARCHAR(15 BYTE),
UD_DNIS NUMBER,
UD_DureeAttente NUMBER,
UD_PrioriteFlux NUMBER,
UD_ANI VARCHAR(15 BYTE),
TARGET NUMBER,
SHORT_ABD_FLAG NUMBER,
TPS_RP NUMBER,
TPS_ACW NUMBER,
TPS_SONNERIE NUMBER,
TPS_CONVERSATION_AGENT NUMBER,
TPS_CONVERSATION_CLIENT NUMBER,
HOLD_DURATION NUMBER,
ORIGINAL_FILE_NAME VARCHAR(50 BYTE),
ORIGINAL_FILE_SIZE NUMBER,
ORIGINAL_FILE_LINE_COUNT NUMBER,
INSERT_DATE TIMESTAMP,
FILE_DATE DATE
);



---TABLE DWH
CREATE TABLE CTI.TMP_IT_STAT_AGENT_CTI(
INTERACTION_ID VARCHAR(15 BYTE),
START_TIME DATE,
END_TIME_TS DATE,
INTERACTION_TYPE VARCHAR(25 BYTE),
MSIDSN VARCHAR(15 BYTE),
DATE_TIME_AGG DATE,
ThirtyMinAgg DATE,
RESOURCES VARCHAR(10 BYTE),
RESOURCE_TYPE VARCHAR(15 BYTE),
RESOURCE_SUBTYPE VARCHAR(15 BYTE), 
AGENT_FIRST_NAME VARCHAR(255 BYTE), 
AGENT_LAST_NAME VARCHAR(255 BYTE),
MEDIA VARCHAR(15 BYTE), 
TECHNICAL_RESULT VARCHAR(15 BYTE),
RESULT_REASON VARCHAR(15 BYTE),
RESOURCE_ROLE VARCHAR(15 BYTE),
ROLE_REASON VARCHAR(15 BYTE),  
PLACE NUMBER,
UD_langue NUMBER,
UD_vipgsm NUMBER,
UD_vipomy NUMBER,
UD_isomy NUMBER,
UD_ListSegment VARCHAR(20 BYTE),
UD_segment VARCHAR(30 BYTE),
UD_site_cible VARCHAR(15 BYTE), 
UD_site_choisi VARCHAR(15 BYTE),
UD_comp  VARCHAR(20 BYTE),
UD_comp_deb  VARCHAR(15 BYTE),
UD_comp_choisi  VARCHAR(20 BYTE),
UD_TYPE_CC  VARCHAR(20 BYTE),
UD_crise_site NUMBER,
UD_crise_ferm NUMBER,
UD_crise_flux NUMBER,
UD_crise_dissu NUMBER,
UD_distributed VARCHAR(10 BYTE),
UD_nRONA NUMBER,
UD_HNO NUMBER,
UD_Xfer_Presta VARCHAR(15 BYTE),
UD_Fermeture VARCHAR(15 BYTE),
UD_Dissuasion VARCHAR(15 BYTE),
UD_DNIS NUMBER,
UD_DureeAttente NUMBER,
UD_PrioriteFlux NUMBER,
UD_ANI VARCHAR(15 BYTE),
TARGET NUMBER,
SHORT_ABD_FLAG NUMBER,
TPS_RP NUMBER,
TPS_ACW NUMBER,
TPS_SONNERIE NUMBER,
TPS_CONVERSATION_AGENT NUMBER,
TPS_CONVERSATION_CLIENT NUMBER,
HOLD_DURATION NUMBER,
ORIGINAL_FILE_NAME VARCHAR(50 BYTE),
ORIGINAL_FILE_SIZE NUMBER,
ORIGINAL_FILE_LINE_COUNT NUMBER,
INSERT_DATE TIMESTAMP,
FILE_DATE DATE);

DECLARE 
  SAMPLE_TABLE VARCHAR2(200); MIN_DATE_PARTITION VARCHAR2(200); MAX_DATE_PARTITION VARCHAR2(200);  KEY_COLUMN_PART_NAME VARCHAR2(200);
  KEY_COLUMN_PART_TYPE VARCHAR2(200);   PART_OWNER VARCHAR2(200);  PART_TABLE_NAME VARCHAR2(200);  PART_PARTITION_NAME VARCHAR2(200);
  PART_TYPE_PERIODE VARCHAR2(200);  PART_RETENTION NUMBER;  PART_TBS_CIBLE VARCHAR2(200);  PART_GARDER_01_DU_MOIS VARCHAR2(200);
PART_PCT_FREE NUMBER;   PART_COMPRESSION VARCHAR2(200);  PART_ROTATION_ACTIVE VARCHAR2(200);  PART_FORMAT VARCHAR2(200);
BEGIN 
  SAMPLE_TABLE := 'CTI.TMP_IT_STAT_AGENT_CTI';
  MIN_DATE_PARTITION := '20210101';
  MAX_DATE_PARTITION := '20220101';
  KEY_COLUMN_PART_NAME := 'FILE_DATE';
  KEY_COLUMN_PART_TYPE := 'JOUR';
  PART_OWNER := 'CTI';
  PART_TABLE_NAME := 'IT_STAT_AGENT_CTI';
  PART_PARTITION_NAME := 'STAT_AGENT_CTI_';
  PART_TYPE_PERIODE := 'JOUR';
  PART_RETENTION := 1000;
  PART_TBS_CIBLE :=  'TAB_MIG_64K';
  PART_GARDER_01_DU_MOIS := 'NON';
  PART_PCT_FREE := 0;
  PART_COMPRESSION := 'COMPRESS';
  PART_ROTATION_ACTIVE := 'OUI';
  PART_FORMAT := 'yyyymmdd';
  MON.CREATE_PARTITIONED_TABLE ( SAMPLE_TABLE, MIN_DATE_PARTITION, MAX_DATE_PARTITION, KEY_COLUMN_PART_NAME, KEY_COLUMN_PART_TYPE, PART_OWNER, PART_TABLE_NAME, PART_PARTITION_NAME, PART_TYPE_PERIODE, PART_RETENTION, PART_TBS_CIBLE, PART_GARDER_01_DU_MOIS, PART_PCT_FREE, PART_COMPRESSION, PART_ROTATION_ACTIVE, PART_FORMAT );
  COMMIT; 
END;