INSERT INTO CDR.SPARK_IT_MAXIT_RAW_EVENT
SELECT
anonymousId,
context_app_build,
context_app_name,
context_app_namespace,
context_app_version,
context_device_adTrackingEnabled,
context_device_advertisingId,
context_device_id,
context_device_manufacturer,
context_device_model,
context_device_name,
context_device_type,
context_ip,
context_library_name,
context_library_version,
context_locale,
context_network_bluetooth,
context_network_carrier,
context_network_cellular,
context_network_wifi,
context_os_name,
context_os_version,
context_protocols_sourceId,
context_screen_density,
context_screen_height,
context_screen_width,
context_timezone,
context_traits_anonymousId,
context_traits_tenantId,
context_traits_userId,
context_userAgent,
properties_banner_category,
properties_banner_id,
properties_banner_name,
properties_build,
properties_bundle_category,
properties_bundle_id,
properties_bundle_name,
properties_category_name,
properties_context,
properties_currency,
properties_favorite_event,
properties_favorite_partner,
properties_favorite_services,
properties_filter_type,
properties_from_background,
properties_helper,
properties_item_category,
properties_item_category_id,
properties_item_duration,
properties_item_end_date,
properties_item_format,
properties_item_id,
properties_item_name,
properties_item_price,
properties_item_provider,
properties_item_provider_id,
properties_item_start_date,
properties_item_stock,
properties_item_subcategory,
properties_item_subtype,
properties_item_type,
properties_line_commitment,
properties_merchant_id,
properties_new_line,
properties_organism_title,
properties_organism_type,
properties_partner_id,
properties_pass_id,
properties_pass_name,
properties_pass_price,
properties_pass_type_id,
properties_pass_type_name,
properties_payment_method,
properties_payment_status,
properties_receiver_id,
properties_referring_application,
properties_request_status,
properties_request_type,
properties_sender_id,
properties_service_category,
properties_service_id,
properties_service_name,
properties_sos_activate_date,
properties_sos_activate_time,
properties_sos_id,
properties_sos_name,
properties_sos_remaining_balance,
properties_sos_transfer_amount,
properties_subscription_end_date,
properties_subscription_start_date,
properties_subscription_status,
properties_tenant_id,
properties_ticket_name0,
properties_ticket_name1,
properties_ticket_name2,
properties_ticket_name3,
properties_ticket_name4,
properties_ticket_price0,
properties_ticket_price1,
properties_ticket_price2,
properties_ticket_price3,
properties_ticket_price4,
properties_ticket_quantity0,
properties_ticket_quantity1,
properties_ticket_quantity2,
properties_ticket_quantity3,
properties_ticket_quantity4,
properties_total_amount,
properties_total_price,
properties_transaction_amount,
properties_transaction_date,
properties_transaction_type,
properties_url,
properties_username,
properties_version,
properties_vote_price,
properties_voting_category,
properties_voting_content,
properties_bill_amount,
properties_bill_expiry_date,
properties_bill_id,
properties_bill_issue_date,
properties_bill_type,
properties_credit_remaining_balance,
properties_credit_transfer_amount,
properties_data_transfer_amount,
properties_data_unit,
properties_filter_name,
properties_option_id,
properties_option_name,
properties_option_remaining_balance,
properties_search_method,
properties_sharing_channel,
properties_social_network,
properties_permission_type,
properties_reason,
properties_pass_type,
properties_top_up_method,
properties_Partner_id_doublon,
properties_Currency_doublon,
properties_rate_confirmation,
properties_logout_confirmation,
properties_favorite_events_tickets,
properties_favorite_partners,
properties_purchased_services,
properties_avatar_id,
properties_rate_score,
properties_feedback_msg,
properties_app_list,
properties_app_name,
properties_app_desc,
properties_redir_link,
properties_websites_list,
properties_website_name,
properties_claim_id,
properties_claim_status,
properties_claim_text,
properties_claim_date,
properties_claim_time,
properties_remaining_balance,
properties_review_text,
properties_rating_stars,
properties_available_balance,
properties_transfer_amount,
properties_reason_selected,
properties_ticket_status,
properties_receipt_number,
properties_amount_received,
properties_from_account,
properties_receiver_account,
properties_active_filters,
properties_shop_name,
properties_shop_adress,
properties_open_closed,
properties_gender,
properties_first_name,
properties_last_name,
properties_birth_date,
properties_current_profession,
properties_city_residence,
properties_id_number,
properties_issuance_date,
properties_expiration_date,
properties_place_issue,
properties_field_activity,
properties_income_level,
properties_rightsholder,
event_type,
integrations_Firebase,
messageId,
name,
-- from tt originalTimestamp : 2023-11-09T19:56:24.895Z
-- conserver en chaine de caract√®re
`originalTimestamp`,
-- from tt receiveAt : 2023-11-10 01:03:46
FROM_UNIXTIME(UNIX_TIMESTAMP(version,'yyyy-MM-dd HH:mm:ss')) receivedAt,
-- from tt sentAt : 2023-11-10 01:03:45
FROM_UNIXTIME(UNIX_TIMESTAMP(version,'yyyy-MM-dd HH:mm:ss')) sentAt,
-- from tt timestamp : 2023-11-09 19:56:25
FROM_UNIXTIME(UNIX_TIMESTAMP(C.timestamp,'yyyy-MM-dd HH:mm:ss')) `timestamp`,
type,
-- from tt userid correspond au msisdn
userId,
writeKey,
-- from tt : version TIMESTAMP 2023-11-10 01:04:20
--2023-11-10 01:33:49.0
FROM_UNIXTIME(UNIX_TIMESTAMP(version,'yyyy-MM-dd HH:mm:ss')) version,
ORIGINAL_FILE_NAME,
ORIGINAL_FILE_SIZE,
ORIGINAL_FILE_LINE_COUNT, 
CURRENT_TIMESTAMP  INSERTED_DATE,
TO_DATE(FROM_UNIXTIME(UNIX_TIMESTAMP(SUBSTRING(ORIGINAL_FILE_NAME, -18, 8),'yyyyMMdd'))) ORIGINAL_FILE_DATE,
--from tt original_file_name : RAW_MAXIT_EVENT_20230715000000.csv
TO_DATE(FROM_UNIXTIME(UNIX_TIMESTAMP(version,'yyyy-MM-dd HH:mm:ss'))) CDR_DATE_VERSION
-- from tt : version TIMESTAMP 2023-11-10 01:04:20
FROM TT.MAXIT_RAW_EVENT C
LEFT JOIN (SELECT DISTINCT  ORIGINAL_FILE_NAME FILE_NAME FROM CDR.SPARK_IT_MAXIT_RAW_EVENT 
WHERE CDR_DATE_VERSION BETWEEN DATE_SUB(CURRENT_DATE,${hivevar:date_offset}) AND CURRENT_DATE
) T ON T.FILE_NAME=C.ORIGINAL_FILE_NAME
WHERE T.FILE_NAME IS NULL