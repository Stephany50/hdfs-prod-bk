insert into CDR.SPARK_IT_BDI_LIGNE_FLOTTE
select
trim(b.MSISDN) AS MSISDN,
trim(b.CUSTOMER_ID) AS CUSTOMER_ID,
trim(b.CONTRACT_ID) AS CONTRACT_ID,
trim(b.COMPTE_CLIENT) AS COMPTE_CLIENT,
trim(b.TYPE_PERSONNE) AS TYPE_PERSONNE,
trim(b.TYPE_PIECE) AS TYPE_PIECE,
trim(b.NUMERO_PIECE) AS NUMERO_PIECE,
trim(b.ID_TYPE_PIECE) AS ID_TYPE_PIECE,
trim(b.NOM_PRENOM) AS NOM_PRENOM,
trim(b.NOM) AS NOM,
trim(b.PRENOM) AS PRENOM,
trim(b.DATE_NAISSANCE) AS DATE_NAISSANCE,
trim(b.DATE_EXPIRATION) AS DATE_EXPIRATION,
trim(b.ADRESSE) AS ADRESSE,
trim(b.VILLE) AS VILLE,
trim(b.QUARTIER) AS QUARTIER,
trim(b.DATE_SOUSCRIPTION) AS DATE_SOUSCRIPTION,
trim(b.DATE_ACTIVATION) AS DATE_ACTIVATION,
trim(b.STATUT) AS STATUT,
trim(b.RAISON_STATUT) AS RAISON_STATUT,
trim(b.DATE_CHANGEMENT_STATUT) AS DATE_CHANGEMENT_STATUT,
trim(b.PLAN_LOCALISATION) AS PLAN_LOCALISATION,
trim(b.CONTRAT_SOUCRIPTION) AS CONTRAT_SOUCRIPTION,
trim(b.DISPONIBILITE_SCAN) AS DISPONIBILITE_SCAN,
trim(b.ACCEPTATION_CGV) AS ACCEPTATION_CGV,
trim(b.TYPE_PIECE_TUTEUR) AS TYPE_PIECE_TUTEUR,
trim(b.NUMERO_PIECE_TUTEUR) AS NUMERO_PIECE_TUTEUR,
trim(b.NOM_TUTEUR) AS NOM_TUTEUR,
trim(b.PRENOM_TUTEUR) AS PRENOM_TUTEUR,
trim(b.DATE_NAISSANCE_TUTEUR) AS DATE_NAISSANCE_TUTEUR,
trim(b.DATE_EXPIRATION_TUTEUR) AS DATE_EXPIRATION_TUTEUR,
trim(b.ADRESSE_TUTEUR) AS ADRESSE_TUTEUR,
trim(b.COMPTE_CLIENT_STRUCTURE) AS COMPTE_CLIENT_STRUCTURE,
trim(b.NOM_STRUCTURE) AS NOM_STRUCTURE,
trim(b.NUMERO_REGISTRE_COMMERCE) AS NUMERO_REGISTRE_COMMERCE,
trim(b.NUMERO_PIECE_REPRESENTANT_LEGAL) AS NUMERO_PIECE_REPRESENTANT_LEGAL,
trim(b.IMEI) AS IMEI,
trim(b.STATUT_DEROGATION) AS STATUT_DEROGATION,
trim(b.REGION_ADMINISTRATIVE) AS REGION_ADMINISTRATIVE,
trim(b.REGION_COMMERCIALE) AS REGION_COMMERCIALE,
trim(b.SITE_NAME) AS SITE_NAME,
trim(b.VILLE_SITE) AS VILLE_SITE,
trim(b.OFFRE_COMMERCIALE) AS OFFRE_COMMERCIALE,
trim(b.TYPE_CONTRAT) AS TYPE_CONTRAT,
trim(b.SEGMENTATION) AS SEGMENTATION,
trim(b.odbIncomingCalls) AS odbIncomingCalls,
trim(b.odbOutgoingCalls) AS odbOutgoingCalls,
trim(b.DEROGATION_IDENTIFICATION) AS DEROGATION_IDENTIFICATION,
b.insert_date AS insert_date,
b.original_file_date AS original_file_date
from (
select a2.*,
row_number() over(partition by a2.msisdn order by a2.date_activation2 DESC NULLS LAST) AS RANG
from (
select a.*,
(CASE
WHEN trim(a.DATE_ACTIVATION) IS NULL OR trim(a.DATE_ACTIVATION) = '' THEN NULL
WHEN trim(a.DATE_ACTIVATION) like '%/%'
THEN  cast(translate(SUBSTR(trim(a.DATE_ACTIVATION), 1, 19),'/','-') AS TIMESTAMP)
WHEN trim(a.DATE_ACTIVATION) like '%-%' THEN  cast(SUBSTR(trim(a.DATE_ACTIVATION), 1, 19) AS TIMESTAMP)
ELSE NULL
END) DATE_ACTIVATION2
from TMP.TT_BDI_LIGNE_FLOTTE2 a
) a2
) b where RANG = 1


