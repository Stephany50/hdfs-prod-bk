CREATE TABLE CDR.IT_ZTE_SUBSCRIPTION (
  ACC_NBR VARCHAR(16),
  CHANNEL_ID	INT,
  SUBS_EVENT_ID	INT,
  NQ_CREATEDDATE	TIMESTAMP,
  OLD_SUBS_STATE	VARCHAR(3),
  NEW_SUBS_STATE	VARCHAR(3),
  EVENT_COST	INT,
  BENEFIT_NAME	VARCHAR(50),
  BENEFIT_BAL_LIST	VARCHAR(2000),
  OLD_PROD_SPEC_CODE	VARCHAR(10),
  PROD_SPEC_CODE	VARCHAR(10),
  OLD_PRICE_PLAN_CODE	VARCHAR(10),
  PRICE_PLAN_CODE	VARCHAR(50),
  OLD_RELATED_PROD_CODE	VARCHAR(10),
  RELATED_PROD_CODE	VARCHAR(10),
  ACTIVE_DATE	TIMESTAMP,
  EXPIRED_DATE	TIMESTAMP,
  PROVIDER_ID	INT,
  PREPAY_FLAG	INT,
  PAYMENT_NUMBER VARCHAR(20),
  SUBSCRIPTION_COST BIGINT,
  TRANSACTIONSN BIGINT,
  ORIGINAL_FILE_NAME VARCHAR(100),
  ORIGINAL_FILE_DATE DATE,
  ORIGINAL_FILE_SIZE INT,
  ORIGINAL_FILE_LINE_COUNT INT,
  INSERT_DATE TIMESTAMP
)
PARTITIONED BY (CREATEDDATE DATE)
CLUSTERED BY(PROD_SPEC_CODE,PRICE_PLAN_CODE,SUBS_EVENT_ID,CHANNEL_ID,OLD_PROD_SPEC_CODE,OLD_PRICE_PLAN_CODE) INTO 5 BUCKETS
STORED AS ORC 
TBLPROPERTIES ('transactional'='true',"orc.compress"="ZLIB","orc.stripe.size"="67108864");


-- COLONNES DEJA PRESENTES DANS LA IT. MAIS LES ALTER TABLE SONT ABSENTES
-- EXP_LAC,
-- EXP_CELL_ID,
-- BAL_ID,

-- NOUVELLES COLONNES PRESENTES DANS LE FICHIER CDR ET RAJOUTER DANS LA TT VIA LES ALTERS
-- ALTER TABLE POUR LES RAJOUTER A L IT DANS CET ORDRE
-- UNKNOWN_COL,
ALTER TABLE CDR.IT_ZTE_SUBSCRIPTION ADD COLUMNS (UNKNOWN_COL VARCHAR(200));

-- ACCOUNT_RES_ID,
ALTER TABLE CDR.IT_ZTE_SUBSCRIPTION ADD COLUMNS (ACCOUNT_RES_ID VARCHAR(200));

-- REQUEST_ID
ALTER TABLE CDR.IT_ZTE_SUBSCRIPTION ADD COLUMNS (REQUEST_ID VARCHAR(200));


-- EVENT_COST  INT, AUCUNES MODIFICATIONS A FAIRE POUR GARDER LE COMPORTEMENT DE BASE.
-- DANS L'IT IL FAUT CONSERVER LE TYPE INT DE EVENT_COST 
-- IL FAUT LA FAIRE PASSER DE INT POUR VARCHAR DANS LA TT (VOIR LES ALTER DE LA TT)

-- IL FAUT CREER DE NOUVELLES COLONNES POUR EVENT_COST
-- EVENT_COST_CHAR : pour stocker l'intégralité du champ event_cost situé dans la TT (VOIR LE SCRIPT DE L'IT)
ALTER TABLE CDR.IT_ZTE_SUBSCRIPTION ADD COLUMNS (EVENT_COST_CHAR VARCHAR(200));

-- EVENT_COST_SUM : pour la somme de toutes les valeurs de event_cost séparées par la virgule

-- DANS L'IT IL FAUT CONSERVER LE TYPE INT DE EVENT_COST ET FAIRE UN SPLIT PAR LA VIRGULE
-- ET SOMMER LES VALEURS DES POSITIONS 0 1 2 3 (VOIR INSERT INTO IT) A METTRE DANS EVENT_COST_SUM
-- SACHANT QUE NOUS AVONS JUSTE 2 VALEURS A CE JOUR.

ALTER TABLE CDR.IT_ZTE_SUBSCRIPTION ADD COLUMNS (EVENT_COST_SUM DECIMAL(17,3));
