CREATE EXTERNAL TABLE CDR.tt_kaabu_client_directory_req2 (
  ORIGINAL_FILE_NAME VARCHAR(200),
  ORIGINAL_FILE_SIZE INT,
  ORIGINAL_FILE_LINE_COUNT INT,
  NUMERO  VARCHAR(250),
  TYPEDECONTRAT  VARCHAR(250),
  SOURCE  VARCHAR(250),
  TELEPHONE  VARCHAR(250),
  GENDER  VARCHAR(250),
  TITRE  VARCHAR(250),
  PRENOMDUCLIENT  VARCHAR(250),
  NOMDUCLIENT  VARCHAR(250),
  DATEDENAISSANCE  VARCHAR(250),
  LIEUDENAISSANCE  VARCHAR(250),
  PIECE  VARCHAR(250),
  NUMEROPIECE  VARCHAR(250),
  DELIVRANCE  VARCHAR(250),
  EXPIRATION  VARCHAR(250),
  NATIONALITE  VARCHAR(250),
  QUARTIER  VARCHAR(250),
  VILLE  VARCHAR(250),
  LOGINVENDEUR  VARCHAR(250),
  PRENOMVENDEUR  VARCHAR(250),
  NOMVENDEUR  VARCHAR(249),
  NUMERODUVENDEUR  VARCHAR(250),
  LOGINDISTRIBUTEUR  VARCHAR(250),
  PRENOMDISTRIBUTEUR  VARCHAR(250),
  NOMDISTRIBUTEUR  VARCHAR(250),
  EMISLE  VARCHAR(250),
  MAJLE  VARCHAR(250),
  LOGINMAJ  VARCHAR(250),
  PRENOMMAJ  VARCHAR(250),
  NOMMAJ  VARCHAR(250),
  ETAT  VARCHAR(250),
  ETATDEXPORTGLOBAL  VARCHAR(250),
  LOGINVALIDATEUR  VARCHAR(250),
  PRENOMVALIDATEUR  VARCHAR(249),
  NOMVALIDATEUR  VARCHAR(250),
  CAUSEECHEC  VARCHAR(250),
  COMMENTAIRE  VARCHAR(250),
  PWDCLIENT  VARCHAR(250),
  LAST_UPDATE_DATE  VARCHAR(250),
  DELIVRANCE1  VARCHAR(250),
  LIEUDEDELIVRANCE  VARCHAR(250),
  COPIE  VARCHAR(250),
  UPDATE_ON  VARCHAR(250),
  ID  VARCHAR(250),
  PICTURE_LOADED_DATE  VARCHAR(250),
  SOURCE_DONNEES VARCHAR(250),
  TYPEOPERATION VARCHAR(250),
  date_controle VARCHAR(250)
)
COMMENT 'external tables-TT'
ROW FORMAT DELIMITED FIELDS TERMINATED BY ';'
LOCATION '/PROD/TT/IDENTIFICATION/KAABU_PROD_REQ2'
TBLPROPERTIES ('serialization.null.format'='')
;


CREATE TABLE CDR.SPARK_IT_KAABU_CLIENT_DIRECTORY_REQ2
(
  numero      varchar(250) ,
  typedecontrat varchar(250) ,
  source      varchar(250) ,
  telephone   varchar(250) ,
  gender      varchar(250) ,
  titre       varchar(250) ,
  prenomduclient varchar(250) ,
  nomduclient varchar(250) ,
  datedenaissance   varchar(250) ,
  lieudenaissance   varchar(250) ,
  piece       varchar(250) ,
  numeropiece varchar(250) ,
  delivrance  varchar(250) ,
  expiration  varchar(250) ,
  nationalite varchar(250) ,
  quartier    varchar(250) ,
  ville       varchar(250) ,
  loginvendeur varchar(250) ,
  prenomvendeur varchar(250) ,
  nomvendeur  varchar(249) ,
  numeroduvendeur   varchar(250) ,
  logindistributeur varchar(250) ,
  prenomdistributeur varchar(250) ,
  nomdistributeur   varchar(250) ,
  emisle      varchar(250) ,
  majle       varchar(250) ,
  loginmaj    varchar(250) ,
  prenommaj   varchar(250) ,
  nommaj      varchar(250) ,
  etat        varchar(250) ,
  etatdexportglobal varchar(250) ,
  loginvalidateur   varchar(250) ,
  prenomvalidateur  varchar(249) ,
  nomvalidateur varchar(250) ,
  causeechec  varchar(250) ,
  commentaire varchar(250) ,
  pwdclient   varchar(250) ,
  last_update_date  varchar(250) ,
  delivrance1 varchar(250) ,
  lieudedelivrance  varchar(250) ,
  copie       varchar(250) ,
  update_on   varchar(250) ,
  id varchar(250) ,
  picture_loaded_date  varchar(250) ,
  source_donnees varchar(250) ,
  typeoperation varchar(250) ,
  date_controle VARCHAR(250),
  original_file_name varchar(200) ,
  original_file_size int,
  original_file_line_count  int,
  INSERT_DATE TIMESTAMP
)
PARTITIONED BY (ORIGINAL_FILE_DATE DATE,DATE_CONTROLE DATE)
CLUSTERED BY(NUMERO) INTO 64 BUCKETS
STORED AS PARQUET TBLPROPERTIES ('PARQUET.COMPRESS'='SNAPPY');



---Staging table in DWH
CREATE TABLE MON.SQ_IT_KAABU_CLIENT_REQ2 (
  NUMERO              VARCHAR2(250),
  TYPEDECONTRAT       VARCHAR2(250),
  SOURCE              VARCHAR2(250),
  TELEPHONE           VARCHAR2(250),
  GENDER              VARCHAR2(250),
  TITRE               VARCHAR2(250),
  PRENOMDUCLIENT      VARCHAR2(250),
  NOMDUCLIENT         VARCHAR2(250),
  DATEDENAISSANCE     VARCHAR2(250),
  LIEUDENAISSANCE     VARCHAR2(250),
  PIECE               VARCHAR2(250),
  NUMEROPIECE         VARCHAR2(250),
  DELIVRANCE          VARCHAR2(250),
  EXPIRATION          VARCHAR2(250),
  NATIONALITE         VARCHAR2(250),
  QUARTIER            VARCHAR2(250),
  VILLE               VARCHAR2(250),
  LOGINVENDEUR        VARCHAR2(250),
  PRENOMVENDEUR       VARCHAR2(250),
  NOMVENDEUR          VARCHAR2(249),
  NUMERODUVENDEUR     VARCHAR2(250),
  LOGINDISTRIBUTEUR   VARCHAR2(250),
  PRENOMDISTRIBUTEUR  VARCHAR2(250),
  NOMDISTRIBUTEUR     VARCHAR2(250),
  EMISLE              VARCHAR2(250),
  MAJLE               VARCHAR2(250),
  LOGINMAJ            VARCHAR2(250),
  PRENOMMAJ           VARCHAR2(250),
  NOMMAJ              VARCHAR2(250),
  ETAT                VARCHAR2(250),
  ETATDEXPORTGLOBAL   VARCHAR2(250),
  LOGINVALIDATEUR     VARCHAR2(250),
  PRENOMVALIDATEUR    VARCHAR2(249),
  NOMVALIDATEUR       VARCHAR2(250),
  CAUSEECHEC          VARCHAR2(250),
  COMMENTAIRE         VARCHAR2(250),
  PWDCLIENT           VARCHAR2(250),
  LAST_UPDATE_DATE    VARCHAR2(250),
  DELIVRANCE1         VARCHAR2(250),
  LIEUDEDELIVRANCE    VARCHAR2(250),
  COPIE               VARCHAR2(250),
  UPDATE_ON           VARCHAR2(250),
  ID                  VARCHAR2(250),
  PICTURE_LOADED_DATE VARCHAR2(250),
  SOURCE_DONNEES      VARCHAR2(250),
  TYPEOPERATION       VARCHAR2(250),
  date_controle       VARCHAR2(250),
  ORIGINAL_FILE_NAME  VARCHAR2(50),
  ORIGINAL_FILE_SIZE  NUMBER,
  ORIGINAL_FILE_LINE_COUNT NUMBER,
  INSERT_DATE DATE,
  ORIGINAL_FILE_DATE DATE
);




---Staging table in data lake
CREATE TABLE TMP.SQ_IT_KAABU_CLIENT_DIRECTORY_REQ2 (
NUMERO              VARCHAR(250),
  TYPEDECONTRAT       VARCHAR(250),
  SOURCE              VARCHAR(250),
  TELEPHONE           VARCHAR(250),
  GENDER              VARCHAR(250),
  TITRE               VARCHAR(250),
  PRENOMDUCLIENT      VARCHAR(250),
  NOMDUCLIENT         VARCHAR(250),
  DATEDENAISSANCE     VARCHAR(250),
  LIEUDENAISSANCE     VARCHAR(250),
  PIECE               VARCHAR(250),
  NUMEROPIECE         VARCHAR(250),
  DELIVRANCE          VARCHAR(250),
  EXPIRATION          VARCHAR(250),
  NATIONALITE         VARCHAR(250),
  QUARTIER            VARCHAR(250),
  VILLE               VARCHAR(250),
  LOGINVENDEUR        VARCHAR(250),
  PRENOMVENDEUR       VARCHAR(250),
  NOMVENDEUR          VARCHAR(249),
  NUMERODUVENDEUR     VARCHAR(250),
  LOGINDISTRIBUTEUR   VARCHAR(250),
  PRENOMDISTRIBUTEUR  VARCHAR(250),
  NOMDISTRIBUTEUR     VARCHAR(250),
  EMISLE              VARCHAR(250),
  MAJLE               VARCHAR(250),
  LOGINMAJ            VARCHAR(250),
  PRENOMMAJ           VARCHAR(250),
  NOMMAJ              VARCHAR(250),
  ETAT                VARCHAR(250),
  ETATDEXPORTGLOBAL   VARCHAR(250),
  LOGINVALIDATEUR     VARCHAR(250),
  PRENOMVALIDATEUR    VARCHAR(249),
  NOMVALIDATEUR       VARCHAR(250),
  CAUSEECHEC          VARCHAR(250),
  COMMENTAIRE         VARCHAR(250),
  PWDCLIENT           VARCHAR(250),
  LAST_UPDATE_DATE    VARCHAR(250),
  DELIVRANCE1         VARCHAR(250),
  LIEUDEDELIVRANCE    VARCHAR(250),
  COPIE               VARCHAR(250),
  UPDATE_ON           VARCHAR(250),
  ID                  VARCHAR(250),
  PICTURE_LOADED_DATE VARCHAR(250),
  SOURCE_DONNEES      VARCHAR(250),
  TYPEOPERATION       VARCHAR(250),
  date_controle VARCHAR(250),
  ORIGINAL_FILE_NAME  VARCHAR(50),
  ORIGINAL_FILE_SIZE  INT,
  ORIGINAL_FILE_LINE_COUNT INT,
  INSERT_DATE TIMESTAMP,
  ORIGINAL_FILE_DATE DATE
);


DECLARE 
  SAMPLE_TABLE VARCHAR2(200); MIN_DATE_PARTITION VARCHAR2(200); MAX_DATE_PARTITION VARCHAR2(200);  KEY_COLUMN_PART_NAME VARCHAR2(200);
  KEY_COLUMN_PART_TYPE VARCHAR2(200);   PART_OWNER VARCHAR2(200);  PART_TABLE_NAME VARCHAR2(200);  PART_PARTITION_NAME VARCHAR2(200);
  PART_TYPE_PERIODE VARCHAR2(200);  PART_RETENTION NUMBER;  PART_TBS_CIBLE VARCHAR2(200);  PART_GARDER_01_DU_MOIS VARCHAR2(200);
PART_PCT_FREE NUMBER;   PART_COMPRESSION VARCHAR2(200);  PART_ROTATION_ACTIVE VARCHAR2(200);  PART_FORMAT VARCHAR2(200);
BEGIN 
  SAMPLE_TABLE := 'MON.SQ_IT_KAABU_CLIENT_REQ2';
  MIN_DATE_PARTITION := '20220101';
  MAX_DATE_PARTITION := '20270101';
  KEY_COLUMN_PART_NAME := 'ORIGINAL_FILE_DATE';
  KEY_COLUMN_PART_TYPE := 'JOUR';
  PART_OWNER := 'MON';
  PART_TABLE_NAME := 'IT_KAABU_CLIENT_REQ2';
  PART_PARTITION_NAME := 'IT_KAABU_CLIENT_REQ2_';
  PART_TYPE_PERIODE := 'JOUR';
  PART_RETENTION := 1000;
  PART_TBS_CIBLE :=  'TAB_P_CDR_J01_256M';
  PART_GARDER_01_DU_MOIS := 'NON';
  PART_PCT_FREE := 0;
  PART_COMPRESSION := 'COMPRESS';
  PART_ROTATION_ACTIVE := 'OUI';
  PART_FORMAT := 'yyyymmdd';
  MON.CREATE_PARTITIONED_TABLE ( SAMPLE_TABLE, MIN_DATE_PARTITION, MAX_DATE_PARTITION, KEY_COLUMN_PART_NAME, KEY_COLUMN_PART_TYPE, PART_OWNER, PART_TABLE_NAME, PART_PARTITION_NAME, PART_TYPE_PERIODE, PART_RETENTION, PART_TBS_CIBLE, PART_GARDER_01_DU_MOIS, PART_PCT_FREE, PART_COMPRESSION, PART_ROTATION_ACTIVE, PART_FORMAT );
  COMMIT; 
END;
