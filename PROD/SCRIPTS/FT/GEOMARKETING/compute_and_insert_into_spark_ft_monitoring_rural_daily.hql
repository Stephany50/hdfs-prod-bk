INSERT INTO MON.SPARK_FT_MONITORING_RURAL_DAILY PARTITION(event_date)
SELECT 
    UPPER(TRIM(
        COALESCE(T.SITE_NAME, A.SITE_NAME, B.SITE_NAME, C.SITE_NAME, D.SITE_NAME, E.SITE_NAME, F.SITE_NAME, G.SITE_NAME, H.SITE_NAME, J.SITE_NAME, K.SITE_NAME,
    L.SITE_NAME, M.SITE_NAME, N.SITE_NAME, O.SITE_NAME, P.SITE_NAME, Q.SITE_NAME) 
    )) SITE,
    GROSS_ADD,
    PARC_ACTIF_OM,
    RECHARGES,
    CASHOUT,
    CASHIN,
    CALL_BOX,
    POS_OM,
    PARC_ART,
    PARC_GROUPE,
    DATAUSERS,
    NBRE_DEVICE_2G,
    NBRE_DEVICE_3G,
    NBRE_DEVICE_4G,
    NBRE_DEVICE_5G,
    GROSS_ADD_DATA,
    CHARGED_BASE,
    GROSS_ADD_OM,
    CURRENT_TIMESTAMP INSERT_DATE,
    '###SLICE_VALUE###' EVENT_DATE
FROM
(
    SELECT
        DISTINCT SITE_NAME
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###'
) T

FULL JOIN
(
    SELECT 
        LOC_SITE_NAME SITE_NAME,
        MAX(GROSS_ADD) GROSS_ADD,
        MAX(PARC_ACTIF_OM) PARC_ACTIF_OM
    FROM MON.SPARK_FT_SITE_360
    WHERE EVENT_DATE = '###SLICE_VALUE###'
    GROUP BY SITE_NAME
) A
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(A.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) RECHARGES
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='RECHARGES'
    GROUP BY SITE_NAME
) B
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(B.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) CASHOUT
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='CASHOUT'
    GROUP BY SITE_NAME
) C
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(C.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) CASHIN
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='CASHIN'
    GROUP BY SITE_NAME
) D
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(D.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) CALL_BOX
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='CALL_BOX'
    GROUP BY SITE_NAME
) E
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(E.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) POS_OM
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='POS_OM'
    GROUP BY SITE_NAME
) F
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(F.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) PARC_ART
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='PARC_ART'
    GROUP BY SITE_NAME
) G
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(G.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) PARC_GROUPE
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='PARC_GROUPE'
    GROUP BY SITE_NAME
) H
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(H.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) DATAUSERS
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='DATAUSERS'
    GROUP BY SITE_NAME
) J
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(J.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) NBRE_DEVICE_2G
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='NBRE_DEVICE_2G'
    GROUP BY SITE_NAME
) K
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(K.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) NBRE_DEVICE_3G
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='NBRE_DEVICE_3G'
    GROUP BY SITE_NAME
) L
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(L.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) NBRE_DEVICE_4G
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='NBRE_DEVICE_4G'
    GROUP BY SITE_NAME
) M
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(M.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        MAX(KPI_VALUE) NBRE_DEVICE_5G
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360
    WHERE EVENT_DATE = '###SLICE_VALUE###' AND KPI_NAME='NBRE_DEVICE_5G'
    GROUP BY SITE_NAME
) N
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(N.SITE_NAME))

FULL JOIN
(
    SELECT 
        SITE_NAME, 
        COUNT (DISTINCT A.MSISDN) GROSS_ADD_DATA
    FROM 
    (
        SELECT
            MSISDN  
        FROM
        (
            SELECT 
                N.MSISDN,
                CASE WHEN NVL(DATA_USED, 0) > 1 THEN 1 ELSE 0 END TMP_GROSS_ADD_DATA
            FROM 
            (
                SELECT DISTINCT
                    SERVED_PARTY_MSISDN MSISDN
                FROM MON.SPARK_FT_SUBSCRIPTION
                WHERE TRANSACTION_DATE  = '###SLICE_VALUE###' 
                AND SUBSCRIPTION_SERVICE LIKE '%PPS%' 
            ) N
            INNER JOIN 
            (
                SELECT 
                    SERVED_PARTY_MSISDN MSISDN,
                    (SUM(BYTES_SENT) + SUM(BYTES_RECEIVED)) /1024/1024 DATA_USED
                FROM MON.SPARK_FT_CRA_GPRS
                WHERE SESSION_DATE = '###SLICE_VALUE###'
                GROUP BY SERVED_PARTY_MSISDN
            ) M
            ON N.MSISDN = M.MSISDN
        ) WHERE TMP_GROSS_ADD_DATA = 1 
    ) A
    LEFT JOIN 
    (
        SELECT
            NVL(F10.MSISDN, F11.MSISDN) MSISDN,
            UPPER(NVL(F11.SITE_NAME, F10.SITE_NAME)) SITE_NAME
        FROM
        (
            SELECT
                MSISDN,
                MAX(SITE_NAME) SITE_NAME
            FROM MON.SPARK_FT_CLIENT_LAST_SITE_DAY
            WHERE EVENT_DATE = '###SLICE_VALUE###'
            GROUP BY MSISDN
        ) F10
        FULL JOIN
        (
            SELECT
                MSISDN,
                MAX(SITE_NAME) SITE_NAME
            FROM MON.SPARK_FT_CLIENT_SITE_TRAFFIC_DAY
            WHERE EVENT_DATE = '###SLICE_VALUE###'
            GROUP BY MSISDN
        ) F11
        ON F10.MSISDN = F11.MSISDN
    ) L
    ON A.MSISDN = L.MSISDN
    GROUP BY SITE_NAME  
) O
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(O.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        COUNT(DISTINCT G.MSISDN) CHARGED_BASE
    FROM
    (
        SELECT 
            MSISDN
        FROM
        (
            SELECT 
                MSISDN,
                MAX(CASE WHEN OG_CALL >= DATE_SUB(EVENT_DATE,31) OR LEAST(IC_CALL_4,IC_CALL_3,IC_CALL_2,IC_CALL_1) >= DATE_SUB(EVENT_DATE,31) THEN 1 ELSE 0 END) CHARGED 
            FROM MON.SPARK_FT_ACCOUNT_ACTIVITY A
            WHERE EVENT_DATE = DATE_ADD('###SLICE_VALUE###', 1)
            GROUP BY MSISDN  
        ) WHERE CHARGED = 1 
    ) G
    LEFT JOIN 
    (
        SELECT
            NVL(F10.MSISDN, F11.MSISDN) MSISDN,
            UPPER(NVL(F11.SITE_NAME, F10.SITE_NAME)) SITE_NAME
        FROM
        (
            SELECT
                MSISDN,
                MAX(SITE_NAME) SITE_NAME
            FROM MON.SPARK_FT_CLIENT_LAST_SITE_DAY
            WHERE EVENT_DATE = '###SLICE_VALUE###'
            GROUP BY MSISDN
        ) F10
        FULL JOIN
        (
            SELECT
                MSISDN,
                MAX(SITE_NAME) SITE_NAME
            FROM MON.SPARK_FT_CLIENT_SITE_TRAFFIC_DAY
            WHERE EVENT_DATE = '###SLICE_VALUE###'
            GROUP BY MSISDN
        ) F11
        ON F10.MSISDN = F11.MSISDN
    ) L
    ON G.MSISDN = L.MSISDN
    GROUP BY SITE_NAME
) P
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(P.SITE_NAME))

FULL JOIN
(
    SELECT
        SITE_NAME,
        COUNT(A.MSISDN) GROSS_ADD_OM
    FROM
    (
        SELECT 
            MSISDN
        FROM 
        (
            SELECT 
                N.MSISDN,
                CASE WHEN M.MSISDN IS NOT NULL THEN 1 ELSE 0 END GAOM
            FROM 
            (
                SELECT DISTINCT
                    SERVED_PARTY_MSISDN MSISDN
                    FROM MON.SPARK_FT_SUBSCRIPTION
                WHERE TRANSACTION_DATE  = '###SLICE_VALUE###'
                AND SUBSCRIPTION_SERVICE LIKE '%PPS%' 
            ) N
            INNER JOIN 
            (
                SELECT DISTINCT
                    SENDER_MSISDN MSISDN
                FROM CDR.SPARK_IT_OMNY_TRANSACTIONS
                WHERE TRANSFER_DATETIME  = '###SLICE_VALUE###'

                UNION

                SELECT DISTINCT
                    RECEIVER_MSISDN MSISDN
                FROM CDR.SPARK_IT_OMNY_TRANSACTIONS
                WHERE TRANSFER_DATETIME  = '###SLICE_VALUE###'
            ) M
            ON N.MSISDN = M.MSISDN
        ) WHERE GAOM = 1
    ) A
    LEFT JOIN 
    (
        SELECT
            NVL(F10.MSISDN, F11.MSISDN) MSISDN,
            UPPER(NVL(F11.SITE_NAME, F10.SITE_NAME)) SITE_NAME
        FROM
        (
            SELECT
                MSISDN,
                MAX(SITE_NAME) SITE_NAME
            FROM MON.SPARK_FT_CLIENT_LAST_SITE_DAY
            WHERE EVENT_DATE = '###SLICE_VALUE###'
            GROUP BY MSISDN
        ) F10
        FULL JOIN
        (
            SELECT
                MSISDN,
                MAX(SITE_NAME) SITE_NAME
            FROM MON.SPARK_FT_CLIENT_SITE_TRAFFIC_DAY
            WHERE EVENT_DATE = '###SLICE_VALUE###'
            GROUP BY MSISDN
        ) F11
        ON F10.MSISDN = F11.MSISDN
    ) L
    ON A.MSISDN = L.MSISDN
    GROUP BY SITE_NAME
) Q
ON UPPER(TRIM(T.SITE_NAME)) = UPPER(TRIM(Q.SITE_NAME))