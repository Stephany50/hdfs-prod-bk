INSERT INTO MON.SPARK_FT_CELL_TRAFIC_DAYLY
SELECT
 a.MS_LOCATION MS_LOCATION
, COUNT ( DISTINCT CALLER_SUBR ) MSISDN_COUNT
, SUM (CASE WHEN  a.CALL_TYPE = 'Entrant' AND TERM_TYPE <>  '0' THEN 1 ELSE 0 END ) FAIL_IN
, SUM (CASE WHEN  a.CALL_TYPE = 'Sortant' AND TERM_TYPE <>  '0' THEN 1 ELSE 0 END ) FAIL_OUT
, SUM (CASE WHEN  a.CALL_TYPE = 'Sortant' AND SUBSTR (USAGE_APPEL, 1, 3) <> 'SMS' THEN  NVL (DURATION, 0)   ELSE  0	END ) DUREE_SORTANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Sortant' AND SUBSTR (USAGE_APPEL, 1, 3) <> 'SMS' THEN  1   ELSE  0	END ) NBRE_TEL_SORTANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Entrant' AND SUBSTR (USAGE_APPEL, 1, 3) <> 'SMS' THEN  NVL (DURATION, 0)   ELSE  0	END ) DUREE_ENTRANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Entrant' AND SUBSTR (USAGE_APPEL, 1, 3) <> 'SMS' THEN  1   ELSE  0	END ) NBRE_TEL_ENTRANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Sortant' AND SUBSTR (USAGE_APPEL, 1, 3) = 'SMS' THEN  1   ELSE  0	END ) NBRE_SMS_SORTANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Entrant' AND SUBSTR (USAGE_APPEL, 1, 3) = 'SMS' THEN  1   ELSE  0	END ) NBRE_SMS_ENTRANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Sortant' AND SUBSTR (USAGE_APPEL, 1, 3) <> 'SMS'  THEN  NVL (DURATION, 0)   ELSE  0	END ) TOTAL_DUREE_SORTANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Entrant' AND SUBSTR (USAGE_APPEL, 1, 3) <> 'SMS'  THEN  NVL (DURATION, 0)   ELSE  0	END ) TOTAL_DUREE_ENTRANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Sortant' THEN  1   ELSE  0	END ) TOTAL_NBRE_SORTANT
, SUM (CASE WHEN  a.CALL_TYPE = 'Entrant' THEN  1   ELSE  0	END ) TOTAL_NBRE_ENTRANT
, current_timestamp  REFRESH_DATE
, Operator_code
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'MTN' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_MTN_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'CAMTEL' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_CAMTEL_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'OCM' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_OCM_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'MTN' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_MTN_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'CAMTEL' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_CAMTEL_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'OCM' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_OCM_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'MTN' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_MTN_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'CAMTEL' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_CAMTEL_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'OCM' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_OCM_SORTANT
, SUM (CASE    WHEN  a.PARTNER_GT = '937' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_ZEBRA_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'MTN' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_MTN_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'CAMTEL' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_CAMTEL_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'OCM' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_OCM_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'MTN' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_MTN_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'CAMTEL' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_CAMTEL_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'OCM' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_OCM_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'MTN' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_MTN_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'CAMTEL' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_CAMTEL_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'OCM' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_OCM_ENTRANT
, SUM (CASE    WHEN  a.PARTNER_GT = '937' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_ZEBRA_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'VIETTEL' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_NEXTTEL_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'VIETTEL' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_NEXTTEL_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'VIETTEL' and a.CALL_TYPE = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_NEXTTEL_SORTANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'VIETTEL' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_NEXTTEL_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'VIETTEL' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_NEXTTEL_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) = 'VIETTEL' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_NEXTTEL_ENTRANT
, profile_name
, contract_type
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) like '%INTERNATIONAL%' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  DURATION   ELSE  0    END ) DUREE_TEL_INTERN_ENTRANT
, SUM (CASE    WHEN  FN_NNP_SIMPLE_DESTINATION (a.PARTNER_GT) like '%INTERNATIONAL%' and a.CALL_TYPE = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_INTERN_ENTRANT
,'###SLICE_VALUE###' AS EVENT_DATE
FROM
(
SELECT
TRANSACTION_DATE sdate
, SERVED_MSISDN CALLER_SUBR
, PARTNER_GT
, TRANSACTION_TYPE
, fn_get_operator_code(served_msisdn) Operator_code
, TRANSACTION_TYPE USAGE_APPEL
, TRANSACTION_DIRECTION CALL_TYPE
, a.SERVED_PARTY_LOCATION MS_LOCATION
, TRANSACTION_TERM_CODE TERM_TYPE
, TRANSACTION_DURATION DURATION
, b.PROFILE
, upper(nvl(c.profile_name, c.profile_code)) profile_name
, upper(c.contract_type) contract_type
FROM
mon.SPARK_FT_MSC_TRANSACTION a
left join mon.SPARK_ft_contract_snapshot b on b.event_date = '###SLICE_VALUE###' and a.SERVED_MSISDN = b.ACCESS_KEY
left join DIM.DT_OFFER_PROFILES c on upper(b.PROFILE) = upper(c.PROFILE_CODE)
WHERE
TRANSACTION_DATE  = '###SLICE_VALUE###'
) a
GROUP BY
SDATE
, a.MS_LOCATION
, Operator_code
, profile_name
, contract_type