
INSERT INTO MON.SPARK_FT_DATA_CONSO_MSISDN_DAY_POST


SELECT
    a.CHARGED_PARTY_MSISDN  MSISDN,
    MAX (a.SERVED_PARTY_OFFER) COMMERCIAL_OFFER,
    SUM(NVL(BYTES_SENT, 0)) BYTES_SENT,
    SUM(NVL(BYTES_RECEIVED, 0)) BYTES_RECEIVED,
    SUM(CASE WHEN NVL(BUNDLE_MMS_USED_VOLUME, 0) > 0 THEN 1 ELSE 0 END) MMS_COUNT,
    SUM(CASE WHEN NVL(SDP_GOS_SERV_NAME, 'NOT_GOS') = 'NOT_GOS' THEN NVL(MAIN_COST, 0) ELSE 0 END) MAIN_RATED_AMOUNT ,
    SUM(NVL(PROMO_COST, 0)) PROMO_RATED_AMOUNT,
    MAX(SERVED_PARTY_IMSI) SERVED_PARTY_IMSI,
    MAX(SERVED_PARTY_IMEI) SERVED_PARTY_IMEI,
    SUM(NVL(BUNDLE_BYTES_USED_VOLUME, 0)) BYTES_USED_IN_BUNDLE,
    SUM(NVL(TOTAL_UNIT, 0) - NVL(BUNDLE_BYTES_USED_VOLUME, 0)) BYTES_USED_OUT_BUNDLE,
    SUM(CASE WHEN NVL(ROAMING_INDICATOR, 0) = 1 THEN NVL(BUNDLE_BYTES_USED_VOLUME, 0) ELSE 0 END) BYTES_USED_IN_BUNDLE_ROAMING,
    SUM(CASE WHEN NVL(ROAMING_INDICATOR, 0) = 1 THEN NVL(BYTES_SENT, 0) + NVL(BYTES_RECEIVED, 0) - NVL(BUNDLE_BYTES_USED_VOLUME, 0) ELSE 0 END) BYTES_USED_OUT_BUNDLE_ROAMING,
    SUM(NVL(BUNDLE_MMS_USED_VOLUME, 0)) BUNDLE_MMS_USED_VOLUME,
    SUM(CASE WHEN NVL(ROAMING_INDICATOR, 0) = 1 THEN NVL(MAIN_COST, 0) ELSE 0 END) MAIN_RATED_AMOUNT_ROAMING,
    SUM(CASE WHEN NVL(ROAMING_INDICATOR, 0) = 1 THEN NVL(PROMO_COST, 0) ELSE 0 END) PROMO_RATED_AMOUNT_ROAMING,
    SUM(CASE WHEN UPPER(SERVICE_CODE) LIKE '%GOS%SDP%DEBIT%' THEN 1 ELSE 0 END) GOS_DEBIT_COUNT,
    SUM(CASE WHEN UPPER(SERVICE_CODE) LIKE '%GOS%SDP%SESSION%' THEN 1 ELSE 0 END) GOS_SESSION_COUNT,
    SUM(CASE WHEN UPPER(SERVICE_CODE) LIKE '%GOS%SDP%REFUND%' THEN 1 ELSE 0 END) GOS_REFUND_COUNT,
    SUM(CASE WHEN UPPER(SERVICE_CODE) LIKE '%GOS%SDP%DEBIT%' THEN NVL(MAIN_COST, 0) ELSE 0 END) GOS_DEBIT_AMOUNT,
    SUM(CASE WHEN UPPER(SERVICE_CODE) LIKE '%GOS%SDP%SESSION%' THEN NVL(MAIN_COST, 0) ELSE 0 END) GOS_SESSION_AMOUNT,
    SUM(CASE WHEN UPPER(SERVICE_CODE) LIKE '%GOS%SDP%REFUND%' THEN NVL(MAIN_COST, 0) ELSE 0 END) GOS_REFUND_AMOUNT,
    SUM(NVL(BUNDLE_BYTES_REMAINING_VOLUME, 0)) BUNDLE_BYTES_REMAINING_VOLUME,
    SUM(NVL(BUNDLE_MMS_REMAINING_VOLUME, 0)) BUNDLE_MMS_REMAINING_VOLUME,
    'FT_CRA_GPRS_POST' SRC_TABLE,
    OPERATOR_CODE,
    sum( case when USED_BALANCE_LIST = 'MAIN BALANCE|||' and total_cost = 0 then bytes_received+bytes_sent end) Throttling_Vol,
    CURRENT_TIMESTAMP INSERT_DATE,
    '###SLICE_VALUE###' EVENT_DATE

FROM MON.SPARK_FT_CRA_GPRS_POST a
WHERE SESSION_DATE ='###SLICE_VALUE###' AND NVL(MAIN_COST, 0) >= 0

GROUP BY
a.CHARGED_PARTY_MSISDN,
'FT_CRA_GPRS_POST',
OPERATOR_CODE,
CURRENT_TIMESTAMP,
'###SLICE_VALUE###'