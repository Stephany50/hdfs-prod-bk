INSERT INTO MON.SPARK_FT_TRANSFERT_P2P
SELECT T.REFILL_DATE
,P.COMMERCIAL_OFFER
,DATE_FORMAT(TO_DATE(FROM_UNIXTIME(UNIX_TIMESTAMP(SUBSTRING (t.REFILL_DATE, -12, 8),'yyyyMMdd'))), 'yyyy-MM') MONTH
,P.OSP_CONTRACT_TYPE
,SUM(T.TRANSFER_VOLUME) MONTANT_TRANSFER
,SUM (T.TRANSFER_FEES) MONTANT_FRAIS
,COUNT(T.SENDER_MSISDN) NOMBRE,D.SEGMENTATION
FROM MON.SPARK_FT_CREDIT_TRANSFER T
LEFT JOIN MON.SPARK_FT_CONTRACT_SNAPSHOT P
ON T.SENDER_MSISDN=P.ACCESS_KEY
LEFT JOIN  DIM.DT_OFFER_PROFILES D
ON UPPER(P.COMMERCIAL_OFFER) = D.PROFILE_CODE
WHERE T.REFILL_DATE BETWEEN add_months(CONCAT(SUBSTRING('###SLICE_VALUE###',0,7),'-','01'),-1)+1 and ###SLICE_VALUE###
AND EVENT_DATE=add_months(CONCAT(SUBSTRING('###SLICE_VALUE###',0,7),'-','01'),-1)+1
AND T.TERMINATION_IND='000'
GROUP BY  T.REFILL_DATE,P.COMMERCIAL_OFFER,P.OSP_CONTRACT_TYPE,D.SEGMENTATION,DATE_FORMAT(TO_DATE(FROM_UNIXTIME(UNIX_TIMESTAMP(SUBSTRING (t.REFILL_DATE, -12, 8),'yyyyMMdd'))), 'yyyy-MM');