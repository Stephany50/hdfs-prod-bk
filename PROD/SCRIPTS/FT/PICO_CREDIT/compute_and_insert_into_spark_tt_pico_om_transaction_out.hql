INSERT INTO TABLE MON.SPARK_TT_PICO_KPIS PARTITION(EVENT_MONTH)
SELECT
    split(valeur_colonne,'[|]')[0] KPI
    ,sender_msisdn MSISDN
    ,NVL(split(valeur_colonne,'[|]')[1], 0) VAL
    ,CURRENT_TIMESTAMP INSERT_DATE
    ,'###SLICE_VALUE###' EVENT_MONTH
FROM
(
  select
    sender_msisdn,
    sum(
    case when service_type='CASHOUT' and (substr(sender_category_code, 0, 3)='B2W' or substr(sender_domain_code, 0, 3)='B2W')
    then transaction_amount
    else 0 end
    ) OM_BANK_TRF_AMT,
    sum(
    case when service_type='CASHOUT' and (substr(sender_category_code, 0, 3)='B2W' or substr(sender_domain_code, 0, 3)='B2W')
    then 1
    else 0 end
    ) OM_BANK_TRF_QTY,
    sum(
    case when service_type='RC'
    then transaction_amount
    else 0 end
    ) OM_INC_AMT,
    sum(
    case when service_type='RC'
    then 1
    else 0 end
    ) OM_INC_QTY,
    sum(
    case when service_type='MERCHPAY' and receiver_msisdn in ('691202290','691203011','691210767','691211294','691211300','691211384','691211407','691211426','691211457','691212249','691212442','691300807','691633320','691724958','691017480','691724967','691961236','691972383','691013822','691673659','697578544','655578850','691568039','696518674','656974923','655987452','695574764','695109901','693264943','698869548','656330712','656963493','698505275','656966808','656589950','697259779','655574506','655575025','655415494','655574762','656812877','656313094','656933711','693423524','656079791','697768586','698000338','656292871','695133960','695952904','656927123','655989215','698454763','656425506','694554270','655864487','656941109','698370593','656313556','695497312','698975730','656204130','655610673','655780847','656131945','655533935','693411825','699729740','693632072','656289146','693358501','695841143','693301789','656181836','699814962','656675448','656833485','693242352','656864091','699086407','694923436','656940781','656172832','695325647','698066666','658101010','658121212','691724895','693801855','691110998','692036620','692051908','692051896','692050772','692051906','692050771','692050743','692050744','691300986','691300913','691300916','691300888','691300902','692052024','692052043','692052045','692052046','692051548','692052056','692052093','692052098','692052112','692052113','692052119','692052137','692052138','692052159','692052172','692053554','692053514','692053515','692053527','692053524','692053533','692053553','692053562','692053564','692053578','692251953','692228083','692015704','692000911','692000988','655844658','656907599','695846041','655578102','656230098','694056170','656300836','696844033','698161416')
    then transaction_amount
    else 0 end
    ) OM_B2C_RECV_AMT,
    sum(
    case when service_type='MERCHPAY' and receiver_msisdn in ('691202290','691203011','691210767','691211294','691211300','691211384','691211407','691211426','691211457','691212249','691212442','691300807','691633320','691724958','691017480','691724967','691961236','691972383','691013822','691673659','697578544','655578850','691568039','696518674','656974923','655987452','695574764','695109901','693264943','698869548','656330712','656963493','698505275','656966808','656589950','697259779','655574506','655575025','655415494','655574762','656812877','656313094','656933711','693423524','656079791','697768586','698000338','656292871','695133960','695952904','656927123','655989215','698454763','656425506','694554270','655864487','656941109','698370593','656313556','695497312','698975730','656204130','655610673','655780847','656131945','655533935','693411825','699729740','693632072','656289146','693358501','695841143','693301789','656181836','699814962','656675448','656833485','693242352','656864091','699086407','694923436','656940781','656172832','695325647','698066666','658101010','658121212','691724895','693801855','691110998','692036620','692051908','692051896','692050772','692051906','692050771','692050743','692050744','691300986','691300913','691300916','691300888','691300902','692052024','692052043','692052045','692052046','692051548','692052056','692052093','692052098','692052112','692052113','692052119','692052137','692052138','692052159','692052172','692053554','692053514','692053515','692053527','692053524','692053533','692053553','692053562','692053564','692053578','692251953','692228083','692015704','692000911','692000988','655844658','656907599','695846041','655578102','656230098','694056170','656300836','696844033','698161416')
    then 1
    else 0 end
    ) OM_B2C_RECV_QTY
  from cdr.spark_it_omny_transactions
  where transfer_datetime like '###SLICE_VALUE###%'
  group by sender_msisdn
) T lateral view explode(split(concat_ws(',', concat('OM_BANK_TRF_AMT|', OM_BANK_TRF_AMT), concat('OM_BANK_TRF_QTY|', OM_BANK_TRF_QTY), concat('OM_INC_AMT|', OM_INC_AMT), concat('OM_INC_QTY|', OM_INC_QTY), concat('OM_B2C_RECV_AMT|', OM_B2C_RECV_AMT), concat('OM_B2C_RECV_QTY|', OM_B2C_RECV_QTY)),',')) valeur_colonne AS valeur_colonne
