 CREATE TABLE if not exists DIM.DT_BASE_IDENTIFICATION
(
    MSISDN                    VARCHAR(4000),
    NOM                       VARCHAR(100),
    PRENOM                    VARCHAR(100),
    NEE_LE                    date,
    NEE_A                     VARCHAR(100),
    PROFESSION                VARCHAR(150),
    QUARTIER_RESIDENCE        VARCHAR(150),
    VILLE_VILLAGE             VARCHAR(100),
    CNI                       VARCHAR(150),
    DATE_IDENTIFICATION       VARCHAR(100),
    TYPE_DOCUMENT             VARCHAR(4000),
    FICHIER_CHARGEMENT        VARCHAR(150),
    DATE_INSERTION            VARCHAR(100),
    EST_SNAPPE                VARCHAR(10),
    IDENTIFICATEUR            VARCHAR(100),
    DATE_MISE_A_JOUR          VARCHAR(100),
    DATE_TABLE_MIS_A_JOUR     VARCHAR(100),
    GENRE                     VARCHAR(10),
    CIVILITE                  VARCHAR(15),
    TYPE_PIECE_IDENTIFICATION VARCHAR(50),
    PROFESSION_IDENTIFICATEUR VARCHAR(100),
    MOTIF_REJET               VARCHAR(100)
)
STORED AS ORC TBLPROPERTIES ('transactional'='true',"orc.compress"="ZLIB","orc.stripe.size"="67108864");

;
INSERT INTO DIM.DT_BASE_IDENTIFICATION select
    MSISDN,
    NOM,
    PRENOM,
    NEE_LE,
    NEE_A,
    PROFESSION,
    QUARTIER_RESIDENCE,
    VILLE_VILLAGE,
    CNI,
    DATE_IDENTIFICATION,
    TYPE_DOCUMENT,
    FICHIER_CHARGEMENT,
    DATE_INSERTION,
    EST_SNAPPE,
    IDENTIFICATEUR,
    DATE_MISE_A_JOUR,
    DATE_TABLE_MIS_A_JOUR,
    GENRE,
    CIVILITE,
    TYPE_PIECE_IDENTIFICATION,
    PROFESSION_IDENTIFICATEUR,
    MOTIF_REJET
from MON.backup_DT_BASE_IDENTIFICATION where processing_date='2019-09-04'


SELECT 
    MSISDN
    ,NOM
    ,PRENOM
    ,NEE_LE
    ,NEE_A
    ,PROFESSION
    ,QUARTIER_RESIDENCE
    ,VILLE_VILLAGE
    ,CNI
    ,DATE_IDENTIFICATION
    ,TYPE_DOCUMENT
    ,FICHIER_CHARGEMENT
    --,DATE_INSERTION
    ,EST_SNAPPE --NO OK
    ,IDENTIFICATEUR
    --,DATE_MISE_A_JOUR
    --,DATE_TABLE_MIS_A_JOUR
    ,GENRE
    ,CIVILITE
    ,TYPE_PIECE_IDENTIFICATION
    ,PROFESSION_IDENTIFICATEUR
    ,MOTIF_REJET --NOK 
    ,COUNT(*) COUNTER
FROM (
  SELECT DISTINCT
    MSISDN
    ,NOM
    ,PRENOM
    ,to_date(NEE_LE) NEE_LE
    ,NEE_A
    ,PROFESSION
    ,QUARTIER_RESIDENCE
    ,VILLE_VILLAGE
    ,CNI
    ,to_date(DATE_IDENTIFICATION) DATE_IDENTIFICATION
    ,TYPE_DOCUMENT
    ,FICHIER_CHARGEMENT
    ,to_date(DATE_INSERTION) DATE_INSERTION
    ,EST_SNAPPE --NO OK
    ,IDENTIFICATEUR
    ,TO_DATE(DATE_MISE_A_JOUR) DATE_MISE_A_JOUR
    --,DATE_TABLE_MIS_A_JOUR
    ,GENRE
    ,CIVILITE
    ,TYPE_PIECE_IDENTIFICATION
    ,PROFESSION_IDENTIFICATEUR
    ,MOTIF_REJET --NOK 
  FROM dim.dt_base_identification4
  UNION ALL
  SELECT DISTINCT
    MSISDN
    ,NOM
    ,PRENOM
    ,to_date(NEE_LE) NEE_LE
    ,NEE_A
    ,PROFESSION
    ,QUARTIER_RESIDENCE
    ,VILLE_VILLAGE
    ,CNI
    ,to_date(DATE_IDENTIFICATION) DATE_IDENTIFICATION
    ,TYPE_DOCUMENT
    ,FICHIER_CHARGEMENT
    ,to_date(DATE_INSERTION) DATE_INSERTION
    ,EST_SNAPPE --NO OK
    ,IDENTIFICATEUR
    ,TO_DATE(DATE_MISE_A_JOUR) DATE_MISE_A_JOUR
    --,DATE_TABLE_MIS_A_JOUR
    ,GENRE
    ,CIVILITE
    ,TYPE_PIECE_IDENTIFICATION
    ,PROFESSION_IDENTIFICATEUR
    ,MOTIF_REJET --NOK 
  from backup_dwh.DT_BASE_IDENTIFICATION2 
)G
GROUP BY
    MSISDN
    ,NOM
    ,PRENOM
    ,NEE_LE
    ,NEE_A
    ,PROFESSION
    ,QUARTIER_RESIDENCE
    ,VILLE_VILLAGE
    ,CNI
    ,DATE_IDENTIFICATION
    ,TYPE_DOCUMENT
    ,FICHIER_CHARGEMENT
    --,DATE_INSERTION
    ,EST_SNAPPE --NO OK
    ,IDENTIFICATEUR
    --,DATE_MISE_A_JOUR
    --,DATE_TABLE_MIS_A_JOUR
    ,GENRE
    ,CIVILITE
    ,TYPE_PIECE_IDENTIFICATION
    ,PROFESSION_IDENTIFICATEUR
    ,MOTIF_REJET --NOK 
HAVING COUNTER =1
ORDER BY 
    MSISDN
    ,NOM
    ,PRENOM
    ,NEE_LE
    ,NEE_A
    ,PROFESSION
    ,QUARTIER_RESIDENCE
    ,VILLE_VILLAGE
    ,CNI
    ,DATE_IDENTIFICATION
    ,TYPE_DOCUMENT
    ,FICHIER_CHARGEMENT
    --,DATE_INSERTION
    ,EST_SNAPPE --NO OK
    ,IDENTIFICATEUR
    --,DATE_MISE_A_JOUR
    --,DATE_TABLE_MIS_A_JOUR
    ,GENRE
    ,CIVILITE
    ,TYPE_PIECE_IDENTIFICATION
    ,PROFESSION_IDENTIFICATEUR
    ,MOTIF_REJET --NOK 


-- LES NUMEROS DE IT_CLIENT_SNAP_DIRECTORY QUI NE SONT PAS DANS LA DIM


SELECT count(DISTINCT A.MSISDN ) FROM (SELECT MSISDN FROM TMP.IT_CLIENT_SNAPID_DIRECTORY WHERE ORIGINAL_FILE_DATE >= DATE_SUB('2019-08-27',30)  and ORIGINAL_FILE_DATE<='2019-08-27') A
LEFT JOIN DIM.DT_BASE_IDENTIFICATION B ON A.MSISDN=B.MSISDN
WHERE B.MSISDN IS NULL LIMIT 10
2002

--VERIFICATION DANS LA DIM DU 29
SELECT DISTINCT A.MSISDN  FROM (SELECT MSISDN FROM TMP.IT_CLIENT_SNAPID_DIRECTORY WHERE ORIGINAL_FILE_DATE >= DATE_SUB('2019-08-27',30) and ORIGINAL_FILE_DATE<='2019-08-27') A
LEFT JOIN (select distinct msisdn from mon.backup_DT_BASE_IDENTIFICATION where backup_date='2019-08-29') B ON A.MSISDN=B.MSISDN
WHERE B.MSISDN IS NULL LIMIT 10


SELECT DISTINCT A.MSISDN  FROM (SELECT MSISDN FROM TMP.IT_CLIENT_SNAPID_DIRECTORY WHERE ORIGINAL_FILE_DATE >= DATE_SUB('2019-08-27',30) and ORIGINAL_FILE_DATE<='2019-08-27') A
LEFT JOIN (select distinct msisdn from mon.backup_DT_BASE_IDENTIFICATION where backup_date='2019-08-29') B ON A.MSISDN=B.MSISDN
WHERE B.MSISDN IS NULL LIMIT 10


1000
SELECT count(DISTINCT A.MSISDN ) FROM DATALAB.TT_IDENTIFICATION_MSISDN A
LEFT JOIN (select distinct msisdn from mon.backup_DT_BASE_IDENTIFICATION where backup_date='2019-08-28') B ON A.MSISDN=B.MSISDN
WHERE B.MSISDN IS NULL LIMIT 10




1000
SELECT DISTINCT A.MSISDN FROM DIM.DT_BASE_IDENTIFICATION A
LEFT JOIN (select distinct msisdn from mon.backup_DT_BASE_IDENTIFICATION where backup_date='2019-09-04') B ON A.MSISDN=B.MSISDN
WHERE B.MSISDN IS NULL LIMIT 10


SELECT DISTINCT A.MSISDN FROM (select distinct msisdn from mon.backup_DT_BASE_IDENTIFICATION where backup_date='2019-09-05') A
LEFT JOIN  DIM.DT_BASE_IDENTIFICATION B ON A.MSISDN=B.MSISDN
WHERE B.MSISDN IS NULL LIMIT 10


select distinct a.msisdn from(select * from mon.backup_DT_BASE_IDENTIFICATION where backup_date='2019-08-29') a
LEFT JOIN (select distinct msisdn from mon.backup_DT_BASE_IDENTIFICATION where backup_date='2019-08-28') B on A.MSISDN=B.MSISDN
left join  (SELECT MSISDN FROM TMP.IT_CLIENT_SNAPID_DIRECTORY WHERE ORIGINAL_FILE_DATE >= DATE_SUB('2019-08-27',30)  and ORIGINAL_FILE_DATE<='2019-08-29')c on A.MSISDN=c.MSISDN
 where B.MSISDN IS NULL and c.MSISDN is null limit 10

| 2019-08-26   | 12951629  |
| 2019-08-27   | 12956025  |
| 2019-08-29   | 12961402  |
| 2019-08-28   | 12958824  |

-- les numeros qui sont dans nomad et pas dans dim
SELECT count(DISTINCT A.MSISDN ) FROM (SELECT TELEPHONE MSISDN from TMP.TT_NOMAD_STATUT_DIRECTORY
  where
    original_file_date = DATE_ADD('2019-08-27',1)
    and TYPEDECONTRAT='Nouvel Abonnement'
    and  ETATDEXPORTGLOBAL ='SUCCESS'
    and LOGINVENDEUR not in ('testfo','NKOLBONG','testve')) A
LEFT JOIN (select distinct msisdn from mon.backup_DT_BASE_IDENTIFICATION where backup_date='2019-08-29') B ON A.MSISDN=B.MSISDN
WHERE B.MSISDN IS NULL LIMIT 10



SELECT count(DISTINCT A.MSISDN) FROM(SELECT MSISDN FROM TMP.IT_CLIENT_SNAPID_DIRECTORY WHERE ORIGINAL_FILE_DATE >= DATE_SUB('2019-08-28',30) and ORIGINAL_FILE_DATE<='2019-08-28') A
LEFT JOIN (SELECT DISTINCT MSISDN FROM MON.BACKUP_DT_BASE_IDENTIFICATION where backup_date='2019-08-29') B ON A.MSISDN=B.MSISDN
WHERE B.MSISDN IS NULL LIMIT 10;



