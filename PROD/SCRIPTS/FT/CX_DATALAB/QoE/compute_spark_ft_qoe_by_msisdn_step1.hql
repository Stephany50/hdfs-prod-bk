-- Correction de la localisation du traffic par region + Msisdn
drop table TMP.KYC_CEM_INDICATEURS_LOCALISES;
create table TMP.KYC_CEM_INDICATEURS_LOCALISES AS
select TECHNOLOGIE,
(case when b.depart is not null and b.region is not null then upper(b.region)
when c.site_n is not null and c.region is not null then upper(c.region)
when upper(a.nom_site) like "%CTR%" then "CENTRE"
when upper(a.nom_site) like "%LIT%" then "LITTORAL"
when upper(a.nom_site) like "%OST%" then "OUEST"
when upper(a.nom_site) like "%EXN%" then "EXTREME-NORD"
when upper(a.nom_site) like "%SUO%" then "SUD-OUEST"
when upper(a.nom_site) like "%SUD%" then "SUD"
when upper(a.nom_site) like "%EST%" then "EST"
when upper(a.nom_site) like "%ADM%" then "ADAMAOUA"
when upper(a.nom_site) like "%NRO%" then "NORD-OUEST"
when upper(a.nom_site) like "%NRD%" then "NORD"
else upper(a.NOM_REGION)
 end) REGION,NOM_SITE,LATITUDE_DEC,LONGITUDE_DEC,PSDATE,MSISDN,
TCINITALL,
TCKOALL,
TCKODCALL,
OCINITALL,
OCKOALL,
OCKODCALL,
SMSMTOKALL,
SMSMTKOALL,
SMSMOKOALL,
SMSMOOKALL,
TCPSESSIONOKWEB,
TCPSESSIONOKVOIP,
TCPSESSIONOKDOWN,
TCPSESSIONOKSTREAM,
TCPSESSIONKODOWN,
TCPSESSIONKOSTREAM,
TCPSESSIONKOWEB,
TCPSESSIONKOVOIP,
LATTCPSESSIONOKDOWN,
LATTCPSESSIONOKSTREAM,
LATTCPSESSIONOKVOIP,
LATTCPSESSIONOKWEB,
LATTCPSESSIONKODOWN,
LATTCPSESSIONKOSTREAM,
LATTCPSESSIONKOVOIP,
LATTCPSESSIONKOWEB
from (SELECT TECHNOLOGIE,PSDATE,MSISDN,
UPPER((translate(nvl(lower(NOM_REGION),"UNKNOWN"), "áêéíóúê-", "aeioue  "))) NOM_REGION,
UPPER((translate(nvl(lower(NOM_SITE),"UNKNOWN"), "áêéíóúê-", "aeioue  "))) NOM_SITE,MSISDN,
(case when  cast(LATITUDE_DEC as float) > cast(LONGITUDE_DEC as float) then LONGITUDE_DEC else LATITUDE_DEC end) LATITUDE_DEC,
(case when cast(LATITUDE_DEC as float) > cast(LONGITUDE_DEC as float) then LATITUDE_DEC else LONGITUDE_DEC end) LONGITUDE_DEC,
sum(nvl(TCINITALL,0)) TCINITALL,
sum(nvl(TCKOALL,0)) TCKOALL,
sum(nvl(TCKODCALL,0)) TCKODCALL,
sum(nvl(OCINITALL,0)) OCINITALL,
sum(nvl(OCKOALL,0)) OCKOALL,
sum(nvl(OCKODCALL,0)) OCKODCALL,
sum(nvl(SMSMTOKALL,0)) SMSMTOKALL,
sum(nvl(SMSMTKOALL,0)) SMSMTKOALL,
sum(nvl(SMSMOKOALL,0)) SMSMOKOALL,
sum(nvl(SMSMOOKALL,0)) SMSMOOKALL,
sum(nvl(TCPSESSIONOKWEB,0)) TCPSESSIONOKWEB,
sum(nvl(TCPSESSIONOKVOIP,0)) TCPSESSIONOKVOIP,
sum(nvl(TCPSESSIONOKDOWN,0)) TCPSESSIONOKDOWN,
sum(nvl(TCPSESSIONOKSTREAM,0)) TCPSESSIONOKSTREAM,
sum(nvl(TCPSESSIONKODOWN,0)) TCPSESSIONKODOWN,
sum(nvl(TCPSESSIONKOSTREAM,0)) TCPSESSIONKOSTREAM,
sum(nvl(TCPSESSIONKOWEB,0)) TCPSESSIONKOWEB,
sum(nvl(TCPSESSIONKOVOIP,0)) TCPSESSIONKOVOIP,
sum(nvl(LATTCPSESSIONOKDOWN,0)) LATTCPSESSIONOKDOWN,
sum(nvl(LATTCPSESSIONOKSTREAM,0)) LATTCPSESSIONOKSTREAM,
sum(nvl(LATTCPSESSIONOKVOIP,0)) LATTCPSESSIONOKVOIP,
sum(nvl(LATTCPSESSIONOKWEB,0)) LATTCPSESSIONOKWEB,
sum(nvl(LATTCPSESSIONKODOWN,0)) LATTCPSESSIONKODOWN,
sum(nvl(LATTCPSESSIONKOSTREAM,0)) LATTCPSESSIONKOSTREAM,
sum(nvl(LATTCPSESSIONKOVOIP,0)) LATTCPSESSIONKOVOIP,
sum(nvl(LATTCPSESSIONKOWEB,0)) LATTCPSESSIONKOWEB
from TMP.CX_CEM_INDICATEURS GROUP BY
TECHNOLOGIE,PSDATE,MSISDN,
UPPER((translate(nvl(lower(NOM_REGION),"UNKNOWN"), "áêéíóúê-", "aeioue  "))),
UPPER((translate(nvl(lower(NOM_SITE),"UNKNOWN"), "áêéíóúê-", "aeioue  "))),
LATITUDE_DEC,LONGITUDE_DEC) a
left join TMP.KYC_CELLS_CODE_DEPT b on upper(a.NOM_REGION)=upper(b.depart)
left join TMP.KYC_CELLS_CODE_SITE c on upper(a.nom_site) = upper(c.site_n);



---Calcul de certain indicateurs

--- #Calcul de la QoE Globale
select
QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.KYC_CEM_INDICATEURS_LOCALISES);

---#Calcul du taux de drop call
select
100*(sum(nvl(OCKODCALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) DROP_CALL
from TMP.KYC_CEM_INDICATEURS_LOCALISES ;


---#Calcul de la QoE par Technologie
select
TECHNOLOGIE,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select TECHNOLOGIE,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.KYC_CEM_INDICATEURS_LOCALISES where to_date(from_unixtime(unix_timestamp(psdate , 'dd/MM/yyyy'))) >= to_date("2022-11-10")
and to_date(from_unixtime(unix_timestamp(psdate , 'dd/MM/yyyy'))) <= to_date("2022-11-18")
group by TECHNOLOGIE);

---#Calcul de la QoE par region
select
region,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select region,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.KYC_CEM_INDICATEURS_LOCALISES
group by region);

---#Calcul de la QoE par Site
select
NOM_SITE,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select NOM_SITE,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.KYC_CEM_INDICATEURS_LOCALISES
group by NOM_SITE);


---#QoE globale + Data, Voix,sms par technologie et site
select
technologie,region,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select technologie,region,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.KYC_CEM_INDICATEURS_LOCALISES where to_date(from_unixtime(unix_timestamp(psdate , 'dd/MM/yyyy'))) >= to_date("2022-11-10")
and to_date(from_unixtime(unix_timestamp(psdate , 'dd/MM/yyyy'))) <= to_date("2022-11-18")
group by technologie,region order by technologie);


--- #Qoe pour un user par techno
select
TECHNOLOGIE,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select TECHNOLOGIE,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.KYC_CEM_INDICATEURS_LOCALISES where MSISDN="699947860" group by TECHNOLOGIE);



--filtre des données sur le nom des site
drop table TMP.CXD_MSISDN_CHARLY;
create table TMP.CXD_MSISDN_CHARLY 
select
b.VILLE,
b.REGION REGION_BUS,
a.Technologie,
a.nom_site,
latitude_dec,
longitude_dec,
a.msisdn,
tcinitall,
tckoall,
tckodcall,
ocinitall,
ockoall,
ockodcall,
smsmtokall,
smsmtkoall,
smsmokoall,
smsmookall,
tcpsessionokweb,
tcpsessionokvoip,
tcpsessionokdown,
tcpsessionokstream,
tcpsessionkodown,
tcpsessionkostream,
tcpsessionkoweb,
tcpsessionkovoip,
lattcpsessionokdown,
lattcpsessionokstream,
lattcpsessionokvoip,
lattcpsessionokweb,
lattcpsessionkodown,
lattcpsessionkostream,
lattcpsessionkovoip,
lattcpsessionkoweb
from (select * from MON.SPARK_FT_CXD_CEM_INDICATEURS where event_date="2022-11-10") a
left join TMP.CX_MSISDN_CHARLY b on a.msisdn = b.msisdn;



select
TECHNOLOGIE,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select TECHNOLOGIE,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.CXD_MSISDN_CHARLY
group by TECHNOLOGIE);


select
VILLE,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select VILLE,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.CXD_MSISDN_CHARLY
group by VILLE);


select
nom_site,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select nom_site,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from  MON.SPARK_FT_CXD_CEM_INDICATEURS where event_date="2022-11-10"
group by nom_site);

select
region,QoE_SMS,QoE_VOICE,QoE_DATA,
((3*nvl(QoE_VOICE,0) + nvl(QoE_SMS,0) + 6*nvl(QoE_DATA,0))/10) QoE
from (select region,
100*(sum(nvl(SMSMOOKALL,0)+nvl(SMSMTOKALL,0))/sum(nvl(SMSMTOKALL,0)+nvl(SMSMOOKALL,0)+nvl(SMSMOKOALL,0)+nvl(SMSMTKOALL,0))) QoE_SMS,
100-100*(sum(nvl(OCKOALL,0)+nvl(OCKODCALL,0)+nvl(TCKOALL,0)+nvl(TCKODCALL,0))/sum(nvl(OCINITALL,0)+nvl(TCINITALL,0))) QoE_VOICE,
100*(sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONOKVOIP,0))/
sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)+nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0)+
nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0)+nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_DATA,
100*(sum(nvl(TCPSESSIONOKDOWN,0))/sum(nvl(TCPSESSIONOKDOWN,0)+nvl(TCPSESSIONKODOWN,0)))  QoE_DOWN,
100*(sum(nvl(TCPSESSIONOKSTREAM,0))/sum(nvl(TCPSESSIONOKSTREAM,0)+nvl(TCPSESSIONKOSTREAM,0))) QoE_STREAM,
100*(sum(nvl(LATTCPSESSIONOKWEB,0))/sum(nvl(LATTCPSESSIONOKWEB,0)+nvl(LATTCPSESSIONKOWEB,0))) QoE_WEB,
100*(sum(nvl(LATTCPSESSIONOKVOIP,0))/sum(nvl(LATTCPSESSIONOKVOIP,0)+nvl(LATTCPSESSIONKOVOIP,0))) QoE_VOIP
from TMP.KYC_CEM_INDICATEURS_LOCALISES  where to_date(from_unixtime(unix_timestamp(psdate , 'dd/MM/yyyy'))) >= to_date("2022-10-24")
and to_date(from_unixtime(unix_timestamp(psdate , 'dd/MM/yyyy'))) <= to_date("2022-10-30")
group by region);

select * from TMP.KYC_CEM_INDICATEURS_LOCALISES ; 

---Extraction des données séparé par des ;
---Table avec les colones 
drop table TMP.KYC_CEM_INDICATEURS_LOCALISES_CONCAT;
create table TMP.KYC_CEM_INDICATEURS_LOCALISES_CONCAT
select concat_ws("\;",*) fields from TMP.KYC_CEM_INDICATEURS_LOCALISES;



---TECHNOLOGIE;REGION;NOM_SITE;LATITUDE_DEC;LONGITUDE_DEC;PSDATE;MSISDN;TCINITALL;TCKOALL;TCKODCALL;OCINITALL;OCKOALL;OCKODCALL;SMSMTOKALL;SMSMTKOALL;SMSMOKOALL;SMSMOOKALL;TCPSESSIONOKWEB;TCPSESSIONOKVOIP;TCPSESSIONOKDOWN;TCPSESSIONOKSTREAM;TCPSESSIONKODOWN;TCPSESSIONKOSTREAM;TCPSESSIONKOWEB;TCPSESSIONKOVOIP;LATTCPSESSIONOKDOWN;LATTCPSESSIONOKSTREAM;LATTCPSESSIONOKVOIP;LATTCPSESSIONOKWEB;LATTCPSESSIONKODOWN;LATTCPSESSIONKOSTREAM;LATTCPSESSIONKOVOIP;LATTCPSESSIONKOWEB
hive --hiveconf tez.queue.name=compute --showHeader=false --outputFormat=csv2 -e "select * from TMP.KYC_CEM_INDICATEURS_LOCALISES_CONCAT" > CEM_QoE_CHARLY.csv 



