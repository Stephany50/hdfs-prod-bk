MERGE INTO TMP.SPARK_TT_FT_CBM_DOLA_DAILY S
USING ( SELECT  '###SLICE_VALUE###' EVENT_DATE,A.MSISDN, B.ACTIVATION_DATE, A.DOLA, A.ACTIVITY_TYPE,'' RGSX,C.REGION,C.TOWN,C.QUARTER 
FROM TMP.SPARK_TT_FT_CBM_DOLA_DAILY_PRE A
INNER JOIN    (SELECT ACCESS_KEY MSISDN,ACTIVATION_DATE 
        FROM MON.SPARK_FT_CONTRACT_SNAPSHOT
        WHERE EVENT_DATE = date_add('###SLICE_VALUE###', 1)
        ) B
        ON(A.MSISDN = B.MSISDN)
LEFT JOIN    (SELECT MSISDN,COMMERCIAL_REGION REGION  ,TOWNNAME TOWN,SITE_NAME QUARTER 
        FROM MON.SPARK_FT_CLIENT_LAST_SITE_DAY WHERE EVENT_DATE ='###SLICE_VALUE###') C
ON(A.MSISDN = C.MSISDN) 
) D
ON (S.MSISDN = D.MSISDN AND S.ACTIVITY_TYPE = D.ACTIVITY_TYPE)
WHEN MATCHED THEN 
UPDATE SET DOLA = D.DOLA, REGION = D.REGION, TOWN = D.TOWN, QUARTER = D.QUARTER                
WHEN NOT MATCHED THEN 
INSERT                
VALUES (D.EVENT_DATE,D.MSISDN,D.ACTIVATION_DATE,D.DOLA,NULL, D.ACTIVITY_TYPE,D.RGSX,D.REGION,D.TOWN,D.QUARTER,CURRENT_TIMESTAMP)
