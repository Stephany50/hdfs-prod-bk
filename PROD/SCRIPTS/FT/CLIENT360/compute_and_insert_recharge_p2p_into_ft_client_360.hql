CREATE TABLE tmp.msisdn_vue_360_3 AS
SELECT
    a.*,
    C2S_REFILL_COUNT,
    C2S_MAIN_REFILL_AMOUNT,
    C2S_PROMO_REFILL_AMOUNT,
    P2P_REFILL_COUNT,
    P2P_REFILL_AMOUNT,
    SCRATCH_REFILL_COUNT,
    SCRATCH_MAIN_REFILL_AMOUNT,
    SCRATCH_PROMO_REFILL_AMOUNT,
    P2P_REFILL_FEES
FROM tmp.msisdn_vue_360_2 a
LEFT JOIN
(
    SELECT
        NVL(a.MSISDN, b.MSISDN) AS MSISDN,
        NVL(C2S_REFILL_COUNT, 0) AS C2S_REFILL_COUNT,
        NVL(C2S_MAIN_REFILL_AMOUNT, 0) AS C2S_MAIN_REFILL_AMOUNT,
        NVL(C2S_PROMO_REFILL_AMOUNT, 0) AS C2S_PROMO_REFILL_AMOUNT,
        NVL(P2P_REFILL_COUNT, 0) AS P2P_REFILL_COUNT,
        NVL(P2P_REFILL_AMOUNT, 0) AS P2P_REFILL_AMOUNT,
        NVL(SCRATCH_REFILL_COUNT, 0) AS SCRATCH_REFILL_COUNT,
        NVL(SCRATCH_MAIN_REFILL_AMOUNT, 0) AS SCRATCH_MAIN_REFILL_AMOUNT,
        NVL(SCRATCH_PROMO_REFILL_AMOUNT, 0) AS SCRATCH_PROMO_REFILL_AMOUNT,
        NVL(P2P_REFILL_FEES, 0) AS P2P_REFILL_FEES
    FROM
    (
        --C2S et SCRATCH
        SELECT
            RECEIVER_MSISDN MSISDN
            ,SUM(CASE WHEN REFILL_MEAN='C2S' THEN 1 ELSE 0 END ) C2S_REFILL_COUNT
            ,SUM(CASE WHEN REFILL_MEAN='C2S' THEN REFILL_AMOUNT ELSE 0 END ) C2S_MAIN_REFILL_AMOUNT
            ,SUM(CASE WHEN REFILL_MEAN='C2S' THEN REFILL_BONUS ELSE 0 END ) C2S_PROMO_REFILL_AMOUNT
            ,SUM(CASE WHEN REFILL_MEAN='SCRATCH' THEN 1 ELSE 0 end ) SCRATCH_REFILL_COUNT
            ,SUM(CASE WHEN REFILL_MEAN='SCRATCH' THEN REFILL_AMOUNT ELSE 0 END ) SCRATCH_MAIN_REFILL_AMOUNT
            ,SUM(CASE WHEN REFILL_MEAN='SCRATCH' THEN REFILL_BONUS ELSE 0 END ) SCRATCH_PROMO_REFILL_AMOUNT
        FROM MON.FT_REFILL
        WHERE REFILL_DATE = '2019-10-04'
            AND TERMINATION_IND='200'
        GROUP BY RECEIVER_MSISDN
    ) a
    FULL JOIN
    (
        --P2P
        SELECT
            RECEIVER_MSISDN MSISDN
            ,COUNT(*) P2P_REFILL_COUNT
            ,SUM(TRANSFER_AMT) P2P_REFILL_AMOUNT
            ,SUM(TRANSFER_FEES) P2P_REFILL_FEES
        FROM MON.FT_CREDIT_TRANSFER
        WHERE REFILL_DATE = '2019-10-04'
            AND TERMINATION_IND='000'
        GROUP BY RECEIVER_MSISDN
    ) b ON a.MSISDN = b.MSISDN
)b ON a.MSISDN = b.MSISDN