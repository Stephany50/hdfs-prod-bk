INSERT INTO MON.SPARK_FT_SITE_360
SELECT
    CELL_NAME,
    CI,
    TECHNOLOGIE,

    LOC_SITE_NAME,
    LOC_TOWN_NAME,
    LOC_ADMINISTRATIVE_REGION,
    LOC_COMMERCIAL_REGION,
    LOC_ZONE_PMO,
    LOC_QUARTIER,
    LOC_ARRONDISSEMENT,
    LOC_DEPARTEMENT,
    LOC_SECTOR,

    NULL PARC_GROUPE,
    NULL PARC_ART,
    NULL PARC_ACTIF_PERIOD,
    NULL PARC_OM,
    DATA_USERS,
    NULL VOICE_USERS,

    NULL GROSS_ADD,

    NULL NBRE_CALL_BOX,
    NULL RUPTURE_STOCK,

    NULL NBRE_FAMOCO,

    NULL SMARTPHONES_3G,
    NULL SMARTPHONES_4G,

    NULL TOTAL_REVENUE,
    NULL TOTAL_VOICE_REVENUE,
    NULL TOTAL_SMS_REVENUE,
    NULL TOTAL_SUBS_REVENUE,
    NULL ROAM_IN_VOICE_REVENUE,
    NULL ROAM_OUT_VOICE_REVENUE,
    NULL ROAM_IN_SMS_REVENUE,
    NULL ROAM_OUT_SMS_REVENUE,
    ROAM_DATA_REVENUE,
    NULL MAIN_RATED_TEL_AMOUNT,
    NULL MAIN_RATED_TEL_OCM_AMOUNT,
    NULL MAIN_RATED_TEL_MTN_AMOUNT,
    NULL MAIN_RATED_TEL_NEXTTEL_AMOUNT,
    NULL MAIN_RATED_TEL_CAMTEL_AMOUNT,
    NULL MAIN_RATED_TEL_SET_AMOUNT,
    NULL MAIN_RATED_TEL_ROAM_IN_AMOUNT,
    NULL MAIN_RATED_TEL_ROAM_OUT_AMOUNT,
    NULL MAIN_RATED_TEL_SVA_AMOUNT,
    NULL MAIN_RATED_TEL_INT_AMOUNT,
    NULL MAIN_RATED_SMS_AMOUNT,
    DATA_MAIN_RATED_AMOUNT,
    DATA_GOS_MAIN_RATED_AMOUNT,
    DATA_ROAM_MAIN_RATED_AMOUNT,
    NULL DATA_VIA_OM,
    NULL AMOUNT_EMERGENCY_DATA,
    NULL REVENU_OM,

    C2S_REFILL_COUNT,
    C2S_MAIN_REFILL_AMOUNT,
    C2S_PROMO_REFILL_AMOUNT,
    P2P_REFILL_COUNT,
    P2P_REFILL_AMOUNT,
    SCRATCH_REFILL_COUNT,
    SCRATCH_MAIN_REFILL_AMOUNT,
    SCRATCH_PROMO_REFILL_AMOUNT,
    P2P_REFILL_FEES,
    NULL DATA_REFILL_FEES,
    NULL OM_REFILL_COUNT,
    NULL OM_REFILL_AMOUNT,

    NULL OG_RATED_CALL_DURATION,
    NULL OG_TOTAL_CALL_DURATION,
    NULL RATED_TEL_OCM_DURATION,
    NULL RATED_TEL_MTN_DURATION,
    NULL RATED_TEL_NEXTTEL_DURATION,
    NULL RATED_TEL_CAMTEL_DURATION,
    NULL RATED_TEL_SET_DURATION,
    NULL RATED_TEL_ROAM_IN_DURATION,
    NULL RATED_TEL_ROAM_OUT_DURATION,
    NULL RATED_TEL_SVA_DURATION,
    NULL RATED_TEL_INT_DURATION,

    NULL OG_SMS_TOTAL_COUNT,
    NULL OG_SMS_OCM_COUNT,
    NULL OG_SMS_MTN_COUNT,
    NULL OG_SMS_NEXTTEL_COUNT,
    NULL OG_SMS_CAMTEL_COUNT,
    NULL OG_SMS_SET_COUNT,
    NULL OG_SMS_ROAM_IN_COUNT,
    NULL OG_SMS_ROAM_OUT_COUNT,
    NULL OG_SMS_SVA_COUNT,
    NULL OG_SMS_INTERNATIONAL_COUNT,

    DATA_BYTES_RECEIVED,
    DATA_BYTES_SENT,
    DATA_BYTES_USED_IN_BUNDLE_ROAM,
    DATA_BYTES_USED_PAYGO_ROAM,

    CURRENT_TIMESTAMP() INSERT_DATE,
    '###SLICE_VALUE###' EVENT_DATE
FROM
(
    SELECT
        A.CI,
        A.CELL_NAME,
        A.LOC_SITE_NAME,
        A.LOC_TOWN_NAME,
        A.LOC_ADMINISTRATIVE_REGION,
        A.LOC_COMMERCIAL_REGION,
        A.LOC_ZONE_PMO,
        A.LOC_QUARTIER,
        A.LOC_ARRONDISSEMENT,
        A.LOC_DEPARTEMENT,
        A.LOC_SECTOR,
        A.TECHNOLOGIE,
        B.DATA_USERS,
        B.DATA_MAIN_RATED_AMOUNT,
        B.ROAM_DATA_REVENUE,
        B.DATA_GOS_MAIN_RATED_AMOUNT,
        B.DATA_ROAM_MAIN_RATED_AMOUNT,
        B.DATA_BYTES_SENT,
        B.DATA_BYTES_RECEIVED,
        B.DATA_BYTES_USED_IN_BUNDLE_ROAM,
        B.DATA_BYTES_USED_PAYGO_ROAM,
        C.C2S_REFILL_COUNT,
        C.C2S_MAIN_REFILL_AMOUNT,
        C.C2S_PROMO_REFILL_AMOUNT,
        C.P2P_REFILL_COUNT,
        C.P2P_REFILL_AMOUNT,
        C.SCRATCH_REFILL_COUNT,
        C.SCRATCH_MAIN_REFILL_AMOUNT,
        C.SCRATCH_PROMO_REFILL_AMOUNT,
        C.P2P_REFILL_FEES
    FROM
    (
        SELECT
            CI
            , SITE_NAME LOC_SITE_NAME
            , TOWNNAME LOC_TOWN_NAME
            , REGION LOC_ADMINISTRATIVE_REGION
            , COMMERCIAL_REGION LOC_COMMERCIAL_REGION
            , ZONEPMO LOC_ZONE_PMO
            , QUARTIER LOC_QUARTIER
            , ARRONDISSEMENT LOC_ARRONDISSEMENT
            , DEPARTEMENT LOC_DEPARTEMENT
            , SECTEUR LOC_SECTOR
            , TECHNOLOGIE
            , CELLNAME CELL_NAME
        FROM DIM.DT_GSM_CELL_CODE
    ) A
    LEFT JOIN
    (
        SELECT
            LOCATION_CI CI
            , COUNT(DISTINCT CHARGED_PARTY_MSISDN) DATA_USERS
            , SUM(CASE WHEN NVL(SDP_GOS_SERV_NAME, 'NOT_GOS') = 'NOT_GOS' THEN NVL(MAIN_COST, 0) ELSE 0 END) DATA_MAIN_RATED_AMOUNT
            , SUM(CASE WHEN NVL(ROAMING_INDICATOR, 0) = 1 THEN NVL(MAIN_COST, 0) ELSE 0 END) ROAM_DATA_REVENUE
            , SUM(CASE WHEN UPPER(SERVICE_CODE) LIKE '%GOS%SDP%' THEN NVL(MAIN_COST, 0) ELSE 0 END) DATA_GOS_MAIN_RATED_AMOUNT
            , SUM(CASE WHEN NVL(ROAMING_INDICATOR, 0) = 1 THEN NVL(MAIN_COST, 0) ELSE 0 END) DATA_ROAM_MAIN_RATED_AMOUNT 
            , SUM(NVL(BYTES_SENT, 0)) DATA_BYTES_SENT
            , SUM(NVL(BYTES_RECEIVED, 0)) DATA_BYTES_RECEIVED
            , SUM(CASE WHEN NVL(ROAMING_INDICATOR, 0) = 1 THEN NVL(BUNDLE_BYTES_USED_VOLUME, 0) ELSE 0 END) DATA_BYTES_USED_IN_BUNDLE_ROAM
            , SUM(CASE WHEN NVL(ROAMING_INDICATOR, 0) = 1 THEN NVL(BYTES_SENT, 0) + NVL(BYTES_RECEIVED, 0) - NVL(BUNDLE_BYTES_USED_VOLUME, 0) ELSE 0 END) DATA_BYTES_USED_PAYGO_ROAM
        FROM MON.SPARK_FT_CRA_GPRS
        WHERE SESSION_DATE = '###SLICE_VALUE###' AND NVL(MAIN_COST, 0) >= 0
        GROUP BY LOCATION_CI
    ) B ON A.CI = B.CI
    LEFT JOIN
    (
        SELECT
            SUM(C2S_REFILL_COUNT) C2S_REFILL_COUNT,
            SUM(C2S_MAIN_REFILL_AMOUNT) C2S_MAIN_REFILL_AMOUNT,
            SUM(C2S_PROMO_REFILL_AMOUNT) C2S_PROMO_REFILL_AMOUNT,
            SUM(P2P_REFILL_COUNT) P2P_REFILL_COUNT,
            SUM(P2P_REFILL_AMOUNT) P2P_REFILL_AMOUNT,
            SUM(SCRATCH_REFILL_COUNT) SCRATCH_REFILL_COUNT,
            SUM(SCRATCH_MAIN_REFILL_AMOUNT) SCRATCH_MAIN_REFILL_AMOUNT,
            SUM(SCRATCH_PROMO_REFILL_AMOUNT) SCRATCH_PROMO_REFILL_AMOUNT,
            SUM(P2P_REFILL_FEES) P2P_REFILL_FEES,
            CI
        FROM
        (
            SELECT
                NVL(C2S_REFILL_COUNT, 0) AS C2S_REFILL_COUNT,
                NVL(C2S_MAIN_REFILL_AMOUNT, 0) AS C2S_MAIN_REFILL_AMOUNT,
                NVL(C2S_PROMO_REFILL_AMOUNT, 0) AS C2S_PROMO_REFILL_AMOUNT,
                NVL(P2P_REFILL_COUNT, 0) AS P2P_REFILL_COUNT,
                NVL(P2P_REFILL_AMOUNT, 0) AS P2P_REFILL_AMOUNT,
                NVL(SCRATCH_REFILL_COUNT, 0) AS SCRATCH_REFILL_COUNT,
                NVL(SCRATCH_MAIN_REFILL_AMOUNT, 0) AS SCRATCH_MAIN_REFILL_AMOUNT,
                NVL(SCRATCH_PROMO_REFILL_AMOUNT, 0) AS SCRATCH_PROMO_REFILL_AMOUNT,
                NVL(P2P_REFILL_FEES, 0) AS P2P_REFILL_FEES,
                SITE_NAME
            FROM
            (
                SELECT
                    C001.SENDER_MSISDN MSISDN
                    ,SUM(CASE WHEN C001.REFILL_MEAN='C2S' THEN 1 ELSE 0 END ) C2S_REFILL_COUNT
                    ,SUM(CASE WHEN C001.REFILL_MEAN='C2S' THEN C001.REFILL_AMOUNT ELSE 0 END ) C2S_MAIN_REFILL_AMOUNT
                    ,SUM(CASE WHEN C001.REFILL_MEAN='C2S' THEN C001.REFILL_BONUS ELSE 0 END ) C2S_PROMO_REFILL_AMOUNT
                    ,SUM(CASE WHEN C001.REFILL_MEAN='SCRATCH' THEN 1 ELSE 0 END ) SCRATCH_REFILL_COUNT
                    ,SUM(CASE WHEN C001.REFILL_MEAN='SCRATCH' THEN C001.REFILL_AMOUNT ELSE 0 END ) SCRATCH_MAIN_REFILL_AMOUNT
                    ,SUM(CASE WHEN C001.REFILL_MEAN='SCRATCH' THEN C001.REFILL_BONUS ELSE 0 END ) SCRATCH_PROMO_REFILL_AMOUNT
                FROM MON.SPARK_FT_REFILL C001
                WHERE C001.REFILL_DATE = '###SLICE_VALUE###'
                    AND C001.TERMINATION_IND='200'
                GROUP BY C001.SENDER_MSISDN
            ) C00
            FULL JOIN
            (
                SELECT
                    C011.SENDER_MSISDN MSISDN
                    ,COUNT(*) P2P_REFILL_COUNT
                    ,SUM(C011.TRANSFER_AMT) P2P_REFILL_AMOUNT
                    ,SUM(C011.TRANSFER_FEES) P2P_REFILL_FEES
                FROM MON.SPARK_FT_CREDIT_TRANSFER C011
                WHERE C011.REFILL_DATE = '###SLICE_VALUE###'
                    AND C011.TERMINATION_IND='000'
                GROUP BY C011.SENDER_MSISDN
            ) C01 ON C00.MSISDN = C01.MSISDN
            LEFT JOIN
            (
                SELECT
                    MSISDN,
                    MAX(SITE_NAME) SITE_NAME
                FROM MON.SPARK_FT_CLIENT_LAST_SITE_DAY
                WHERE EVENT_DATE = '###SLICE_VALUE###'
                GROUP BY MSISDN
            ) C02 ON C00.MSISDN = C02.MSISDN
        ) C0
        LEFT JOIN
        (
            SELECT
                MAX(CI) CI,
                SITE_NAME
            FROM DIM.DT_GSM_CELL_CODE
            GROUP BY SITE_NAME
        ) C1 ON C0.SITE_NAME = C1.SITE_NAME
        GROUP BY CI
    ) C ON A.CI = C.CI
) T