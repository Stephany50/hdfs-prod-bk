INSERT INTO MON.SPARK_FT_GEOMARKETING_REPORT_360_MONTH
SELECT
    SITE_NAME,
    TOWN,
    REGION_ADM,
    REGION_COMMERCIAL,
    KPI_NAME,
    KPI_VALUE,
    CURRENT_TIMESTAMP() INSERT_DATE,
    '###SLICE_VALUE###' EVENT_MONTH
FROM
(
    
    SELECT
        SITE_NAME,
        TOWN,
        REGION_ADM,
        REGION_COMMERCIAL,
        CASE
            WHEN KPI_NAME = 'TRAFIC_VOIX' THEN 'TRAFIC_VOIX'
            WHEN KPI_NAME = 'TRAFIC_DATA' THEN 'TRAFIC_DATA'
            WHEN KPI_NAME = 'TRAFIC_SMS' THEN 'TRAFIC_SMS'
            WHEN KPI_NAME = 'REVENU_VOIX_PYG' THEN 'REVENU_VOIX_PYG'
            WHEN KPI_NAME = 'REVENU_SMS_PYG' THEN 'REVENU_SMS_PYG'
            WHEN KPI_NAME = 'RECHARGES' THEN 'RECHARGES'
            WHEN KPI_NAME = 'CASHIN' THEN 'CASHIN'
            WHEN KPI_NAME = 'CASHOUT' THEN 'CASHOUT'
            WHEN KPI_NAME = 'REVENU_OM' THEN 'REVENU_OM'
        END KPI_NAME,
        SUM(KPI_VALUE) KPI_VALUE
    FROM MON.SPARK_FT_GEOMARKETING_REPORT_360 
    WHERE EVENT_DATE between concat('###SLICE_VALUE###', '-01') and last_day(concat('###SLICE_VALUE###', '-01')) AND 
        KPI_NAME IN (
            'TRAFIC_VOIX', 
            'TRAFIC_DATA', 
            'TRAFIC_SMS',
            'REVENU_VOIX_PYG', 
            'REVENU_SMS_PYG',
            'RECHARGES',
            'CASHIN', 
            'CASHOUT',
            'REVENU_OM'
        )
    GROUP BY 
        SITE_NAME,
        TOWN,
        REGION_ADM,
        REGION_COMMERCIAL,
        CASE
            WHEN KPI_NAME = 'TRAFIC_VOIX' THEN 'TRAFIC_VOIX'
            WHEN KPI_NAME = 'TRAFIC_DATA' THEN 'TRAFIC_DATA'
            WHEN KPI_NAME = 'TRAFIC_SMS' THEN 'TRAFIC_SMS'
            WHEN KPI_NAME = 'REVENU_VOIX_PYG' THEN 'REVENU_VOIX_PYG'
            WHEN KPI_NAME = 'REVENU_SMS_PYG' THEN 'REVENU_SMS_PYG'
            WHEN KPI_NAME = 'RECHARGES' THEN 'RECHARGES'
            WHEN KPI_NAME = 'CASHIN' THEN 'CASHIN'
            WHEN KPI_NAME = 'CASHOUT' THEN 'CASHOUT'
            WHEN KPI_NAME = 'REVENU_OM' THEN 'REVENU_OM'
        END    
) T