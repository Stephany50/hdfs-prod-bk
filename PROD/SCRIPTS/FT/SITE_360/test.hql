insert into TMP.TT_conso_site_day


SELECT


a.LOCATION_CI  CI
--  , SUM (MAIN_RATED_AMOUNT ) TOTAL_VOICE_SMS_REVENUE
--  , SUM (CASE    WHEN  a.SERVICE_CODE = 'NVX_SMS' THEN  EVENT_COUNT  ELSE  0    END ) TOTAL_SMS_COUNT
--  , SUM (CASE    WHEN  a.SERVICE_CODE = 'VOI_VOX' THEN  EVENT_COUNT  ELSE  0    END ) TOTAL_VOICE_COUNT
--  , SUM (DURATION) TEL_DURATION



-- REVENU


,NVL(SUM (CASE WHEN a.SERVICE_CODE = 'VOI_VOX' THEN  MAIN_RATED_AMOUNT  ELSE  0    END ), 0)  AS TOTAL_VOICE_REVENUE
,NVL(SUM (CASE WHEN (MAIN_RATED_AMOUNT) > 0 THEN  DURATION   ELSE  0    END), 0)  TOTAL_VOICE_DURATION
,NVL(SUM (CASE WHEN a.SERVICE_CODE = 'NVX_SMS' THEN  ( MAIN_RATED_AMOUNT)   ELSE  0    END ), 0)  TOTAL_SMS_REVENUE
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('NVX_SMS', 'VOI_VOX') AND DEST_OPERATOR IN ('IN_ROAM_MT') THEN (MAIN_RATED_AMOUNT + PROMO_RATED_AMOUNT) ELSE 0 END ), 0)  ROAM_IN_VOICE_REVENUE --INROAM_TOTAL_CONSO
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_ROAM_MO') THEN NVL(MAIN_RATED_AMOUNT,0) ELSE 0 END ), 0)   ROAM_OUT_VOICE_REVENUE --ROAM_MAIN_TEL_CONSO
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('NVX_SMS') AND DEST_OPERATOR IN ('IN_ROAM_MT') THEN MAIN_RATED_AMOUNT ELSE 0 END ), 0)   ROAM_IN_SMS_REVENUE --INROAM_SMS_CONSO
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('NVX_SMS') AND DEST_OPERATOR IN ('OUT_ROAM_MO') THEN MAIN_RATED_AMOUNT ELSE 0 END ), 0)   ROAM_OUT_SMS_REVENUE --ROAM_SMS_CONSO
,NVL(SUM (CASE WHEN a.SERVICE_CODE = 'VOI_VOX' THEN  MAIN_RATED_AMOUNT  ELSE  0    END ), 0) MAIN_RATED_TEL_AMOUNT --CONSO_TEL_MAIN
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('IN_ROAM_MT') THEN NVL(MAIN_RATED_AMOUNT,0) ELSE 0 END ), 0)  MAIN_RATED_TEL_ROAM_IN_AMOUNT --INROAM_MAIN_TEL_CONSO
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_ROAM_MO') THEN NVL(MAIN_RATED_AMOUNT,0) ELSE 0 END ), 0)   MAIN_RATED_TEL_ROAM_OUT_AMOUNT --ROAM_MAIN_TEL_CONSO
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA') THEN MAIN_RATED_AMOUNT ELSE 0 END ), 0)   MAIN_RATED_TEL_SVA_AMOUNT --SVA_BILLED_TEL_CONSO,
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO','OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX') THEN NVL(MAIN_RATED_AMOUNT,0) ELSE 0 END ) , 0)  MAIN_RATED_TEL_INT_AMOUNT --INTERNATIONAL_MAIN_TEL_CONSO
,NVL((SUM (MAIN_RATED_AMOUNT) - (SUM (CASE    WHEN  a.SERVICE_CODE = 'VOI_VOX' THEN  MAIN_RATED_AMOUNT  ELSE  0    END ) + SUM (CASE WHEN SERVICE_CODE NOT IN ('NVX_SMS','VOI_VOX') THEN MAIN_RATED_AMOUNT ELSE 0 END ) )), 0)   MAIN_RATED_SMS_AMOUNT




-- TRAFFIC VOIX

,NVL(SUM (CASE    WHEN  (PROMO_RATED_AMOUNT + MAIN_RATED_AMOUNT) > 0 THEN  DURATION   ELSE  0    END), 0)  OG_RATED_CALL_DURATION --BILLED_TEL_DURATION
,NVL(SUM (DURATION), 0) OG_TOTAL_CALL_DURATION --TEL_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_NAT_MOB_OCM') THEN DURATION ELSE 0 END ) , 0) RATED_TEL_OCM_DURATION --ONNET_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_NAT_MOB_MTN') THEN RATED_DURATION ELSE 0 END ) , 0) RATED_TEL_MTN_DURATION --MTN_BILLED_TEL_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_NAT_MOB_NEX') THEN RATED_DURATION ELSE 0 END ) , 0) RATED_TEL_NEXTTEL_DURATION --NEXTTEL_BILLED_TEL_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_NAT_MOB_CAM') THEN RATED_DURATION ELSE 0 END ) , 0) RATED_TEL_CAMTEL_DURATION --CAMTEL_BILLED_TEL_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_NAT_MOB_MVO') THEN RATED_DURATION ELSE 0 END ) , 0) RATED_TEL_SET_DURATION --SET_BILLED_TEL_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('IN_ROAM_MT') THEN RATED_DURATION ELSE 0 END ) , 0) RATED_TEL_ROAM_IN_DURATION --INROAM_BILLED_TEL_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_ROAM_MO') THEN RATED_DURATION ELSE 0 END ) , 0) RATED_TEL_ROAM_OUT_DURATION--ROAM_BILLED_TEL_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA') AND (PROMO_RATED_AMOUNT + MAIN_RATED_AMOUNT) > 0 THEN DURATION ELSE 0 END ) , 0) RATED_TEL_SVA_DURATION --SVA_BILLED_DURATION
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('VOI_VOX') AND DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO','OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX') THEN RATED_DURATION ELSE 0 END ), 0) RATED_TEL_INT_DURATION --INTERNATIONAL_BIL_TEL_DURATION



-- TRAFFIC SMS
,NVL(SUM (CASE    WHEN  a.SERVICE_CODE = 'NVX_SMS' THEN  EVENT_COUNT  ELSE  0    END ) , 0) OG_SMS_TOTAL_COUNT --SMS_COUNT
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('NVX_SMS') AND DEST_OPERATOR IN ('OUT_NAT_MOB_OCM') THEN 1 ELSE 0 END ) , 0)  OG_SMS_OCM_COUNT --ONNET_SMS_COUNT
,NVL(SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MTN') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) , 0) OG_SMS_MTN_COUNT --mtn_sms_count
,NVL(SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) , 0)  OG_SMS_NEXTTEL_COUNT --nexttel_sms_count
,NVL(SUM (CASE WHEN DEST_OPERATOR = 'OUT_NAT_MOB_CAM' AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) , 0) OG_SMS_CAMTEL_COUNT  --camtel_sms_count
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('NVX_SMS') AND DEST_OPERATOR IN ('OUT_NAT_MOB_MVO') THEN 1 ELSE 0 END ) , 0) OG_SMS_SET_COUNT --SET_SMS_COUNT
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('NVX_SMS') AND DEST_OPERATOR IN ('IN_ROAM_MT') THEN 1 ELSE 0 END ) , 0)  OG_SMS_ROAM_IN_COUNT --INROAM_SMS_COUNT
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('NVX_SMS') AND DEST_OPERATOR IN ('OUT_ROAM_MO') THEN 1 ELSE 0 END ) , 0) OG_SMS_ROAM_OUT_COUNT --ROAM_SMS_COUNT
,NVL(SUM (CASE WHEN SERVICE_CODE IN ('NVX_SMS') AND DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA')  THEN EVENT_COUNT ELSE 0 END ) , 0)  OG_SMS_SVA_COUNT --SVA_SMS_COUNT
,NVL(SUM (CASE WHEN DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO', 'OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) , 0) OG_SMS_INTERNATIONAL_COUNT --international_sms_count





--  , SUM (CASE WHEN SERVICE_CODE NOT IN ('NVX_SMS','VOI_VOX') THEN EVENT_COUNT ELSE 0 END ) others_vas_total_count
--  , SUM (CASE WHEN SERVICE_CODE NOT IN ('NVX_SMS','VOI_VOX') THEN DURATION ELSE 0 END ) others_vas_duration
--  , SUM (CASE WHEN SERVICE_CODE NOT IN ('NVX_SMS','VOI_VOX') THEN MAIN_RATED_AMOUNT ELSE 0 END ) others_vas_main_cost
--  , SUM (CASE WHEN SERVICE_CODE NOT IN ('NVX_SMS','VOI_VOX') THEN PROMO_RATED_AMOUNT ELSE 0 END ) others_vas_promo_cost
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MTN')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_MTN_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MTN') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_MTN_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MTN') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_MTN_COUNT

, SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MTN')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_MTN_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MTN') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_MTN_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MTN') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_MTN_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_CAM')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_CAMTEL_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_CAM') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_CAMTEL_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_CAM') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_CAMTEL_COUNT
, SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_CAM')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_CAMTEL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_CAM') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_CAMTEL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_CAM') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_CAMTEL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_NEX')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_NEXTTEL_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_NEXTTEL_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_NEXTTEL_COUNT
, SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_NEX')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_NEXTTEL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_NEXTTEL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_NEXTTEL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_OCM')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_OCM_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_OCM') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_OCM_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_OCM') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_OCM_COUNT
, SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_OCM')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_OCM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_OCM') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_OCM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_OCM') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_OCM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MVO')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_SET_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MVO') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_SET_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MVO') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_SET_COUNT
, SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MVO')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_SET_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MVO') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_SET_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_NAT_MOB_MVO') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_SET_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('IN_ROAM_MT')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_IN_ROAM_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('IN_ROAM_MT') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_IN_ROAM_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('IN_ROAM_MT') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_IN_ROAM_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('IN_ROAM_MT')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_IN_ROAM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('IN_ROAM_MT') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_IN_ROAM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('IN_ROAM_MT') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_IN_ROAM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_ROAM_MO')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_OUT_ROAM_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_ROAM_MO') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_OUT_ROAM_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_ROAM_MO') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_OUT_ROAM_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_ROAM_MO')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_OUT_ROAM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_ROAM_MO') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_OUT_ROAM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_ROAM_MO') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_OUT_ROAM_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO','OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_INTERNATIONAL_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO','OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_INTERNATIONAL_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO','OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_INTERNATIONAL_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO','OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_INTERNATIONAL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO','OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_INTERNATIONAL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR NOT IN ('OUT_NAT_MOB_OCM','OUT_NAT_MOB_MTN','OUT_NAT_MOB_CAM','OUT_SVA','OUT_CCSVA','OUT_NAT_MOB_MVO','OUT_ROAM_MO','IN_ROAM_MT','OUT_NAT_MOB_NEX') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_INTERNATIONAL_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA')  THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_TEL_VAS_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA') AND SERVICE_CODE = 'NVX_VOX' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_VOICE_VAS_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA') AND SERVICE_CODE = 'NVX_SMS' THEN EVENT_COUNT ELSE 0 END ) MAIN_RATED_SMS_VAS_COUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA')  THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_TEL_VAS_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA') AND SERVICE_CODE = 'NVX_VOX' THEN (MAIN_RATED_AMOUNT)  ELSE 0 END ) MAIN_RATED_VOICE_VAS_AMOUNT
--  , SUM (CASE WHEN DEST_OPERATOR IN ('OUT_SVA','OUT_CCSVA') AND SERVICE_CODE = 'NVX_SMS' THEN (MAIN_RATED_AMOUNT) ELSE 0 END ) MAIN_RATED_SMS_VAS_AMOUNT
,current_timestamp INSERT_DATE
,'###SLICE_VALUE###' EVENT_DATE

FROM
(
SELECT

a.LOCATION_CI
, a.OPERATOR_CODE
, (CASE
WHEN SERVICE_CODE = 'SMS' THEN 'NVX_SMS'
WHEN SERVICE_CODE = 'TEL' THEN 'VOI_VOX'
WHEN SERVICE_CODE = 'USS' THEN 'NVX_USS'
WHEN SERVICE_CODE = 'GPR' THEN 'NVX_DAT_GPR'
WHEN SERVICE_CODE = 'DFX' THEN 'NVX_DFX'
WHEN SERVICE_CODE = 'DAT' THEN 'NVX_DAT'
WHEN SERVICE_CODE = 'VDT' THEN 'NVX_VDT'
WHEN SERVICE_CODE = 'WEB' THEN 'NVX_WEB'
WHEN UPPER(SERVICE_CODE) IN ('SMSMO','SMSRMG') THEN 'NVX_SMS'
WHEN UPPER(SERVICE_CODE) IN ('OC','OCFWD','OCRMG','TCRMG') THEN 'VOI_VOX'
WHEN UPPER(SERVICE_CODE) LIKE '%FNF%MODIFICATION%' THEN 'VOI_VOX'
WHEN UPPER(SERVICE_CODE) LIKE '%ACCOUNT%INTERRO%' THEN 'VOI_VOX'
ELSE 'AUT'
END ) SERVICE_CODE
, ( CASE WHEN a.Call_Destination_Code IN ('ONNET','ONNETFREE','OCM_D') THEN 'OUT_NAT_MOB_OCM'
WHEN a.Call_Destination_Code IN ('MTN','MTN_D') THEN 'OUT_NAT_MOB_MTN'
WHEN a.Call_Destination_Code IN ('CAM_D','CAM') THEN 'OUT_NAT_MOB_CAM'
WHEN a.Call_Destination_Code IN ('NEXTTEL','NEXTTEL_D') THEN 'OUT_NAT_MOB_NEX' --NEXTTEL
WHEN a.Call_Destination_Code = 'VAS' THEN 'OUT_SVA'
WHEN a.Call_Destination_Code = 'EMERG' THEN 'OUT_CCSVA'
WHEN a.Call_Destination_Code = 'OCRMG' THEN 'OUT_ROAM_MO'
WHEN a.Call_Destination_Code = 'TCRMG' THEN 'IN_ROAM_MT'
WHEN a.Call_Destination_Code = 'INT' THEN 'OUT_INT'
WHEN a.Call_Destination_Code = 'MVNO' THEN 'OUT_NAT_MOB_MVO'
ELSE Call_Destination_Code END ) DEST_OPERATOR
, sum(PROMO_RATED_AMOUNT) PROMO_RATED_AMOUNT
, sum(MAIN_RATED_AMOUNT) MAIN_RATED_AMOUNT
, sum(CALL_PROCESS_TOTAL_DURATION) DURATION
, SUM(CASE WHEN a.Main_Rated_Amount + a.Promo_Rated_Amount > 0 THEN CALL_PROCESS_TOTAL_DURATION ELSE 0 END) AS RATED_DURATION
, SUM(CASE WHEN a.Main_Rated_Amount + a.Promo_Rated_Amount > 0 THEN 1 ELSE 0 END) AS RATED_EVENT_COUNT
, SUM (1) EVENT_COUNT
,  MAX (a.COMMERCIAL_PROFILE) COMMERCIAL_PROFILE
, SUM(BUNDLE_SMS_USED_VOLUME) BUNDLE_SMS_USED_VOLUME
, SUM(BUNDLE_TIME_USED_VOLUME) BUNDLE_TIME_USED_VOLUME
FROM MON.SPARK_FT_BILLED_TRANSACTION_PREPAID a
WHERE
TRANSACTION_DATE ='###SLICE_VALUE###'

AND Main_Rated_Amount >= 0
AND Promo_Rated_Amount >= 0

GROUP BY a.location_ci, a.OPERATOR_CODE
, (CASE
WHEN SERVICE_CODE = 'SMS' THEN 'NVX_SMS'
WHEN SERVICE_CODE = 'TEL' THEN 'VOI_VOX'
WHEN SERVICE_CODE = 'USS' THEN 'NVX_USS'
WHEN SERVICE_CODE = 'GPR' THEN 'NVX_DAT_GPR'
WHEN SERVICE_CODE = 'DFX' THEN 'NVX_DFX'
WHEN SERVICE_CODE = 'DAT' THEN 'NVX_DAT'
WHEN SERVICE_CODE = 'VDT' THEN 'NVX_VDT'
WHEN SERVICE_CODE = 'WEB' THEN 'NVX_WEB'
WHEN UPPER(SERVICE_CODE) IN ('SMSMO','SMSRMG') THEN 'NVX_SMS'
WHEN UPPER(SERVICE_CODE) IN ('OC','OCFWD','OCRMG','TCRMG') THEN 'VOI_VOX'
WHEN UPPER(SERVICE_CODE) LIKE '%FNF%MODIFICATION%' THEN 'VOI_VOX'
WHEN UPPER(SERVICE_CODE) LIKE '%ACCOUNT%INTERRO%' THEN 'VOI_VOX'
ELSE 'AUT'
END )
--, mon.fn_interco_destination (OTHER_PARTY)
, ( CASE WHEN a.Call_Destination_Code IN ('ONNET','ONNETFREE','OCM_D') THEN 'OUT_NAT_MOB_OCM'
WHEN a.Call_Destination_Code IN ('MTN','MTN_D') THEN 'OUT_NAT_MOB_MTN'
WHEN a.Call_Destination_Code IN ('CAM_D','CAM') THEN 'OUT_NAT_MOB_CAM'
WHEN a.Call_Destination_Code IN ('NEXTTEL','NEXTTEL_D') THEN 'OUT_NAT_MOB_NEX' --NEXTTEL
WHEN a.Call_Destination_Code = 'VAS' THEN 'OUT_SVA'
WHEN a.Call_Destination_Code = 'EMERG' THEN 'OUT_CCSVA'
WHEN a.Call_Destination_Code = 'OCRMG' THEN 'OUT_ROAM_MO'
WHEN a.Call_Destination_Code = 'TCRMG' THEN 'IN_ROAM_MT'
WHEN a.Call_Destination_Code = 'INT' THEN 'OUT_INT'
WHEN a.Call_Destination_Code = 'MVNO' THEN 'OUT_NAT_MOB_MVO'
ELSE Call_Destination_Code END )
) a
GROUP BY
a.LOCATION_CI




