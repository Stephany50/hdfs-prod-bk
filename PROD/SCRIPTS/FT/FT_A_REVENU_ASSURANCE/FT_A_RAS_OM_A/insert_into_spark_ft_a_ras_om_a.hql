INSERT INTO AGG.SPARK_FT_A_RAS_OM_A
SELECT
A.TRANSACTION_DATE,
A.SERVED_MSISDN,
B.COMMERCIAL_OFFER,
B.ACTIVATION_DATE,
A.SMS_COUNT,
A.RECEIVER_COUNT,
A.SERVED_IMEI,
A.LOCATION_ID,
A.DISTINCT_SMS_PROPORTION,
DATE_FORMAT(A.TRANSACTION_DATE,'dd') DAY,
DATE_FORMAT(A.TRANSACTION_DATE,'YYYY') YEAR,
DATE_FORMAT(A.TRANSACTION_DATE,'MM') MONTH,
DATE_FORMAT(B.ACTIVATION_DATE,'dd') ACTIVATION_DAY,
DATE_FORMAT(B.ACTIVATION_DATE,'YYYY') ACTIVATION_YEAR,
DATE_FORMAT(B.ACTIVATION_DATE,'MM') ACTIVATION_MONTH,
CURRENT_TIMESTAMP AS INSERT_DATE,
TO_DATE(TRANSACTION_DATE) EVENT_DATE
FROM
(SELECT
TRANSACTION_DATE,
SERVED_MSISDN,
COUNT(*) SMS_COUNT,
COUNT(DISTINCT OTHER_PARTY) AS RECEIVER_COUNT,
SERVED_IMEI,
SERVED_PARTY_LOCATION LOCATION_ID,
ROUND(COUNT (DISTINCT OTHER_PARTY)/COUNT(*), 2) AS DISTINCT_SMS_PROPORTION
FROM MON.SPARK_FT_MSC_TRANSACTION
WHERE
TRANSACTION_DATE = '###SLICE_VALUE###'
AND TRANSACTION_DIRECTION ='Sortant'
AND TRANSACTION_TYPE ='SMS_MO'
AND OTHER_PARTY LIKE '6%'
AND LENGTH(OTHER_PARTY)=9
AND SERVED_PARTY_LOCATION LIKE '624-02-20079-0424%'
GROUP BY TRANSACTION_DATE, SERVED_MSISDN, SERVED_IMEI, SERVED_PARTY_LOCATION
HAVING COUNT (DISTINCT OTHER_PARTY) > 10) A
INNER JOIN
(SELECT
COMMERCIAL_OFFER, ACCESS_KEY,ACTIVATION_DATE
FROM
MON.SPARK_FT_CONTRACT_SNAPSHOT
WHERE
EVENT_DATE = '###SLICE_VALUE###'
) B
ON A.SERVED_MSISDN = B.ACCESS_KEY
ORDER BY A.RECEIVER_COUNT DESC
