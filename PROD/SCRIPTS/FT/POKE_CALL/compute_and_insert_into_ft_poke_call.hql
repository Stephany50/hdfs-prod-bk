ADD JAR hdfs:///PROD/UDF/hive-udf-1.0.jar;
CREATE TEMPORARY FUNCTION FN_GET_NNP_MSISDN_9DIGITS as 'cm.orange.bigdata.udf.GetNnpMsisdn9Digits';

INSERT INTO MON.FT_POKE_CALL PARTITION(SETUPDATE)
SELECT
    T1.SERVED_PARTY BILLED_PREPAID_SERVED_PARTY,
    T1.OTHER_PARTY BILLED_PREPAID_OTHER_PARTY,
    T2.SERVED_PARTY POKE_SERVED_PARTY,
    T2.OTHER_PARTY POKE_OTHER_PARTY,
    MAX(IF(RESULT=0,MAIN_RATED_AMOUNT,0)) MAIN_RATED_AMOUNT,
    MAX(IF(RESULT=0,PROMO_RATED_AMOUNT,0)) PROMO_RATED_AMOUNT,
    MAX(SETUPTIME) SETUPTIME,
    TERMINATETIME,
    TRANSACTION_TIME,
    SERVICEKEY,
    IF(RESULT=0,"SUCCESS","FAIL") RESULT,
    CAUSE_NAME,
    MAX(unix_timestamp(concat(SETUPDATE,' ',transaction_time), "yyyy-MM-dd hhmmss")-unix_timestamp(SETUPTIME, "yyyy-MM-dd hh:mm:ss"))/60 ELAPSED_TIME,
    MAX(T2.ORIGINAL_FILE_DATE) ORIGINAL_FILE_DATE,
    MAX(T2.ORIGINAL_FILE_NAME) ORIGINAL_FILE_NAME,
    CURRENT_TIMESTAMP INSERT_DATE,
    SETUPDATE
FROM MON.FT_BILLED_TRANSACTION_PREPAID T1
LEFT JOIN (
    SELECT
        FN_GET_NNP_MSISDN_9DIGITS (CARDNUMBER) CARDNUMBER,
        SERVICEKEY,
        FN_GET_NNP_MSISDN_9DIGITS (CALLINGNUMBER) SERVED_PARTY,
        FN_GET_NNP_MSISDN_9DIGITS (CALLEDNUMBER) OTHER_PARTY,
        SETUPTIME,
        TERMINATETIME,
        RESULT,
        NAME CAUSE_NAME,
        MAX(ORIGINAL_FILE_NAME) ORIGINAL_FILE_NAME,
        ORIGINAL_FILE_DATE,
        SETUPDATE
    FROM CDR.IT_POKE_CALL
    LEFT JOIN DIM.DT_POKE_CALL_CAUSE_NAME ON CAUSEVALUE=KEY
    WHERE SETUPDATE="2019-06-09"
    GROUP BY
       FN_GET_NNP_MSISDN_9DIGITS (CARDNUMBER),
       SERVICEKEY,
       FN_GET_NNP_MSISDN_9DIGITS (CALLINGNUMBER),
       FN_GET_NNP_MSISDN_9DIGITS (CALLEDNUMBER),
       SETUPTIME,
       TERMINATETIME,
       RESULT,
       NAME,
       ORIGINAL_FILE_DATE,
       SETUPDATE
   ) T2 ON SUBSTRING(T1.SERVED_PARTY,-9)=SUBSTRING(T2.OTHER_PARTY,-9) AND SUBSTRING(T1.OTHER_PARTY,-9)=SUBSTRING(T2.SERVED_PARTY,-9)
WHERE
    TRANSACTION_DATE="2019-06-09" AND
    T2.OTHER_PARTY IS NOT NULL AND (unix_timestamp(concat(transaction_date,' ',transaction_time), "yyyy-MM-dd hhmmss")-unix_timestamp(SETUPTIME, "yyyy-MM-dd hh:mm:ss"))/60<=30
GROUP BY
    T1.SERVED_PARTY,
    T1.OTHER_PARTY,
    TRANSACTION_TIME,
    TERMINATETIME,
    SETUPDATE,
    T2.OTHER_PARTY,
    T2.SERVED_PARTY,
    CAUSE_NAME,
    RESULT,
    SERVICEKEY