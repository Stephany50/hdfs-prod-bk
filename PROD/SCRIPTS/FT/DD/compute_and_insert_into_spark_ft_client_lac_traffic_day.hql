INSERT INTO MON.SPARK_FT_CLIENT_LAC_TRAFFIC_DAY

(MSISDN, IMEI, LAC, DUREE_SORTANT, NBRE_TEL_SORTANT, DUREE_ENTRANT, NBRE_TEL_ENTRANT, NBRE_SMS_SORTANT, NBRE_SMS_ENTRANT, REFRESH_DATE,

SERVED_PARTY_LOCATION, NBRE_TEL_MTN_SORTANT,NBRE_TEL_CAMTEL_SORTANT,NBRE_TEL_OCM_SORTANT,DUREE_TEL_MTN_SORTANT,DUREE_TEL_CAMTEL_SORTANT,

DUREE_TEL_OCM_SORTANT,NBRE_SMS_MTN_SORTANT,NBRE_SMS_CAMTEL_SORTANT,NBRE_SMS_OCM_SORTANT,NBRE_SMS_ZEBRA_SORTANT,NBRE_TEL_MTN_ENTRANT,

NBRE_TEL_CAMTEL_ENTRANT,NBRE_TEL_OCM_ENTRANT,DUREE_TEL_MTN_ENTRANT,DUREE_TEL_CAMTEL_ENTRANT,DUREE_TEL_OCM_ENTRANT,NBRE_SMS_MTN_ENTRANT,

NBRE_SMS_CAMTEL_ENTRANT,NBRE_SMS_OCM_ENTRANT,NBRE_SMS_ZEBRA_ENTRANT, NBRE_TEL_NEXTTEL_SORTANT, DUREE_TEL_NEXTTEL_SORTANT, NBRE_SMS_NEXTTEL_SORTANT,

NBRE_TEL_NEXTTEL_ENTRANT, DUREE_TEL_NEXTTEL_ENTRANT, NBRE_SMS_NEXTTEL_ENTRANT, INSERT_DATE, EVENT_DATE)

SELECT

    a.MSISDN
    
    , MAX(IMEI) IMEI

    , b.LAC LAC

    , SUM(DUREE_SORTANT) DUREE_SORTANT 
    
    , SUM(NBRE_TEL_SORTANT) NBRE_TEL_SORTANT 
    
    , SUM(DUREE_ENTRANT) DUREE_ENTRANT 
    
    , SUM(NBRE_TEL_ENTRANT) NBRE_TEL_ENTRANT 
    
    , SUM(NBRE_SMS_SORTANT) NBRE_SMS_SORTANT 
    
    , SUM(NBRE_SMS_ENTRANT) NBRE_SMS_ENTRANT

    , CURRENT_TIMESTAMP() REFRESH_DATE
    
    , MAX(SERVED_PARTY_LOCATION) SERVED_PARTY_LOCATION

    , SUM(NBRE_TEL_MTN_SORTANT) NBRE_TEL_MTN_SORTANT

    , SUM(NBRE_TEL_CAMTEL_SORTANT) NBRE_TEL_CAMTEL_SORTANT

    , SUM(NBRE_TEL_OCM_SORTANT) NBRE_TEL_OCM_SORTANT

    , SUM(DUREE_TEL_MTN_SORTANT) DUREE_TEL_MTN_SORTANT

    , SUM(DUREE_TEL_CAMTEL_SORTANT) DUREE_TEL_CAMTEL_SORTANT

    , SUM(DUREE_TEL_OCM_SORTANT) DUREE_TEL_OCM_SORTANT

    , SUM(NBRE_SMS_MTN_SORTANT) NBRE_SMS_MTN_SORTANT

    , SUM(NBRE_SMS_CAMTEL_SORTANT) NBRE_SMS_CAMTEL_SORTANT

    , SUM(NBRE_SMS_OCM_SORTANT) NBRE_SMS_OCM_SORTANT

    , SUM(NBRE_SMS_ZEBRA_SORTANT) NBRE_SMS_ZEBRA_SORTANT

    , SUM(NBRE_TEL_MTN_ENTRANT) NBRE_TEL_MTN_ENTRANT

    , SUM(NBRE_TEL_CAMTEL_ENTRANT) NBRE_TEL_CAMTEL_ENTRANT

    , SUM(NBRE_TEL_OCM_ENTRANT) NBRE_TEL_OCM_ENTRANT

    , SUM(DUREE_TEL_MTN_ENTRANT) DUREE_TEL_MTN_ENTRANT

    , SUM(DUREE_TEL_CAMTEL_ENTRANT) DUREE_TEL_CAMTEL_ENTRANT

    , SUM(DUREE_TEL_OCM_ENTRANT) DUREE_TEL_OCM_ENTRANT

    , SUM(NBRE_SMS_MTN_ENTRANT) NBRE_SMS_MTN_ENTRANT

    , SUM(NBRE_SMS_CAMTEL_ENTRANT) NBRE_SMS_CAMTEL_ENTRANT

    , SUM(NBRE_SMS_OCM_ENTRANT) NBRE_SMS_OCM_ENTRANT

    , SUM(NBRE_SMS_ZEBRA_ENTRANT) NBRE_SMS_ZEBRA_ENTRANT

    , SUM(NBRE_TEL_NEXTTEL_SORTANT) NBRE_TEL_NEXTTEL_SORTANT

    , SUM(DUREE_TEL_NEXTTEL_SORTANT) DUREE_TEL_NEXTTEL_SORTANT

    , SUM(NBRE_SMS_NEXTTEL_SORTANT) NBRE_SMS_NEXTTEL_SORTANT

    , SUM(NBRE_TEL_NEXTTEL_ENTRANT) NBRE_TEL_NEXTTEL_ENTRANT

    , SUM(DUREE_TEL_NEXTTEL_ENTRANT) DUREE_TEL_NEXTTEL_ENTRANT

    , SUM(NBRE_SMS_NEXTTEL_ENTRANT) NBRE_SMS_NEXTTEL_ENTRANT
    
    , CURRENT_TIMESTAMP() INSERT_DATE

    , a.EVENT_DATE
    
FROM

    TMP.TT_CLIENT_LAC_TRAFFIC_DAY a

LEFT JOIN

    (
        SELECT

        b.msisdn msisdn

        , MIN(b.lac) lac

        FROM

        (
            SELECT

                b.msisdn, b.lac, b.nbre, MAX(b.nbre) over (PARTITION BY b.msisdn) max_nbre_msisdn
            
            FROM
            (
                SELECT

                    b.msisdn, b.lac, SUM(NVL (DUREE_SORTANT, 0) + NVL (DUREE_ENTRANT, 0) + NVL (NBRE_SMS_SORTANT, 0)  + NVL (NBRE_SMS_ENTRANT, 0) ) nbre

                FROM

                    TMP.TT_CLIENT_LAC_TRAFFIC_DAY b

                GROUP BY

                    b.msisdn, b.lac

            ) b

        )  b

        WHERE b.nbre = b.max_nbre_msisdn

        GROUP BY b.msisdn

    ) b

ON a.MSISDN  = b.MSISDN

GROUP BY

    a.EVENT_DATE, a.MSISDN, b.LAC
