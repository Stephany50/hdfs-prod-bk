INSERT INTO MON.SPARK_FT_OM_ACTIVE_USER
SELECT
(CASE WHEN SERVICE_TYPE IN ('SUBREG','P2P') THEN 'P2P_IN' ELSE SERVICE_TYPE  END ) SERVICE_TYPE
,fn_format_msisdn_to_9digits(RECEIVER_MSISDN) MSISDN
,SUM(TRANSACTION_AMOUNT) TRANSACTION_AMOUNT
,MAX(TRANSFER_DATETIME) LAST_TRANSACTION_DATE_TIME
,CURRENT_TIMESTAMP() INSERT_DATE
,TRANSFER_DATETIME EVENT_DATE
FROM CDR.SPARK_IT_OMNY_TRANSACTIONS
WHERE TRANSFER_DATETIME BETWEEN DATE_SUB('###SLICE_VALUE###',30)  AND '###SLICE_VALUE###'
AND TRANSFER_STATUS='TS'
AND RECEIVER_CATEGORY_CODE='SUBS'
AND SERVICE_TYPE IN ('CASHIN','SUBREG','P2P','ENT2REG')
GROUP BY TRANSFER_DATETIME,fn_format_msisdn_to_9digits(RECEIVER_MSISDN),(CASE WHEN SERVICE_TYPE IN ('SUBREG','P2P') THEN 'P2P_IN' ELSE SERVICE_TYPE  END )