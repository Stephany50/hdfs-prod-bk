INSERT INTO MON.SPARK_FT_DATAMART_OM_DAILY

SELECT

    A.MSISDN,
    A.USER_ID,
    A.NB_OPERATIONS,
    A.NB_SERVICES_DISTINCTS,
    B.ACCOUNT_BALANCE SOLDE_FIN_JOURNEE,
    A.ARPU_OM,
    A.NB_CI,
    A.MONTANT_CI,
    A.NB_CO,
    A.MONTANT_CO,
    A.FRAIS_CO,
    A.NB_BILL_PAY,
    A.MONTANT_BILL_PAY,
    A.FRAIS_BILL_PAY,
    A.NB_MERCHPAY,
    A.MONTANT_MERCHPAY,
    A.FRAIS_MERCHPAY,
    A.MONTANT_P2P_RECU,
    A.NB_P2P_RECU,
    A.MONTANT_P2P_ORANGE,
    A.FRAIS_P2P_ORANGE,
    A.MONTANT_TNO,
    A.FRAIS_TNO,
    A.NB_TOP_UP,
    A.MONTANT_TOP_UP,
    A.NB_AUTRES,
    A.MONTANT_AUTRES,
    A.NB_BUNDLES_DATA,
    A.MONTANT_BDLE_DATA,
    A.NB_BUNDLE_VOIX,
    A.MONTANT_BDLE_VOIX,
    CURRENT_TIMESTAMP INSERT_DATE,
    A.PERIOD


FROM
(
    SELECT
        A.MSISDN,
        A.USER_ID,
        A.PERIOD,
        SUM(A.NB_OPERATIONS) NB_OPERATIONS,
        COUNT(DISTINCT A.SERVICE_TYPE) NB_SERVICES_DISTINCTS,
        SUM(A.ARPU_OM) ARPU_OM,
        SUM(A.NB_CI) NB_CI,
        SUM(A.MONTANT_CI) MONTANT_CI,
        SUM(A.NB_CO) NB_CO,
        SUM(A.MONTANT_CO) MONTANT_CO,
        SUM(A.FRAIS_CO) FRAIS_CO,
        SUM(A.NB_BILL_PAY) NB_BILL_PAY,
        SUM(A.MONTANT_BILL_PAY) MONTANT_BILL_PAY,
        SUM(A.FRAIS_BILL_PAY) FRAIS_BILL_PAY,
        SUM(A.NB_MERCHPAY) NB_MERCHPAY,
        SUM(A.MONTANT_MERCHPAY) MONTANT_MERCHPAY,
        SUM(A.FRAIS_MERCHPAY) FRAIS_MERCHPAY,
        SUM(A.MONTANT_P2P_RECU) MONTANT_P2P_RECU,
        SUM(A.NB_P2P_RECU) NB_P2P_RECU,
        SUM(A.MONTANT_P2P_ORANGE) MONTANT_P2P_ORANGE,
        SUM(A.FRAIS_P2P_ORANGE) FRAIS_P2P_ORANGE,
        SUM(A.MONTANT_TNO) MONTANT_TNO,
        SUM(A.FRAIS_TNO) FRAIS_TNO,
        SUM(A.NB_TOP_UP) NB_TOP_UP,
        SUM(A.MONTANT_TOP_UP) MONTANT_TOP_UP,
        SUM(A.NB_AUTRES) NB_AUTRES,
        SUM(A.MONTANT_AUTRES) MONTANT_AUTRES,
        SUM(A.NB_BUNDLES_DATA) NB_BUNDLES_DATA,
        SUM(A.MONTANT_BDLE_DATA) MONTANT_BDLE_DATA,
        SUM(A.NB_BUNDLE_VOIX) NB_BUNDLE_VOIX,
        SUM(A.MONTANT_BDLE_VOIX) MONTANT_BDLE_VOIX
    FROM
    (
        SELECT
            OT.SENDER_MSISDN MSISDN,
            OT.SENDER_USER_ID USER_ID,
            OT.SERVICE_TYPE,
            TO_DATE(OT.TRANSFER_DATETIME) PERIOD,
            COUNT(*) NB_OPERATIONS,
            SUM(OT.SERVICE_CHARGE_RECEIVED) ARPU_OM,
            0 NB_CI,
            0 MONTANT_CI,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'CASHOUT' THEN 1 ELSE 0 END) NB_CO,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'CASHOUT' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_CO,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'CASHOUT' THEN OT.SERVICE_CHARGE_RECEIVED ELSE 0 END) FRAIS_CO,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) NB_BILL_PAY,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'BILLPAY' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_BILL_PAY,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'BILLPAY' THEN OT.SERVICE_CHARGE_RECEIVED ELSE 0 END) FRAIS_BILL_PAY,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'MERCHPAY' THEN 1 ELSE 0 END) NB_MERCHPAY,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'MERCHPAY' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_MERCHPAY,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'MERCHPAY' THEN OT.SERVICE_CHARGE_RECEIVED ELSE 0 END) FRAIS_MERCHPAY,
            0 MONTANT_P2P_RECU,
            0 NB_P2P_RECU,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'P2P' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_P2P_ORANGE,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'P2P' THEN OT.SERVICE_CHARGE_RECEIVED ELSE 0 END) FRAIS_P2P_ORANGE,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'P2PNONREG' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_TNO,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'P2PNONREG' THEN OT.SERVICE_CHARGE_RECEIVED ELSE 0 END) FRAIS_TNO,
            SUM(CASE WHEN OT.TRANSACTION_TAG = 'TOP UP' THEN 1 ELSE 0 END) NB_TOP_UP,
            SUM(CASE WHEN OT.TRANSACTION_TAG = 'TOP UP' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_TOP_UP,
            SUM(CASE WHEN OT.SERVICE_TYPE NOT IN ('CASHOUT', 'BILLPAY', 'MERCHPAY', 'P2P', 'P2PNONREG') AND OT.TRANSACTION_TAG <> 'TOP UP' THEN 1 ELSE 0 END) NB_AUTRES,
            SUM(CASE WHEN OT.SERVICE_TYPE NOT IN ('CASHOUT', 'BILLPAY', 'MERCHPAY', 'P2P', 'P2PNONREG') AND OT.TRANSACTION_TAG <> 'TOP UP' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_AUTRES,
            SUM(CASE WHEN RECEIVER_MSISDN = '698066666' AND OT.SERVICE_TYPE = 'MERCHPAY' THEN 1 ELSE 0 END) NB_BUNDLES_DATA,
            SUM(CASE WHEN RECEIVER_MSISDN = '698066666' AND OT.SERVICE_TYPE = 'MERCHPAY' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_BDLE_DATA,
            0 NB_BUNDLE_VOIX,
            0 MONTANT_BDLE_VOIX
        FROM BACKUP_DWH.IT_OMNY_TRANSACTIONS  OT
        WHERE TRANSFER_DATETIME = '2020-02-17' AND OT.TRANSFER_DONE LIKE '%Y%'
        GROUP BY SENDER_MSISDN, SENDER_USER_ID, OT.SERVICE_TYPE, TO_DATE(OT.TRANSFER_DATETIME)
        UNION ALL
        SELECT
            OT.RECEIVER_MSISDN MSISDN,
            OT.RECEIVER_USER_ID USER_ID,
            OT.SERVICE_TYPE,
            TO_DATE(OT.TRANSFER_DATETIME) PERIOD,
            COUNT(*) NB_OPERATIONS,
            SUM(OT.SERVICE_CHARGE_RECEIVED) ARPU_OM,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'CASHIN' THEN 1 ELSE 0 END) NB_CI,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'CASHIN' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_CI,
            0 NB_CO,
            0 MONTANT_CO,
            0 FRAIS_CO,
            0 NB_BILL_PAY,
            0 MONTANT_BILL_PAY,
            0 FRAIS_BILL_PAY,
            0 NB_MERCHPAY,
            0 MONTANT_MERCHPAY,
            0 FRAIS_MERCHPAY,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'P2P' THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_P2P_RECU,
            SUM(CASE WHEN OT.SERVICE_TYPE = 'P2P' THEN 1 ELSE 0 END) NB_P2P_RECU,
            0 MONTANT_P2P_ORANGE,
            0 FRAIS_P2P_ORANGE,
            0 MONTANT_TNO,
            0 FRAIS_TNO,
            0 NB_TOP_UP,
            0 MONTANT_TOP_UP,
            SUM(CASE WHEN OT.SERVICE_TYPE NOT IN ('CASHIN', 'P2P') THEN 1 ELSE 0 END) NB_AUTRES,
            SUM(CASE WHEN OT.SERVICE_TYPE NOT IN ('CASHIN', 'P2P') THEN OT.TRANSACTION_AMOUNT ELSE 0 END) MONTANT_AUTRES,
            0 NB_BUNDLES_DATA,
            0 MONTANT_BDLE_DATA,
            0 NB_BUNDLE_VOIX,
            0 MONTANT_BDLE_VOIX
        FROM BACKUP_DWH.IT_OMNY_TRANSACTIONS  OT
        WHERE TRANSFER_DATETIME = '2020-02-17' AND OT.TRANSFER_DONE LIKE '%Y%'
        GROUP BY OT.RECEIVER_MSISDN, OT.RECEIVER_USER_ID, OT.SERVICE_TYPE, TO_DATE(OT.TRANSFER_DATETIME)
    ) A
GROUP BY A.MSISDN, A.USER_ID, A.PERIOD
) A

LEFT JOIN 

(SELECT * FROM MON.SPARK_FT_OMNY_ACCOUNT_SNAPSHOT WHERE EVENT_DATE = '2020-02-17') B 

ON A.USER_ID = B.USER_ID



