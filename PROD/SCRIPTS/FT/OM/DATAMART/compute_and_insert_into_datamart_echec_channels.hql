-- ***************************************
--*****************************************
--*****      CHANNEL DATAMART ECHEC   *****
--*****************************************
-- ***************************************
INSERT INTO MON.DATAMART_ECHEC_CHANNELS
SELECT
    C.ACTIF_ID,
    C.MSISDN,
    C.SERVICE_TYPE,
    C.STYLES,
    C.TECHNOLOGY,
    C.PRODUCT_LINE,
    C.PRODUCT,
    C.DETAILS_MARKETING,
    C.DETAILS_CONFOMITY,
    C.TRANSFER_STATUS,
    C.ERROR_CODE,
    C.ERROR_DESC,
    C.BEAC,
    C.VOL,
    C.VAL,
    C.REVENU,
    C.REVENU_INDIRECT,
    C.COMMISSION,
    D.SITE_NAME,
    C.JOUR
FROM
    (
-- CHANNEL ON SENDER MODE NOT C2C
    SELECT
        A.TRANSACTION_DATE JOUR,
        (A.SENDER_USER_ID || '_' || A.SENDER_MSISDN) ACTIF_ID,
        A.SENDER_MSISDN MSISDN,
        A.SERVICE_TYPE,
        B.STYLES,
        B.TECHNOLOGY,
        B.PRODUCT_LINE,
        B.PRODUCT,
        B.DETAILS_MARKETING,
        B.DETAILS_CONFOMITY,
        A.TRANSFER_STATUS,
        A.ERROR_CODE,
        A.ERROR_DESC,
        B.BEAC,
        COUNT(A.TRANSFER_ID) VOL,
        COUNT(DISTINCT CASE WHEN A.RECEIVER_CATEGORY_CODE='SUBS' THEN A.RECEIVER_MSISDN ELSE NULL END) ACTIF_CLIENT_JJ,
        SUM(A.TRANSACTION_AMOUNT) VAL,
        SUM(A.SERVICE_CHARGE_PAID) REVENU,
        SUM(A.COMMISSIONS_RECEIVED) REVENU_INDIRECT,
        SUM(A.COMMISSIONS_PAID) COMMISSION
    FROM CDR.IT_OM_TRANSACTIONS A JOIN MON.REF_OM_PRODUCTS B
    ON UPPER(A.SENDER_MSISDN)=UPPER(B.MSISDN) AND UPPER(A.SENDER_USER_ID)=UPPER(B.USER_ID)
    WHERE
        A.TRANSFER_STATUS='TF' AND
        A.TRANSACTION_DATE ='2019-11-19' AND
        A.SENDER_CATEGORY_CODE<>'SUBS' AND
        B.REF_DATE='2019-10-17' AND A.SERVICE_TYPE NOT IN ('P2P')
    GROUP BY A.TRANSACTION_DATE,
        (A.SENDER_USER_ID || '_' || A.SENDER_MSISDN),
        A.SENDER_MSISDN,
        A.SERVICE_TYPE,
        B.STYLES,
        B.TECHNOLOGY,
        B.PRODUCT_LINE,
        B.PRODUCT,
        B.DETAILS_MARKETING,
        B.DETAILS_CONFOMITY,
        A.TRANSFER_STATUS,
        A.ERROR_CODE,
        A.ERROR_DESC,
        B.BEAC
    UNION ALL
-- CHANNEL ON RECEIVER MODE NOT C2C
    SELECT
        A.TRANSACTION_DATE JOUR,
        (A.RECEIVER_USER_ID || '_' || A.RECEIVER_MSISDN) ID_ACTIF,
        A.RECEIVER_MSISDN MSISDN,
        A.SERVICE_TYPE,
        B.STYLES,
        B.TECHNOLOGY,
        B.PRODUCT_LINE,
        B.PRODUCT,
        B.DETAILS_MARKETING,
        B.DETAILS_CONFOMITY,
        A.TRANSFER_STATUS,
        A.ERROR_CODE,
        A.ERROR_DESC,
        B.BEAC,
        COUNT(A.TRANSFER_ID) VOL,
        COUNT(DISTINCT CASE WHEN A.SENDER_CATEGORY_CODE='SUBS' THEN A.SENDER_MSISDN ELSE NULL END) ACTIF_CLIENT_JJ,
        SUM(A.TRANSACTION_AMOUNT) VAL,
        SUM(A.SERVICE_CHARGE_PAID) REVENU,
        SUM(A.COMMISSIONS_RECEIVED) REVENU_INDIRECT,
        SUM(A.COMMISSIONS_PAID) COMMISSION
    FROM CDR.IT_OM_TRANSACTIONS A JOIN MON.REF_OM_PRODUCTS B
    ON UPPER(A.RECEIVER_MSISDN)=UPPER(B.MSISDN) AND UPPER(A.RECEIVER_USER_ID)=UPPER(B.USER_ID)
    WHERE
        A.TRANSFER_STATUS='TF' AND
        A.TRANSACTION_DATE ='2019-11-19' AND
        A.SENDER_CATEGORY_CODE='SUBS' AND
        B.REF_DATE='2019-10-17' AND A.SERVICE_TYPE NOT IN ('P2P')
    GROUP BY
        A.TRANSACTION_DATE,
        (A.RECEIVER_USER_ID || '_' || A.RECEIVER_MSISDN),
        A.RECEIVER_MSISDN,
        A.SERVICE_TYPE,
        B.STYLES,
        B.TECHNOLOGY,
        B.PRODUCT_LINE,
        B.PRODUCT,
        B.DETAILS_MARKETING,
        B.DETAILS_CONFOMITY,
        A.TRANSFER_STATUS,
        A.ERROR_CODE,
        A.ERROR_DESC,
        B.BEAC
-- CHANNEL ON SENDER MODE C2C
UNION ALL
    SELECT
        A.TRANSACTION_DATE JOUR,
        (A.SENDER_USER_ID || '_' || A.SENDER_MSISDN) ACTIF_ID,
        A.SENDER_MSISDN MSISDN,
        'C2C_SENDER' SERVICE_TYPE,
        'TRANSFERT' STYLES,
        B.TECHNOLOGY,
        B.PRODUCT_LINE,
        B.PRODUCT,
        B.DETAILS_MARKETING,
        B.DETAILS_CONFOMITY,
        A.TRANSFER_STATUS,
        A.ERROR_CODE,
        A.ERROR_DESC,
        B.BEAC,
        COUNT(A.TRANSFER_ID) VOL,
        COUNT(DISTINCT CASE WHEN A.RECEIVER_CATEGORY_CODE='SUBS' THEN A.RECEIVER_MSISDN ELSE NULL END) ACTIF_CLIENT_JJ,
        SUM(A.TRANSACTION_AMOUNT) VAL,
        SUM(A.SERVICE_CHARGE_PAID) REVENU,
        SUM(A.COMMISSIONS_RECEIVED) REVENU_INDIRECT,
        SUM(A.COMMISSIONS_PAID) COMMISSION
    FROM CDR.IT_OM_TRANSACTIONS A JOIN MON.REF_OM_PRODUCTS B
    ON UPPER(A.SENDER_MSISDN)=UPPER(B.MSISDN) AND UPPER(A.SENDER_USER_ID)=UPPER(B.USER_ID)
    WHERE
        A.TRANSFER_STATUS='TF' AND
        A.TRANSACTION_DATE ='2019-11-19' AND
        A.SENDER_CATEGORY_CODE<>'SUBS' AND A.RECEIVER_CATEGORY_CODE<>'SUBS' AND
        B.REF_DATE='2019-10-17' AND A.SERVICE_TYPE='P2P'
    GROUP BY A.TRANSACTION_DATE,
        (A.SENDER_USER_ID || '_' || A.SENDER_MSISDN),
        A.SENDER_MSISDN,
        B.TECHNOLOGY,
        B.PRODUCT_LINE,
        B.PRODUCT,
        B.DETAILS_MARKETING,
        B.DETAILS_CONFOMITY,
        A.TRANSFER_STATUS,
        A.ERROR_CODE,
        A.ERROR_DESC,
        B.BEAC
    UNION ALL
-- CHANNEL ON RECEIVER MODE C2C
    SELECT
        A.TRANSACTION_DATE JOUR,
        (A.RECEIVER_USER_ID || '_' || A.RECEIVER_MSISDN) ID_ACTIF,
        A.RECEIVER_MSISDN MSISDN,
        'C2C_RECEIVER' SERVICE_TYPE,
        'TRANSFERT' STYLES,
        B.TECHNOLOGY,
        B.PRODUCT_LINE,
        B.PRODUCT,
        B.DETAILS_MARKETING,
        B.DETAILS_CONFOMITY,
        A.TRANSFER_STATUS,
        A.ERROR_CODE,
        A.ERROR_DESC,
        B.BEAC,
        COUNT(A.TRANSFER_ID) VOL,
        COUNT(DISTINCT CASE WHEN A.SENDER_CATEGORY_CODE='SUBS' THEN A.SENDER_MSISDN ELSE NULL END) ACTIF_CLIENT_JJ,
        SUM(A.TRANSACTION_AMOUNT) VAL,
        SUM(A.SERVICE_CHARGE_PAID) REVENU,
        SUM(A.COMMISSIONS_RECEIVED) REVENU_INDIRECT,
        SUM(A.COMMISSIONS_PAID) COMMISSION
    FROM CDR.IT_OM_TRANSACTIONS A JOIN MON.REF_OM_PRODUCTS B
    ON UPPER(A.RECEIVER_MSISDN)=UPPER(B.MSISDN) AND UPPER(A.RECEIVER_USER_ID)=UPPER(B.USER_ID)
    WHERE
        A.TRANSFER_STATUS='TF' AND
        A.TRANSACTION_DATE ='2019-11-19' AND
        A.SENDER_CATEGORY_CODE<>'SUBS' AND A.RECEIVER_CATEGORY_CODE<>'SUBS' AND
        B.REF_DATE='2019-10-17' AND A.SERVICE_TYPE='P2P'
    GROUP BY
        A.TRANSACTION_DATE,
        (A.RECEIVER_USER_ID || '_' || A.RECEIVER_MSISDN),
        A.RECEIVER_MSISDN,
        B.TECHNOLOGY,
        B.PRODUCT_LINE,
        B.PRODUCT,
        B.DETAILS_MARKETING,
        B.DETAILS_CONFOMITY,
        A.TRANSFER_STATUS,
        A.ERROR_CODE,
        A.ERROR_DESC,
        B.BEAC) C
    LEFT JOIN MON.LOC_OM_H18  D
ON C.MSISDN=D.MSISDN