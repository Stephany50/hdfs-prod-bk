INSERT INTO MON.SPARK_FT_CONSO_SIMBOX
SELECT
a.MSISDN,
DATE_FORMAT(a.DETECT_DATE,'yyyy-MM')DETECT_MONTH,
b.event_month CONSO_MONTH,
b.CONSO CONSO,
b.TEL_DURATION TEL_DURATION,
b.BILLED_TEL_COUNT+b.BILLED_SMS_COUNT TEL_COUNT,
CURRENT_TIMESTAMP INSERTED_DATE,
UPPER(a.PLATFORM)PLATFORM,
b.FORMULE profile,
b.MTN_DURATION MTN_DURATION,
b.CAMTEL_DURATION CAMTEL_DURATION,
b.INTERNATIONAL_DURATION INTERNATIONAL_DURATION,
'###SLICE_VALUE###' EVENT_DATE
-- selection des numero ayant été detectés ce mois
FROM (SELECT msisdn, max(detect_date)detect_date,max(PLATFORM)PLATFORM, max(event_date)event_date FROM CDR.SPARK_IT_SIMBOXDETECTION
WHERE event_date = "###SLICE_VALUE###" group by msisdn ) a
INNER JOIN (SELECT * FROM MON.SPARK_FT_CONSO_MSISDN_MONTH) b
ON a.msisdn = b.msisdn
-- exclusion faite des sim déjà détectées au par-avant
WHERE b.event_month >=DATE_FORMAT('###SLICE_VALUE###','yyyy-MM')
order by PLATFORM