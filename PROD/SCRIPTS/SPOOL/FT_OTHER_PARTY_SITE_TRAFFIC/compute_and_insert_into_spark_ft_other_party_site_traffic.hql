INSERT INTO MON.SPARK_FT_OTHER_PARTY_SITE_TRAFFIC
SELECT
FN_NNP_REMOVE_RN(OTHER_PARTY) MSISDN,
FN_NNP_SIMPLE_DESTINATION (OTHER_PARTY) NETWORK,
SUBSTR(SERVED_PARTY_LOCATION, 14, 5) CI,
CURRENT_TIMESTAMP AS REFRESH_DATE
-- ajout par ALFRED TENE
, SUM (CASE    WHEN  TRANSACTION_DIRECTION = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  TRANSACTION_DURATION   ELSE  0    END ) DUREE_SORTANT
, SUM (CASE    WHEN  TRANSACTION_DIRECTION = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_SORTANT
, SUM (CASE    WHEN  TRANSACTION_DIRECTION = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  TRANSACTION_DURATION   ELSE  0    END ) DUREE_ENTRANT
, SUM (CASE    WHEN  TRANSACTION_DIRECTION = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) <> 'SMS' THEN  1   ELSE  0    END ) NBRE_TEL_ENTRANT
, SUM (CASE    WHEN  TRANSACTION_DIRECTION = 'Entrant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_SORTANT
, SUM (CASE    WHEN  TRANSACTION_DIRECTION = 'Sortant' AND SUBSTR (TRANSACTION_TYPE, 1, 3) = 'SMS' THEN  1   ELSE  0    END ) NBRE_SMS_ENTRANT
,TRANSACTION_DATE EVENT_DATE
FROM MON.SPARK_FT_MSC_TRANSACTION
WHERE transaction_date = '###SLICE_VALUE###'
AND FN_NNP_SIMPLE_DESTINATION (OTHER_PARTY) IN ('MTN', 'VIETTEL', 'CAMTEL')
GROUP BY TRANSACTION_DATE,
FN_NNP_REMOVE_RN(OTHER_PARTY),
FN_NNP_SIMPLE_DESTINATION (OTHER_PARTY),
SUBSTR(SERVED_PARTY_LOCATION, 14, 5)