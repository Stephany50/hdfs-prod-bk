INSERT INTO TMP.TT_STK_HIERACHY
SELECT
    A.PRIMARY_MSISDN  MSISDN,
    A.CAT_CODE CATEGORY_CODE,
    A.CATEGORY_NAME,
    A.GEOGRAPHICAL_DOMAIN_CODE,
    A.GEOGRAPHICAL_DOMAIN_NAME,
    A.CHANNEL_USER_NAME,
    B.PRIMARY_MSISDN PARENT,
    C.PRIMARY_MSISDN GRDPARENT,
    A.TRANSACTION_DATE  ACTIV_BEGIN_DATE
FROM
(
    SELECT
        PRIMARY_MSISDN,
        MAX(CHANNEL_USER_ID) CHANNEL_USER_ID,
        MAX(PARENT_USER_ID) PARENT_USER_ID,
        MAX(OWNER_USER_ID) OWNER_USER_ID,
        MAX(CHANNEL_USER_NAME) CHANNEL_USER_NAME,
        MAX(CATEGORY_CODE) CAT_CODE,
        MAX(CATEGORY_NAME) CATEGORY_NAME,
        MAX(GEOGRAPHICAL_DOMAIN_CODE) GEOGRAPHICAL_DOMAIN_CODE,
        MAX(GEOGRAPHICAL_DOMAIN_NAME) GEOGRAPHICAL_DOMAIN_NAME,
        MAX(TRANSACTION_DATE) TRANSACTION_DATE
    FROM CDR.SPARK_IT_ZEBRA_MASTER
    WHERE TRANSACTION_DATE = '###SLICE_VALUE###'
        AND USER_STATUS = 'Active'
    GROUP BY PRIMARY_MSISDN
) A
LEFT JOIN
(
    SELECT
        PRIMARY_MSISDN,
        MAX(CHANNEL_USER_ID) CHANNEL_USER_ID,
        MAX(PARENT_USER_ID) PARENT_USER_ID,
        MAX(OWNER_USER_ID) OWNER_USER_ID,
        MAX(CHANNEL_USER_NAME) CHANNEL_USER_NAME,
        MAX(GEOGRAPHICAL_DOMAIN_CODE) GEOGRAPHICAL_DOMAIN_CODE,
        MAX(GEOGRAPHICAL_DOMAIN_NAME) GEOGRAPHICAL_DOMAIN_NAME
    FROM CDR.SPARK_IT_ZEBRA_MASTER
    WHERE TRANSACTION_DATE = '###SLICE_VALUE###'
        AND USER_STATUS = 'Active'
    GROUP BY PRIMARY_MSISDN
) B
ON A.PARENT_USER_ID = B.CHANNEL_USER_ID
LEFT JOIN
(
    SELECT
        PRIMARY_MSISDN,
        MAX(CHANNEL_USER_ID) CHANNEL_USER_ID,
        MAX(PARENT_USER_ID) PARENT_USER_ID,
        MAX(OWNER_USER_ID) OWNER_USER_ID,
        MAX(CHANNEL_USER_NAME) CHANNEL_USER_NAME,
        MAX(GEOGRAPHICAL_DOMAIN_CODE) GEOGRAPHICAL_DOMAIN_CODE,
        MAX(GEOGRAPHICAL_DOMAIN_NAME) GEOGRAPHICAL_DOMAIN_NAME
    FROM CDR.SPARK_IT_ZEBRA_MASTER
    WHERE TRANSACTION_DATE = '###SLICE_VALUE###'
        AND USER_STATUS = 'Active'
    GROUP BY PRIMARY_MSISDN
) C
ON A.OWNER_USER_ID = C.CHANNEL_USER_ID