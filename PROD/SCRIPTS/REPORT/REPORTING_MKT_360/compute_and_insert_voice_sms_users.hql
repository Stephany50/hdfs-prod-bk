INSERT INTO MON.SPARK_FT_VOICE_NB_SMS
SELECT
    A.MSISDN,
    SUM(CASE WHEN TRANSACTION_DATE='###SLICE_VALUE###' THEN NB_VOICE ELSE 0 END ) NB_VOICE_DAILY,
    SUM(CASE WHEN TRANSACTION_DATE BETWEEN DATE_SUB('###SLICE_VALUE###',6) AND '###SLICE_VALUE###' THEN NB_VOICE ELSE 0 END ) NB_VOICE_7_DAYS ,
    SUM(CASE WHEN TRANSACTION_DATE BETWEEN SUBSTRING('###SLICE_VALUE###', 1, 7)||'-01' AND '###SLICE_VALUE###' THEN NB_VOICE ELSE 0 END ) NB_VOICE_MTD ,
    SUM(NB_VOICE) NB_VOICE_30_DAYS,
    SUM(CASE WHEN TRANSACTION_DATE='###SLICE_VALUE###' THEN NB_SMS ELSE 0 END ) NB_SMS_DAILY ,
    SUM(CASE WHEN TRANSACTION_DATE BETWEEN DATE_SUB('###SLICE_VALUE###',6) AND '###SLICE_VALUE###' THEN NB_SMS ELSE 0 END ) NB_SMS_7_DAYS ,
    SUM(CASE WHEN TRANSACTION_DATE BETWEEN SUBSTRING('###SLICE_VALUE###', 1, 7)||'-01' AND '###SLICE_VALUE###' THEN NB_SMS ELSE 0 END ) NB_SMS_MTD ,
    SUM(NB_SMS ) NB_SMS_30_DAYS,
    SUM(CASE WHEN TRANSACTION_DATE='###SLICE_VALUE###' THEN TRAFFIC_VOICE ELSE 0 END ) TRAFFIC_VOICE_DAILY ,
    SUM(CASE WHEN TRANSACTION_DATE BETWEEN DATE_SUB('###SLICE_VALUE###',6) AND '###SLICE_VALUE###' THEN TRAFFIC_VOICE ELSE 0 END ) TRAFFIC_VOICE_7_DAYS ,
    SUM(CASE WHEN TRANSACTION_DATE BETWEEN SUBSTRING('###SLICE_VALUE###', 1, 7)||'-01' AND '###SLICE_VALUE###' THEN TRAFFIC_VOICE ELSE 0 END )  TRAFFIC_VOICE_MTD,
    SUM(TRAFFIC_VOICE) TRAFFIC_VOICE_30_DAYS,
    CURRENT_TIMESTAMP INSERT_DATE,
    '###SLICE_VALUE###' TRANSACTION_DATE
FROM (
    SELECT 
        TRANSACTION_DATE TRANSACTION_DATE,
        CHARGED_PARTY MSISDN,
        SUM(CASE
                WHEN  
                    UPPER(SERVICE_CODE) IN ('TEL','OC','OCFWD','OCRMG','TCRMG') 
                    OR UPPER(SERVICE_CODE) LIKE '%FNF%MODIFICATION%'
                    OR UPPER(SERVICE_CODE) LIKE '%ACCOUNT%INTERRO%' THEN 1 
            ELSE 0 END) NB_VOICE,
        SUM(CASE 
                WHEN
                    UPPER(SERVICE_CODE) IN ('TEL','OC','OCFWD','OCRMG','TCRMG') 
                    OR UPPER(SERVICE_CODE) LIKE '%FNF%MODIFICATION%'
                    OR UPPER(SERVICE_CODE) LIKE '%ACCOUNT%INTERRO%' THEN CALL_PROCESS_TOTAL_DURATION
            ELSE 0 END) TRAFFIC_VOICE,
        SUM(CASE 
                WHEN
                    UPPER(SERVICE_CODE) IN ('SMS' ,'SMSMO','SMSRMG') THEN 1
            ELSE 0 END) NB_SMS
    FROM MON.SPARK_FT_BILLED_TRANSACTION_PREPAID
    WHERE TRANSACTION_DATE BETWEEN DATE_SUB('###SLICE_VALUE###',29)  AND '###SLICE_VALUE###'
        AND MAIN_RATED_AMOUNT >= 0
        AND PROMO_RATED_AMOUNT >= 0
    GROUP BY 
        CHARGED_PARTY, 
        TRANSACTION_DATE
) A
GROUP BY MSISDN