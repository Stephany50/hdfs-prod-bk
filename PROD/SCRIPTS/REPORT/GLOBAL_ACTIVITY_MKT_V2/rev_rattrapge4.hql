INSERT INTO AGG.SPARK_FT_GLOBAL_ACTIVITY_DAILY_MKT_DG
SELECT
    'UNIQUE_DATA_USERS' DESTINATION_CODE,
    COMMERCIAL_OFFER PROFILE_CODE,
    'UNIQUE_DATA_USERS' SERVICE_CODE,
    'UNIQUE_DATA_USERS' KPI,
    'UNKNOWN' SUB_ACCOUNT,
    'UNKNOWN' MEASUREMENT_UNIT,
     OPERATOR_CODE,
    SUM(rated_count) TOTAL_AMOUNT,
    SUM(rated_count) RATED_AMOUNT,
    CURRENT_TIMESTAMP INSERT_DATE,
    REGION_ID,
    EVENT_DATE TRANSACTION_DATE,
    'COMPUTE_KPI_UNIQUE_USER' JOB_NAME,
    'FT_USERS_DATA_DAY' SOURCE_TABLE
FROM MON.SPARK_FT_USERS_DATA_DAY b
LEFT JOIN (select max(region) region,ci from dim.dt_gsm_cell_code group by CI) c on b.location_ci = c.ci
LEFT JOIN DIM.DT_REGIONS_MKT r ON TRIM(COALESCE(upper(c.region), 'INCONNU')) = upper(r.ADMINISTRATIVE_REGION)
WHERE EVENT_DATE <'2020-07-01'

GROUP BY EVENT_DATE, COMMERCIAL_OFFER, OPERATOR_CODE,region_id

UNION ALL
-- Insertion des Users uniques  DATA
SELECT
    'UNIQUE_DATA_USERS_30Jrs' DESTINATION_CODE,
    COMMERCIAL_OFFER PROFILE_CODE,
    'UNIQUE_DATA_USERS_30Jrs' SERVICE_CODE,
    'UNIQUE_DATA_USERS_30Jrs' KPI,
    'UNKNOWN' SUB_ACCOUNT,
    'UNKNOWN' MEASUREMENT_UNIT,
     OPERATOR_CODE,
    SUM(rated_count_30_days) TOTAL_AMOUNT,
    SUM(rated_count_30_days) RATED_AMOUNT,
    CURRENT_TIMESTAMP INSERT_DATE,
    REGION_ID,
    EVENT_DATE TRANSACTION_DATE,
    'COMPUTE_KPI_UNIQUE_USER' JOB_NAME,
    'FT_USERS_DATA_DAY' SOURCE_TABLE
FROM MON.SPARK_FT_USERS_DATA_DAY b
LEFT JOIN (select max(region) region,ci from dim.dt_gsm_cell_code group by CI) c on b.location_ci = c.ci
LEFT JOIN DIM.DT_REGIONS_MKT r ON TRIM(COALESCE(upper(c.region), 'INCONNU')) = upper(r.ADMINISTRATIVE_REGION)
WHERE EVENT_DATE <'2020-07-01'

GROUP BY EVENT_DATE, COMMERCIAL_OFFER, OPERATOR_CODE,region_id


UNION ALL
-- Insertion des Users uniques  DATA
SELECT
    'UNIQUE_DATA_USERS_1Mo_30Jrs' DESTINATION_CODE,
    COMMERCIAL_OFFER PROFILE_CODE,
    'UNIQUE_DATA_USERS_1Mo_30Jrs' SERVICE_CODE,
    'UNIQUE_DATA_USERS_1Mo_30Jrs' KPI,
    'UNKNOWN' SUB_ACCOUNT,
    'UNKNOWN' MEASUREMENT_UNIT,
     OPERATOR_CODE,
    SUM(rated_count_30_days_1mo) TOTAL_AMOUNT,
    SUM(rated_count_30_days_1mo) RATED_AMOUNT,
    CURRENT_TIMESTAMP INSERT_DATE,
    REGION_ID,
    EVENT_DATE TRANSACTION_DATE,
    'COMPUTE_KPI_UNIQUE_USER' JOB_NAME,
    'FT_USERS_DATA_DAY' SOURCE_TABLE
FROM MON.SPARK_FT_USERS_DATA_DAY b
LEFT JOIN (select max(region) region,ci from dim.dt_gsm_cell_code group by CI) c on b.location_ci = c.ci
LEFT JOIN DIM.DT_REGIONS_MKT r ON TRIM(COALESCE(upper(c.region), 'INCONNU')) = upper(r.ADMINISTRATIVE_REGION)
WHERE EVENT_DATE <'2020-07-01'

GROUP BY EVENT_DATE, COMMERCIAL_OFFER, OPERATOR_CODE,region_id