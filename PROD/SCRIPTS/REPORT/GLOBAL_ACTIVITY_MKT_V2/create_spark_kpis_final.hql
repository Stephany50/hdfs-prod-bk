create table AGG.SPARK_KPIS_DG_FINAL (
    region_administrative  VARCHAR(100),
    region_commerciale  VARCHAR(100),
    category  VARCHAR(100),
    kpi  VARCHAR(100),
    axe_vue_transversale VARCHAR(100),
    axe_revenu VARCHAR(100),
    axe_subscriber VARCHAR(100),
    SOURCE_TABLE VARCHAR(100),
    valeur DOUBLE,
    valeur_lweek DOUBLE,
    valeur_2wa DOUBLE,
    valeur_3wa DOUBLE,
    valeur_4wa DOUBLE,
    valeur_mtd DOUBLE,
    valeur_lmtd DOUBLE,
    valeur_budget DOUBLE,
    valeur_budget_mtd DOUBLE,
    valeur_mtd_last_year DOUBLE,
    valeur_vs_lweek DOUBLE,
    valeur_vs_2wa DOUBLE,
    valeur_vs_3wa DOUBLE,
    valeur_vs_4wa DOUBLE,
    valeur_mtd_vs_lmdt DOUBLE,
    valeur_mtd_vs_budget DOUBLE,
    valeur_vs_budget DOUBLE,
    valeur_mtd_vs_last_year DOUBLE,
    insert_date TIMESTAMP
)PARTITIONED BY (    processing_date DATE)
STORED AS PARQUET
TBLPROPERTIES ('PARQUET.COMPRESS'='SNAPPY')

create table AGG.SPARK_KPIS_DG_FINAL (
region_administrative VARCHAR(100) ,
region_commerciale VARCHAR(100) ,
category VARCHAR(100) ,
KPI VARCHAR(100) ,
axe_vue_transversale VARCHAR(100),
axe_revenu VARCHAR(100),
axe_subscriber VARCHAR(100),
source_table VARCHAR(100) ,
valeur DOUBLE ,
valeur_day DOUBLE ,
lweek DOUBLE ,
v2wa DOUBLE ,
v3wa DOUBLE ,
v4wa DOUBLE ,
mtd DOUBLE ,
lmtd DOUBLE ,
budget DOUBLE ,
budget_lweek DOUBLE ,
budget_2wa DOUBLE ,
budget_3wa DOUBLE ,
budget_4wa DOUBLE ,
budget_mtd DOUBLE ,
mtd_last_year DOUBLE ,
vslweek DOUBLE ,
vs2wa DOUBLE ,
vs3wa DOUBLE ,
vs4wa DOUBLE ,
mtdvslmdt DOUBLE ,
mdtvsbudget DOUBLE ,
weekvsbudget DOUBLE ,
lweekvsblweek DOUBLE ,
v2wavsb2wa DOUBLE ,
v3wavsb3wa DOUBLE ,
v4wavsb4wa DOUBLE ,
mtd_vs_last_year DOUBLE ,
granularite_reg VARCHAR(50),
insert_date TIMESTAMP
)PARTITIONED BY (    processing_date DATE)
STORED AS PARQUET
TBLPROPERTIES ('PARQUET.COMPRESS'='SNAPPY')

INSERT INTO AGG.SPARK_KPIS_DG_FINAL
SELECT
REGION_ADMINISTRATIVE,
REGION_COMMERCIALE,
CATEGORY,
KPI,
AXE_VUE_TRANSVERSALE,
AXE_REVENU,
AXE_SUBSCRIBER,
SOURCE_TABLE,
VALEUR,
VALEUR_DAY,
LWEEK,
V2WA,
V3WA,
V4WA,
MTD,
LMTD,
BUDGET,
BUDGET_LWEEK,
BUDGET_2WA,
BUDGET_3WA,
BUDGET_4WA,
BUDGET_MTD,
MTD_LAST_YEAR,
VSLWEEK,
VS2WA,
VS3WA,
VS4WA,
MTDVSLMDT,
MDTVSBUDGET,
WEEKVSBUDGET,
LWEEKVSBLWEEK,
V2WAVSB2WA,
V3WAVSB3WA,
V4WAVSB4WA,
MTD_VS_LAST_YEAR,
'ADMINISTRATIVE_REGION' GRANULARITE_REG,
INSERT_DATE,
PROCESSING_DATE
FROM AGG.SPARK_KPIS_DG_FINAL5

create table TMP.SPARK_SQ_KPIS_REG_FINAL AS
SELECT
REGION_ADMINISTRATIVE,
REGION_COMMERCIALE,
CATEGORY,
KPI,
AXE_VUE_TRANSVERSALE,
AXE_REVENU,
AXE_SUBSCRIBER,
SOURCE_TABLE,
VALEUR,
VALEUR VALEUR_DAY,
VALEUR_LWEEK,
V2WA,
V3WA,
V4WA,
VALEUR_MTD,
VALEUR_LMTD,
BUDGET,
BUDGET_LWEEK,
BUDGET_2WA,
BUDGET_3WA,
BUDGET_4WA,
VALEUR_BUDGET_MTD,
VALEUR_MTD_LAST_YEAR,
VSLWEEK,
VS2WA,
VS3WA,
VS4WA,
MTDVSLMDT,
MDTVSBUDGET,
WEEKVSBUDGET,
LWEEKVSBLWEEK,
V2WAVSB2WA,
V3WAVSB3WA,
V4WAVSB4WA,
MTD_VS_LAST_YEAR,
AXE_VUE_TRANSVERSALE GRANULARITE_REG,
INSERT_DATE,
PROCESSING_DATE
FROM mon.SPARK_KPIS_REG_FINAL5 WHERE 1=0;
