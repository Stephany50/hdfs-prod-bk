//-- ---********************************************************---
//---------EXPORT SPARK_FT_CONSO_MSISDN_MONTH -------------------
//-------- ALEX BILLANG 01-06-2020
//------- export data to Datawarehouse
//---***********************************************************---


flux.yarn.queue = "compute"
flux.log-level = "ERROR"

flux.name = "SQ_EXPORT_SPARK_FT_CONSO_MSISDN_MONTH"

flux.type = "EXPORT"

flux.has-date-processing = true

flux.slice-value-type = "MONTHLY"
flux.slice-begin-value = -3
flux.slice-end-value = -1
flux.slice-step-value = 1
flux.slice-begin-value-offset = 0
flux.slice-end-value-offset = 0
flux.slice-date-format = "yyyy-MM"

flux.rdms.has-pre-queries = true

flux.hive.has-pre-queries = true

flux.rdms.pre-exec-queries += """
SELECT (CASE WHEN NBR = 0 THEN 'OK' ELSE 'NOK' END) RESULT FROM
(SELECT COUNT(*) NBR FROM MON.FT_CONSO_MSISDN_MONTH WHERE EVENT_MONTH= REGEXP_REPLACE('###SLICE_VALUE###', '-', '')))
"""
flux.hive.pre-exec-queries += """
SELECT IF(A.NBR > 1, 'OK', 'NOK') FROM
(SELECT COUNT(*) NBR FROM MON.SPARK_FT_CONSO_MSISDN_MONTH WHERE EVENT_MONTH='###SLICE_VALUE###') A
"""

flux.sqoop.jdbc-connect-uri = "jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL = TCP)(HOST = 172.21.75.133)(PORT = 20303)))(CONNECT_DATA=(SERVICE_NAME = OCMDWH)))"
flux.sqoop.jdbc-username = "mon"
flux.sqoop.jdbc-password = "Mon123ocm#"
flux.sqoop.jdbc-driver = "oracle.jdbc.driver.OracleDriver"

flux.sqoop.query = "SELECT
 CONCAT_WS('', SUBSTRING(EVENT_MONTH, 1, 4), SUBSTRING(EVENT_MONTH, 6, 2))	EVENT_MONTH,
 MSISDN	,
 FORMULE	,
 CONSO	,
 SMS_COUNT	,
 TEL_COUNT	,
 TEL_DURATION	,
 BILLED_SMS_COUNT	,
 BILLED_TEL_COUNT	,
 BILLED_TEL_DURATION	,
 CONSO_SMS	,
 CONSO_TEL	,
 PROMOTIONAL_CALL_COST	,
 MAIN_CALL_COST	,
 SRC_TABLE	,
 OTHERS_VAS_TOTAL_COUNT	,
 OTHERS_VAS_DURATION	,
 OTHERS_VAS_MAIN_COST	,
 OTHERS_VAS_PROMO_COST	,
 NATIONAL_TOTAL_COUNT	,
 NATIONAL_SMS_COUNT	,
 NATIONAL_DURATION	,
 NATIONAL_MAIN_COST	,
 NATIONAL_PROMO_COST	,
 NATIONAL_SMS_MAIN_COST	,
 NATIONAL_SMS_PROMO_COST	,
 MTN_TOTAL_COUNT	,
 MTN_SMS_COUNT	,
 MTN_DURATION	,
 MTN_TOTAL_CONSO	,
 MTN_SMS_CONSO	,
 CAMTEL_TOTAL_COUNT	,
 CAMTEL_SMS_COUNT	,
 CAMTEL_DURATION	,
 CAMTEL_TOTAL_CONSO	,
 CAMTEL_SMS_CONSO	,
 INTERNATIONAL_TOTAL_COUNT	,
 INTERNATIONAL_SMS_COUNT	,
 INTERNATIONAL_DURATION	,
 INTERNATIONAL_TOTAL_CONSO	,
 INTERNATIONAL_SMS_CONSO	,
 ONNET_SMS_COUNT	,
 ONNET_DURATION	,
 ONNET_TOTAL_CONSO	,
 ONNET_MAIN_CONSO	,
 ONNET_MAIN_TEL_CONSO	,
 ONNET_PROMO_TEL_CONSO	,
 ONNET_SMS_CONSO	,
 MTN_MAIN_CONSO	,
 CAMTEL_MAIN_CONSO	,
 SET_TOTAL_COUNT	,
 SET_SMS_COUNT	,
 SET_DURATION	,
 SET_TOTAL_CONSO	,
 SET_SMS_CONSO	,
 SET_MAIN_CONSO	,
 INTERNATIONAL_MAIN_CONSO	,
 ROAM_TOTAL_COUNT	,
 ROAM_SMS_COUNT	,
 ROAM_DURATION	,
 ROAM_TOTAL_CONSO	,
 ROAM_MAIN_CONSO	,
 ROAM_SMS_CONSO	,
 INROAM_TOTAL_COUNT	,
 INROAM_SMS_COUNT	,
 INROAM_DURATION	,
 INROAM_TOTAL_CONSO	,
 INROAM_MAIN_CONSO	,
 INROAM_SMS_CONSO	,
 OPERATOR_CODE	,
 NEXTTEL_TOTAL_COUNT	,
 NEXTTEL_SMS_COUNT	,
 NEXTTEL_DURATION	,
 NEXTTEL_TOTAL_CONSO	,
 NEXTTEL_SMS_CONSO	,
 NEXTTEL_MAIN_CONSO	,
 BUNDLE_SMS_COUNT	,
 BUNDLE_TEL_DURATION	,
 SET_MAIN_TEL_CONSO	,
 MTN_MAIN_TEL_CONSO	,
 NEXTTEL_MAIN_TEL_CONSO	,
 CAMTEL_MAIN_TEL_CONSO	,
 INTERNATIONAL_MAIN_TEL_CONSO	,
 SET_PROMO_TEL_CONSO	,
 MTN_PROMO_TEL_CONSO	,
 NEXTTEL_PROMO_TEL_CONSO	,
 CAMTEL_PROMO_TEL_CONSO	,
 INTERNATIONAL_PROMO_TEL_CONSO	,
 ACTIVE_DAYS_COUNT	,
 FIRST_ACTIVE_DAY	,
 LAST_ACTIVE_DAY	,
 ROAM_MAIN_TEL_CONSO	,
 INROAM_MAIN_TEL_CONSO	,
 ROAM_PROMO_TEL_CONSO	,
 INROAM_PROMO_TEL_CONSO	,
 ONNET_BILLED_TEL_DURATION	,
 SET_BILLED_TEL_DURATION	,
 MTN_BILLED_TEL_DURATION	,
 NEXTTEL_BILLED_TEL_DURATION	,
 CAMTEL_BILLED_TEL_DURATION	,
 INTERNATIONAL_BIL_TEL_DURATION	,
 ROAM_BILLED_TEL_DURATION	,
 INROAM_BILLED_TEL_DURATION	,
 ONNET_BILLED_TEL_COUNT	,
 SET_BILLED_TEL_COUNT	,
 MTN_BILLED_TEL_COUNT	,
 NEXTTEL_BILLED_TEL_COUNT	,
 CAMTEL_BILLED_TEL_COUNT	,
 INTERNATIONAL_BILLED_TEL_COUNT	,
 ROAM_BILLED_TEL_COUNT	,
 INROAM_BILLED_TEL_COUNT	,
 ONNET_TEL_COUNT	,
 SET_TEL_COUNT	,
 MTN_TEL_COUNT	,
 NEXTTEL_TEL_COUNT	,
 CAMTEL_TEL_COUNT	,
 INTERNATIONAL_TEL_COUNT	,
 ROAM_TEL_COUNT	,
 INROAM_TEL_COUNT	,
 CONSO_TEL_MAIN	,
 SVA_COUNT	,
 SVA_DURATION	,
 SVA_MAIN_CONSO	,
 SVA_PROMO_CONSO	,
 SVA_TEL_COUNT	,
 SVA_BILLED_DURATION	,
 SVA_BILLED_TEL_CONSO	,
 SVA_SMS_COUNT	,
 SVA_SMS_CONSO
FROM MON.SPARK_FT_CONSO_MSISDN_MONTH WHERE EVENT_MONTH='###SLICE_VALUE###'"

flux.sqoop.export-rdms.staging-table = "MON.SQ_FT_CONSO_MSISDN_MONTH "
flux.sqoop.export-rdms.dest-table = "MON.FT_CONSO_MSISDN_MONTH"
flux.sqoop.export-hive.staging-table = "SQ_TMP_FT_CONSO_MSISDN_MONTH"
flux.sqoop.export-hive.staging-table-database = "TMP"
flux.sqoop.extra-params +="-Dmapreduce.map.java.opts='-Duser.timezone=UTC'"
flux.sqoop.extra-params +="-jt local"

