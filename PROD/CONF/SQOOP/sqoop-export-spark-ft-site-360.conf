flux.yarn.queue = "compute"
flux.log-level = "ERROR"

flux.name = "SQ_EXPORT_SPARK_FT_SITE_360"

flux.type = "EXPORT"

flux.has-date-processing = true

flux.slice-value-type = "DAILY"
flux.slice-begin-value = -3
flux.slice-end-value = -1
flux.slice-step-value = 1
flux.slice-begin-value-offset = 0
flux.slice-end-value-offset = 0
flux.slice-date-format = "yyyy-MM-dd"

flux.rdms.has-pre-queries = true

flux.hive.has-pre-queries = true

flux.rdms.pre-exec-queries += """
SELECT (CASE WHEN NBR = 0 THEN 'OK' ELSE 'NOK' END) RESULT FROM
(SELECT COUNT(*) NBR FROM MON.FT_SITE_360 WHERE event_date BETWEEN TO_DATE('###SLICE_VALUE### 000000', 'YYYY-MM-DD HH24MISS') AND TO_DATE('###SLICE_VALUE### 235959', 'YYYY-MM-DD HH24MISS'))
"""
flux.hive.pre-exec-queries += """
SELECT IF(A.NBR > 1, 'OK', 'NOK') FROM
(SELECT COUNT(*) NBR FROM MON.SPARK_FT_SITE_360 WHERE event_date='###SLICE_VALUE###') A
"""

flux.sqoop.jdbc-connect-uri = "jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL = TCP)(HOST = 172.21.75.133)(PORT = 20303)))(CONNECT_DATA=(SERVICE_NAME = OCMDWH)))"
flux.sqoop.jdbc-username = "mon"
flux.sqoop.jdbc-password = "Mon123ocm#"
flux.sqoop.jdbc-driver = "oracle.jdbc.driver.OracleDriver"

flux.sqoop.query = """
SELECT
    EVENT_DATE,
    LOC_SITE_NAME,
    LOC_TOWN_NAME,
    LOC_ADMINISTRATIVE_REGION,
    LOC_COMMERCIAL_REGION,
    LOC_ZONE_PMO,
    LOC_QUARTIER,
    LOC_ARRONDISSEMENT,
    LOC_DEPARTEMENT,
    LOC_SECTOR,
    PARC_GROUPE,
    PARC_ART,
    PARC_ACTIF_PERIOD,
    PARC_OM,
    DATA_USERS,
    VOICE_USERS,
    GROSS_ADD,
    NBRE_CALL_BOX,
    RUPTURE_STOCK,
    NBRE_FAMOCO,
    SMARTPHONES_3G,
    SMARTPHONES_4G,
    TOTAL_REVENUE,
    TOTAL_VOICE_REVENUE,
    TOTAL_SMS_REVENUE,
    TOTAL_SUBS_REVENUE,
    ROAM_IN_VOICE_REVENUE,
    ROAM_OUT_VOICE_REVENUE,
    ROAM_IN_SMS_REVENUE,
    ROAM_OUT_SMS_REVENUE,
    ROAM_DATA_REVENUE,
    MAIN_RATED_TEL_AMOUNT,
    MAIN_RATED_TEL_OCM_AMOUNT,
    MAIN_RATED_TEL_MTN_AMOUNT,
    MAIN_RATED_TEL_NEXTTEL_AMOUNT,
    MAIN_RATED_TEL_CAMTEL_AMOUNT,
    MAIN_RATED_TEL_SET_AMOUNT,
    MAIN_RATED_TEL_ROAM_IN_AMOUNT,
    MAIN_RATED_TEL_ROAM_OUT_AMOUNT,
    MAIN_RATED_TEL_SVA_AMOUNT,
    MAIN_RATED_TEL_INT_AMOUNT,
    MAIN_RATED_SMS_AMOUNT,
    DATA_MAIN_RATED_AMOUNT,
    DATA_GOS_MAIN_RATED_AMOUNT,
    DATA_ROAM_MAIN_RATED_AMOUNT,
    DATA_VIA_OM,
    AMOUNT_EMERGENCY_DATA,
    REVENU_OM,
    C2S_REFILL_COUNT,
    C2S_MAIN_REFILL_AMOUNT,
    C2S_PROMO_REFILL_AMOUNT,
    P2P_REFILL_COUNT,
    P2P_REFILL_AMOUNT,
    SCRATCH_REFILL_COUNT,
    SCRATCH_MAIN_REFILL_AMOUNT,
    SCRATCH_PROMO_REFILL_AMOUNT,
    P2P_REFILL_FEES,
    DATA_REFILL_FEES,
    OM_REFILL_COUNT,
    OM_REFILL_AMOUNT,
    OG_RATED_CALL_DURATION,
    OG_TOTAL_CALL_DURATION,
    RATED_TEL_OCM_DURATION,
    RATED_TEL_MTN_DURATION,
    RATED_TEL_NEXTTEL_DURATION,
    RATED_TEL_CAMTEL_DURATION,
    RATED_TEL_SET_DURATION,
    RATED_TEL_ROAM_IN_DURATION,
    RATED_TEL_ROAM_OUT_DURATION,
    RATED_TEL_SVA_DURATION,
    RATED_TEL_INT_DURATION,
    OG_SMS_TOTAL_COUNT,
    OG_SMS_OCM_COUNT,
    OG_SMS_MTN_COUNT,
    OG_SMS_NEXTTEL_COUNT,
    OG_SMS_CAMTEL_COUNT,
    OG_SMS_SET_COUNT,
    OG_SMS_ROAM_IN_COUNT,
    OG_SMS_ROAM_OUT_COUNT,
    OG_SMS_SVA_COUNT,
    OG_SMS_INTERNATIONAL_COUNT,
    DATA_BYTES_RECEIVED AS BYTES_RECEIVED,
    DATA_BYTES_SENT AS BYTES_SENT,
    DATA_BYTES_USED_IN_BUNDLE_ROAM AS BYTES_USED_IN_BUNDLE_ROAM,
    DATA_BYTES_USED_PAYGO_ROAM AS BYTES_USED_PAYGO_ROAM,
    DATA_BYTES_USED_OUT_BUNDLE_ROAM AS BYTES_USED_OUT_BUNDLE_ROAM,
    DATA_BYTES_USED_IN_BUNDLE AS BYTES_USED_IN_BUNDLE,
    DATA_PROMO_RATED_AMOUNT AS PROMO_RATED_AMOUNT,
    DATA_ROAM_PROMO_RATED_AMOUNT AS ROAM_PROMO_RATED_AMOUNT,
    INSERT_DATE,
    CATEGORY_SITE,
    REVENU_SUBS_VOIX,
    REVENU_SUBS_DATA,
    REVENU_SUBS_SMS,
    PDM_OCM,
    PDM_MTN,
    PDM_CAMTEL,
    PDM_NEXTTEL,
    PDM_NATIONAL,
    PARC_ACTIF_OM
FROM MON.SPARK_FT_SITE_360
WHERE EVENT_DATE='###SLICE_VALUE###'
"""

flux.sqoop.export-rdms.staging-table = "MON.SQ_FT_SITE_360"
flux.sqoop.export-rdms.dest-table = "MON.FT_SITE_360"
flux.sqoop.export-hive.staging-table = "FT_TMP_SITE_360"
flux.sqoop.export-hive.staging-table-database = "TMP"

flux.sqoop.extra-params +="-Dmapreduce.map.java.opts='-Duser.timezone=UTC'"
flux.sqoop.extra-params +="-jt local"